<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lokal</title>

<!-- libs -->
<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

<!-- your styles -->
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="cart.css">
<link rel="stylesheet" href="wishlist.css">
<script src="wishlist.js" defer></script>

<!-- ===== GitHub Pages base (adjust if not using GH Pages) ===== -->
<meta name="site-base" content="/Lokal/">

<!-- ===== Image / asset resolver (works local + GH Pages) ===== -->
<script>
  (function(){
    const SITE_BASE = (document.querySelector('meta[name="site-base"]')?.content || "/").replace(/\/+$/, "/");
    const ORIGIN_BASE = location.origin + SITE_BASE;
    window.resolveAsset = function resolveAsset(p){
      if (!p) return "";
      if (/^https?:\/\//i.test(p)) return p;
      const cleaned = String(p).replace(/^\/+/, "");
      const hit = cleaned.match(/(?:^|\/)(images\/.+)$/i);
      const tail = hit ? hit[1] : cleaned;
      try { return new URL(tail, ORIGIN_BASE).href; } catch { return p; }
    };
    // A tiny helper to build safe relative links that work on GH Pages subpaths:
    window.siteHref = function siteHref(rel){
      rel = String(rel || "").replace(/^\//,"");
      return SITE_BASE.replace(/\/$/,"/") + rel;
    };
  })();
</script>

<!-- small fixes so labels stay visible + tidy mega menu columns -->
<style>
.featured .overlay { z-index: 2; pointer-events: none; }
.featured .overlay .button { pointer-events: auto; }
.featured .bg-image { position: relative; z-index: 1; }

.has-megamenu { position: relative; }
.has-megamenu .mega{
  position: absolute; left: 50%; top: 100%;
  transform: translate(-50%, 12px);
  width: min(860px, 92vw);
  background: #fff; border: 1px solid #e8e3da; border-radius: 14px;
  box-shadow: 0 24px 60px rgba(0,0,0,.12);
  padding: 22px 26px;
  opacity: 0; visibility: hidden;
  transition: opacity .15s, transform .15s, visibility .15s;
  z-index: 1000;
}
@media (hover:hover) and (pointer:fine){
  .has-megamenu:hover > .mega{ opacity:1; visibility:visible; transform:translate(-50%, 16px); }
}
.has-megamenu.open > .mega{ opacity:1; visibility:visible; transform:translate(-50%, 16px); }
.has-megamenu .mega a{ color:#2b1f1a; text-shadow:none; font-weight:800; text-decoration:none; }

.cat-heading{ margin:0 0 10px; font: 800 0.9rem/1 'Montserrat', system-ui; letter-spacing:.08em; text-transform:uppercase; color:#6d6a33; }
.cat-list{
  list-style:none; margin:0; padding:0;
  display:grid;
  grid-auto-flow: column;
  grid-template-rows: repeat(4, auto);
  grid-auto-columns: minmax(240px, 1fr);
  gap: 14px 32px;
}
.cat-list a{
  display:inline-flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:10px;
}
.cat-list a:hover{ background:#f8f6f2; box-shadow: inset 0 0 0 1px #e8e3da; color:#6d6a33; }
@media (max-width: 720px){
  .has-megamenu .mega{ width:min(600px,96vw); }
  .cat-list{ grid-template-rows: repeat(7,auto); }
}
@media (max-width: 560px){
  .cat-list{ grid-auto-flow: row; grid-template-rows:none; grid-template-columns:1fr; }
}

.product .product-image { position: relative; }

/* ===== AUTH POPUP ===== */
.lokal-auth{
  --la-ink: #222;
  --la-primary: #6A6932;
  --la-primary-hover: #8A8841;
  --la-focus: #A9A74F;
  --la-line: #D7D6AA;
  --la-bg: #fff;
}
.lokal-auth.la-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:3000}
.lokal-auth.la-overlay[aria-hidden="false"]{display:grid}
.lokal-auth .la-modal{
  width:min(440px,92vw);background:var(--la-bg);border-radius:6px;border:1px solid var(--la-line);
  box-shadow:0 16px 50px rgba(0,0,0,.25);font-family:"Helvetica","Arial",sans-serif;animation:fadeIn .25s ease;
}
@keyframes fadeIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
.lokal-auth .la-head{display:flex;align-items:center;justify-content:space-between;padding:22px 26px 14px 26px;}
.lokal-auth .la-title{font-size:1.05rem;font-weight:700;letter-spacing:.02em;margin:0;color:var(--la-ink);}
.lokal-auth .la-close{background:none;border:none;font-size:22px;cursor:pointer;color:var(--la-ink)}
.lokal-auth .la-body{padding:0 26px 20px 26px;}
.lokal-auth .la-intro{font-weight:600;color:var(--la-ink);margin-bottom:20px;}
.lokal-auth .la-label{display:block;font-size:.9rem;font-weight:600;margin-bottom:6px;color:var(--la-ink);}
.lokal-auth .la-input{width:100%;padding:13px 12px;border:1px solid var(--la-ink);border-radius:4px;font-size:.9rem;color:var(--la-ink);font-weight:500;outline:none;}
.lokal-auth .la-input:focus{border-color:var(--la-focus);box-shadow:0 0 0 2px rgba(169,167,79,.3);}
.lokal-auth .la-btn{width:100%;padding:14px;border:none;border-radius:4px;background:var(--la-primary);color:#fff;font-weight:600;letter-spacing:.05em;cursor:pointer;margin-top:16px;font-size:.95rem;}
.lokal-auth .la-btn:hover{background:var(--la-primary-hover);}
.lokal-auth .la-btn:active{transform:translateY(1px);}
.lokal-auth .la-sub{text-align:center;margin-top:8px;}
.lokal-auth .la-sub a{color:var(--la-ink);text-decoration:underline;font-size:.88rem;}
.lokal-auth .la-foot{text-align:center;border-top:1px solid var(--la-line);padding:18px 0 20px 0;}
.lokal-auth .la-mini{display:flex;justify-content:center;align-items:center;gap:6px;font-size:.85rem;color:#555;}
.lokal-auth .la-mini i{font-size:14px;}
.lokal-auth .la-mlink{color:var(--la-ink);text-decoration:underline;font-weight:600;display:inline-block;margin-top:10px;font-size:.9rem;}
</style>

<!-- Auth popup font -->
<link href="https://fonts.googleapis.com/css2?family=Helvetica:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

<!-- ========== LOKAL AUTH POPUP ========== -->
<div class="lokal-auth la-overlay" id="lokalAuthOverlay" aria-hidden="true">
  <div class="la-modal" role="dialog" aria-modal="true" aria-labelledby="laTitle">
    <div class="la-head">
      <h3 id="laTitle" class="la-title">SIGN IN</h3>
      <button class="la-close" id="laClose" aria-label="Close">×</button>
    </div>

    <div class="la-body">
      <p class="la-intro">Sign in with your email or sign up to become a Lokal Member.</p>

      <!-- Step 1: Email -->
      <form id="laEmailForm" novalidate>
        <label class="la-label" for="laEmail">Email <span style="color:#b02a37">*</span></label>
        <input class="la-input" id="laEmail" type="email" placeholder="Email" required />
        <button class="la-btn" type="submit">CONTINUE</button>
      </form>

      <!-- Step 2: Password -->
      <form id="laPassForm" hidden novalidate>
        <label class="la-label" for="laPass">Password</label>
        <input class="la-input" id="laPass" type="password" placeholder="••••••" required minlength="6" />
        <button class="la-btn" type="submit">SIGN IN</button>
        <p class="la-sub"><a href="#" id="laBackEmail">Use another email</a></p>
      </form>
    </div>

    <div class="la-foot">
      <div class="la-mini"><i class="fa-solid fa-lock"></i> All data is kept secure</div>
      <a class="la-mlink" href="membership.html">Lokal Membership</a>
    </div>
  </div>
</div>
<!-- ========== /LOKAL AUTH POPUP ========== -->

<!-- HEADER -->
<header class="header">
  <div class="logo">
    <a href="index.html" aria-label="Home">
      <img src="images/projectlogo.png" alt="logo">
    </a>
  </div>

  <div class="nav-center">
    <form class="site-search" action="search.html" method="GET">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input type="search" name="q" placeholder="Search products, categories..." autocomplete="off" />
      <button type="submit">Search</button>
    </form>

    <nav class="main-links">
      <ul>
        <li><a href="best-pick/best-picks.html">Best Picks</a></li>
        <li><a href="shop-all.html">Shop All</a></li>
        <li class="has-megamenu">
          <a href="#" class="catmenu-toggle" aria-expanded="false">
            Shop by Category <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
          </a>
          <div class="mega" id="catMega" role="menu" aria-label="Shop by Category">
            <h3 class="cat-heading">All Categories</h3>
            <ul class="cat-list">
              <li><a href="shop-all.html?cat=flavors"><i class="fa-solid fa-cookie-bite"></i> Flavors</a></li>
              <li><a href="shop-all.html?cat=accessories"><i class="fa-solid fa-gear"></i> Accessories</a></li>
              <li><a href="shop-all.html?cat=bags"><i class="fa-solid fa-bag-shopping"></i> Bags</a></li>
              <li><a href="shop-all.html?cat=clothing"><i class="fa-solid fa-shirt"></i> Clothing</a></li>
              <li><a href="shop-all.html?cat=home"><i class="fa-solid fa-mug-hot"></i> Home</a></li>
              <li><a href="shop-all.html?cat=crafts"><i class="fa-solid fa-scissors"></i> Crafts</a></li>
              <li><a href="shop-all.html?cat=christmas"><i class="fa-solid fa-snowflake"></i> Christmas / Season</a></li>
            </ul>
          </div>
        </li>
      </ul>
    </nav>
  </div>

  <nav class="utils">
    <ul class="nav-links">
      <!-- IMPORTANT: id for script control -->
      <li><a href="login.html" id="accountLink" aria-label="Account"><i class="fa-solid fa-user"></i></a></li>
      <li>
        <a href="#" id="openCart" aria-label="Open cart">
          <i class="fa-solid fa-cart-shopping"></i>
          <span class="cart-count">0</span>
        </a>
      </li>
      <li style="position: relative;">
        <a href="wishlist.html" aria-label="Favorites" id="wishlistLink">
          <i class="fa-regular fa-heart"></i>
          <span class="wishlist-count" id="wishlistCount">0</span>
        </a>
      </li>
      <li><a href="support.html" aria-label="Support"><i class="fa-solid fa-headset"></i></a></li>
    </ul>
  </nav>
</header>
<!-- HOMEPAGE GREETING -->
<div id="homeGreeting" class="home-greeting" aria-live="polite" hidden></div>

<!-- BANNER -->
<section class="banner">
  <div class="banner-slider">
    <div class="slide active">
      <div class="slide-details">
        <h1>Supporting Local, One Purchase at a Time.</h1>
        <p>Discover a wide variety of everyday essentials and unique finds from trusted local sellers.</p>
        <button class="button" onclick="location.href='shop-all.html'">Shop Now</button>
      </div>
    </div>
    <div class="slide">
      <div class="slide-details">
        <h1>Handmade Crafts for Every Occasion.</h1>
        <p>Unique gifts and décor made with love. Each purchase supports artisans in your community.</p>
        <button class="button" onclick="location.href='shop-all.html?cat=crafts'">Explore Crafts</button>
      </div>
    </div>
    <div class="slide">
      <div class="slide-details">
        <h1>Celebrate Christmas with Local Gifts!</h1>
        <p>Find the perfect holiday gifts handcrafted by local artisans.</p>
        <button class="button" onclick="location.href='shop-all.html?cat=christmas'">Shop Christmas</button>
      </div>
    </div>
  </div>
</section>

<!-- FEATURED -->
<section class="featured">
  <div class="featured-box-1">
    <div class="overlay">
      <button class="button btn" onclick="location.href='shop-all.html?cat=clothing'">Shop Local Clothing</button>
    </div>
    <div class="bg-image">
      <img src="images/filipiniana.png" alt="Clothing">
    </div>
  </div>
  <div class="featured-box-2">
    <div class="featured-box-2-box-1">
      <div class="overlay">
        <button class="button btn" onclick="location.href='shop-all.html?cat=crafts'">Shop Local Crafts</button>
      </div>
      <div class="bg-image">
        <img src="images/16.png" alt="Crafts">
      </div>
    </div>
    <div class="featured-box-2-box-2">
      <div class="overlay">
        <button class="button btn" onclick="location.href='shop-all.html?cat=accessories'">Shop Accessories</button>
      </div>
      <div class="bg-image">
        <img src="images/4p.webp" alt="Accessories">
      </div>
    </div>
    <div class="featured-box-2-box-3">
      <div class="overlay">
        <button class="button btn" onclick="location.href='shop-all.html?cat=bags'">Shop Bags</button>
      </div>
      <div class="bg-image">
        <img src="images/bags.png" alt="Bags">
      </div>
    </div>
  </div>
  <div class="featured-box-3">
    <div class="overlay">
      <button class="button btn" onclick="location.href='shop-all.html?cat=flavors'">Shop Local Flavors</button>
    </div>
    <div class="bg-image">
      <img src="images/delicacies.png" alt="Flavors">
    </div>
  </div>
</section>

<!-- PRODUCTS (sample) -->
<section class="products">
  <h1 class="section-title">Top products of the Season</h1>
  <div class="products-list">
    <div class="product" data-name="Santa Ornament" data-price="₱479.00" data-img="images/main-image.png" data-desc="Festive Santa ornament for your tree.">
      <div class="product-image">
        <div class="main-image"><img src="images/main-image.png" alt="Santa Ornament"></div>
        <div class="effect-image"><img src="images/effect-image.png" alt="Santa Ornament Alt"></div>
        <div class="overlay-image"><button class="button btn">Add To Cart</button></div>
        <button class="wishlist-btn" aria-label="Add to favorites" title="Add to favorites"
          data-id="santa-ornament" data-name="Santa Ornament" data-price="₱479.00"
          data-img="images/main-image.png" data-desc="Festive Santa ornament for your tree."
          data-url="best-pick/product.html" type="button">
          <i class="fa-regular fa-heart"></i>
        </button>
      </div>
      <div class="product-details"><p class="product-name">Santa Ornament</p><p>₱479.00</p></div>
    </div>

    <div class="product" data-name="Christmas Parol" data-price="₱900.00" data-img="images/main-image2.png" data-desc="Classic parol to brighten your holidays.">
      <div class="product-image">
        <div class="main-image"><img src="images/main-image2.png" alt="Christmas Parol"></div>
        <div class="effect-image"><img src="images/effect-image2.png" alt="Christmas Parol Alt"></div>
        <div class="overlay-image"><button class="button btn">Add To Cart</button></div>
        <button class="wishlist-btn" aria-label="Add to favorites" title="Add to favorites"
          data-id="christmas-parol" data-name="Christmas Parol" data-price="₱900.00"
          data-img="images/main-image2.png" data-desc="Classic parol to brighten your holidays."
          data-url="best-pick/product.html" type="button">
          <i class="fa-regular fa-heart"></i>
        </button>
      </div>
      <div class="product-details"><p class="product-name">Christmas Parol</p><p>₱900.00</p></div>
    </div>

    <div class="product" data-name="Santa Stockings" data-price="₱295.00" data-img="images/main-image3.png" data-desc="Cozy stockings for gifts and treats.">
      <div class="product-image">
        <div class="main-image"><img src="images/main-image3.png" alt="Santa Stockings"></div>
        <div class="effect-image"><img src="images/effect-image3.png" alt="Santa Stockings Alt"></div>
        <div class="overlay-image"><button class="button btn">Add To Cart</button></div>
        <button class="wishlist-btn" aria-label="Add to favorites" title="Add to favorites"
          data-id="santa-stockings" data-name="Santa Stockings" data-price="₱295.00"
          data-img="images/main-image3.png" data-desc="Cozy stockings for gifts and treats."
          data-url="best-pick/product.html" type="button">
          <i class="fa-regular fa-heart"></i>
        </button>
      </div>
      <div class="product-details"><p class="product-name">Santa Stockings</p><p>₱295.00</p></div>
    </div>

    <div class="product" data-name="Queso de Bola" data-price="₱300.00" data-img="images/main-image4.png" data-desc="Holiday favorite cheese ball.">
      <div class="product-image">
        <div class="main-image"><img src="images/main-image4.png" alt="Queso de Bola"></div>
        <div class="effect-image"><img src="images/effect-image4.png" alt="Queso de Bola Alt"></div>
        <div class="overlay-image"><button class="button btn">Add To Cart</button></div>
        <button class="wishlist-btn" aria-label="Add to favorites" title="Add to favorites"
          data-id="queso-de-bola" data-name="Queso de Bola" data-price="₱300.00"
          data-img="images/main-image4.png" data-desc="Holiday favorite cheese ball."
          data-url="best-pick/product.html" type="button">
          <i class="fa-regular fa-heart"></i>
        </button>
      </div>
      <div class="product-details"><p class="product-name">Queso de Bola</p><p>₱300.00</p></div>
    </div>
  </div>
</section>

<!-- INSTAGRAM -->
<section class="insta">
  <h1 class="section-title">Shop Now</h1>
  <div class="posts">
    <div class="post-image" data-aos="zoom-in" data-aos-delay="200"><img src="images/insta1.png" alt="insta"></div>
    <div class="post-image" data-aos="zoom-in" data-aos-delay="200"><img src="images/insta2.png" alt="insta"></div>
    <div class="post-image" data-aos="zoom-in" data-aos-delay="200"><img src="images/insta3.png" alt="insta"></div>
    <div class="post-image" data-aos="zoom-in" data-aos-delay="200"><img src="images/insta4.png" alt="insta"></div>
    <div class="post-image" data-aos="zoom-in" data-aos-delay="200"><img src="images/insta5.png" alt="insta"></div>
    <div class="post-image" data-aos="zoom-in" data-aos-delay="200"><img src="images/insta6.png" alt="insta"></div>
  </div>
</section>

<!-- FOOTER -->
<footer class="footer">
  <div class="footer-section">
    <h1>Contact Us</h1>
    <ul class="footer-list">
      <li>lokal@info.com</li>
      <li>lokal@admin.com</li>
      <li>Manila Philippines</li>
      <li class="border-list"></li>
      <li class="socials">
        <i class="fa-brands fa-square-instagram"></i>
        <i class="fa-brands fa-square-facebook"></i>
        <i class="fa-brands fa-tiktok"></i>
      </li>
    </ul>
  </div>
  <div class="footer-section">
    <h1>Quick Links</h1>
    <ul class="footer-list">
      <li><a href="index.html">Home</a></li>
      <li><a href="shop-all.html">Shop All</a></li>
      <li><a href="about.html">About Us</a></li>
      <li><a href="terms.html">Terms & Conditions</a></li>
    </ul>
  </div>
  <div class="footer-section">
    <h1>Subscribe to Newsletter</h1>
    <ul class="footer-list">
      <li>A local marketplace is a community hub where people buy, sell, or trade goods and services within their area.</li>
      <li class="sub">
        <input type="text" placeholder="Your email">
        <button class="button">Subscribe</button>
      </li>
    </ul>
  </div>
</footer>

<!-- CART DRAWER -->
<div class="cd-overlay" id="cdOverlay" aria-hidden="true"></div>
<aside class="cd-drawer" id="cdDrawer" aria-labelledby="cdTitle" aria-hidden="true" role="dialog">
  <header class="cd-header">
    <h2 id="cdTitle">Cart</h2>
    <button class="cd-close" id="cdClose" aria-label="Close cart">&times;</button>
  </header>
  <div class="cd-body">
    <div class="cd-items" id="cdItems"></div>
    <div class="cd-summary">
      <div class="cd-row">
        <span>Subtotal</span>
        <strong id="cdSubtotal">₱0.00</strong>
      </div>
      <p class="cd-note">Shipping, taxes, and discount codes calculated at checkout.</p>
      <label class="cd-terms">
        <input type="checkbox" id="cdAgree">
        I agree with the <a href="terms.html" target="_blank" rel="noopener">terms and conditions</a>
      </label>
      <button class="cd-checkout" id="cdCheckout" disabled>Check Out</button>
    </div>
  </div>
</aside>

<!-- SCRIPTS -->
<script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script>AOS.init();</script>

<!-- Supabase (SDK first, then your client) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<!-- Ask once for first name and store it (metadata + localStorage) -->
<script>
function capName(s){
  s = String(s || "").trim();
  return s ? s.charAt(0).toUpperCase() + s.slice(1) : "";
}
async function ensureFirstName(){
  try{
    if (!window.sb || !sb.auth) return;
    const { data } = await sb.auth.getUser();
    const user = data?.user;
    if (!user) return;

    const md = user.user_metadata || {};
    let first = md.first_name || md.given_name || (md.full_name || md.name || "").split(/\s+/)[0];

    if (!first && user.email){
      // fallback: use the part before @ (capitalized)
      const guess = (user.email.split("@")[0] || "").split(/[._-]/)[0];
      first = guess.charAt(0).toUpperCase() + guess.slice(1);
      await sb.auth.updateUser({ data: { first_name: first } });
    }

    if (first) localStorage.setItem("lokalFirstName", first);
  } catch(_){}
}

</script>

<!-- Account link controller (unchanged except we call ensureFirstName() after login) -->
<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const overlay = $('#lokalAuthOverlay');
  const emailForm = $('#laEmailForm'), passForm = $('#laPassForm');
  const emailInput = $('#laEmail'),  passInput = $('#laPass');
  const accountLink = $('#accountLink');
  let sessionReady = false;
  let isAuthed = false;

  // Open/close auth popup
  const openAuth = ()=>{ overlay?.setAttribute('aria-hidden','false'); emailForm.hidden=false; passForm.hidden=true; setTimeout(()=>emailInput?.focus(),50); };
  const closeAuth = ()=> overlay?.setAttribute('aria-hidden','true');
  $('#laClose')?.addEventListener('click',closeAuth);
  overlay?.addEventListener('click',e=>{ if(e.target===overlay) closeAuth(); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeAuth(); });

  // Email step
  emailForm?.addEventListener('submit', (e)=>{
    e.preventDefault();
    const email=(emailInput.value||'').trim().toLowerCase();
    if(!email){ emailInput.focus(); return; }
    passForm.dataset.email = email;
    emailForm.hidden = true;
    passForm.hidden = false;
    passInput.focus();
  });
  $('#laBackEmail')?.addEventListener('click', (e)=>{ e.preventDefault(); emailForm.hidden=false; passForm.hidden=true; emailInput.focus(); });

  // Password step → Supabase sign-in (or offer sign-up)
  passForm?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = passForm.dataset.email || '';
    const password = passInput.value || '';
    if (!email || !password) { alert('Please enter email and password.'); return; }
    try{
      if (!window.sb || !sb.auth) throw new Error('Supabase client missing. Check supabase.js');
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (!error && data?.user) {
        isAuthed = true;
        await ensureFirstName();     // <-- collect & save first name here
        closeAuth();
        return;
      }
      if (error) {
        const msg = (error.message || '').toLowerCase();
        if (msg.includes('confirm')) { alert('Please confirm your email first.'); return; }
        if (msg.includes('invalid') || msg.includes('password')) { alert('Incorrect email or password.'); return; }
        const create = confirm('No account found for this email. Create a new one?');
        if (!create) return;
        const { error: signUpError } = await sb.auth.signUp({
          email, password,
          options:{ emailRedirectTo: new URL('user.html', location.href).href }
        });
        if (signUpError) { alert(signUpError.message || 'Sign up failed.'); return; }
        alert('Check your email to verify, then sign in.');
        closeAuth();
      }
    } catch (err){
      alert((err && err.message) || 'Network error. Check your Supabase setup.');
    }
  });

  // Session check + live updates
  async function refreshSessionUI(){
    try{
      if (!window.sb || !sb.auth) return;
      const { data } = await sb.auth.getSession();
      isAuthed = !!data?.session;
    }catch(_){}
    sessionReady = true;
  }

  // Click handler for the user icon
  accountLink?.addEventListener('click', async (e)=>{
    e.preventDefault();
    if (!sessionReady) await refreshSessionUI();

    if (isAuthed){
      try{
        const resp = await fetch('user.html', { method:'HEAD' });
        if (resp.ok) location.href = 'user.html';
        else alert('Profile page (user.html) not found. Please add it to your repo.');
      } catch { location.href = 'user.html'; }
    } else {
      openAuth();
    }
  });

  // Initialize live session sync
  (async function init(){
    await refreshSessionUI();
    if (window.sb && sb.auth && sb.auth.onAuthStateChange){
      sb.auth.onAuthStateChange((_event, session)=>{
        isAuthed = !!session;
        if (session) ensureFirstName();
      });
    }
  })();
})();
</script>

<!-- NOW load lokal.js so it can see Supabase immediately -->
<script src="lokal.js"></script>

<!-- Your cart logic (deferred is fine) -->
<script src="cart.js" defer></script>
</body>
</html>
