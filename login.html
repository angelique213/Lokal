<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lokal — Sign In</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --brand:#6A6932;      /* primary */
    --brand-2:#8A8841;    /* hover */
    --accent:#A9A74F;     /* focus ring */
    --tint:#E6E5CA;       /* soft bg */
    --line:#D7D6AA;       /* borders */
    --ink:#2b1f1a;
    --ok:#166534;
    --err:#b91c1c;
  }

  body{
    margin:0;
    font-family:Montserrat,system-ui,Arial,sans-serif;
    background:var(--tint);
    color:var(--ink);
    display:grid;place-items:center;min-height:100vh;
  }

  .card{
    width:min(420px,90vw);
    border:1px solid var(--line);
    border-radius:12px;
    background:#fff;
    box-shadow:0 24px 60px rgba(0,0,0,.12);
    padding:26px;
  }

  h1{
    margin-top:0;
    font-size:1.1rem;
    font-weight:800;
    text-align:left;
    letter-spacing:.02em;
    color:var(--brand);
  }

  p{font-weight:600;margin-bottom:1rem;color:#3b342e}

  label{
    display:block;
    font-weight:700;
    font-size:.9rem;
    margin-bottom:6px;
    color:var(--ink);
  }

  input[type=email],
  input[type=password]{
    width:100%;
    padding:12px;
    border:1px solid var(--line);
    border-radius:10px;
    font-weight:600;
    background:#fff;
    color:var(--ink);
    margin-bottom:1rem;
    outline:none;
    transition:border-color .15s, box-shadow .15s;
  }

  input[type=email]:focus,
  input[type=password]:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 4px rgba(169,167,79,.28);
  }

  .btn{
    width:100%;
    padding:14px;
    background:var(--brand);
    color:#fff;
    border:none;
    border-radius:10px;
    font-weight:800;
    cursor:pointer;
    letter-spacing:.03em;
    transition:background .2s, transform .05s, filter .2s, opacity .2s;
  }
  .btn:hover{ background:var(--brand-2); }
  .btn:active{ transform:translateY(1px); }
  .btn[disabled]{ opacity:.7; cursor:not-allowed; }

  .mini{
    display:flex;align-items:center;gap:6px;
    font-size:.85rem;color:#6b7280;margin-top:10px
  }
  .mini i{font-size:15px;color:var(--brand)}

  .foot{text-align:center;margin-top:1rem}
  .foot a{color:var(--brand-2);text-decoration:underline;font-weight:700}

  #backEmail{color:var(--brand-2);text-decoration:underline;font-weight:700}

  /* inline message area */
  #msg{min-height:1.25em;font-size:.92rem;margin:.25rem 0 .5rem;}
  #msg.ok{color:var(--ok);font-weight:800}
  #msg.err{color:var(--err);font-weight:800}
</style>
</head>
<body>
  <main class="card">
    <h1>SIGN IN</h1>
    <p>Sign in with your email or sign up to become a Lokal Member.</p>

    <!-- Step 1: email -->
    <form id="emailForm" novalidate>
      <label for="em">Email <span style="color:#b02a37">*</span></label>
      <input id="em" type="email" placeholder="you@example.com" autocomplete="email" required />
      <button class="btn" id="emailNext" type="submit">CONTINUE</button>
    </form>

    <!-- Step 2: password -->
    <form id="passForm" hidden novalidate>
      <label for="pw">Password</label>
      <input id="pw" type="password" placeholder="••••••" autocomplete="current-password" required minlength="6" />
      <button class="btn" id="signinBtn" type="submit">SIGN IN</button>
      <p style="text-align:center;margin-top:8px"><a href="#" id="backEmail">Use another email</a></p>
    </form>

    <!-- inline status -->
    <div id="msg" role="status" aria-live="polite"></div>

    <div class="mini"><i class="fa-solid fa-lock"></i> All data is kept secure</div>
    <div class="foot"><a href="membership.html">Lokal Membership</a></div>
  </main>

  <!-- Supabase libs + your client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <script>
  (async function(){
    const $ = s => document.querySelector(s);

    const emailForm = $('#emailForm');
    const passForm  = $('#passForm');
    const emailInput= $('#em');
    const passInput = $('#pw');
    const msg       = $('#msg');
    const emailNext = $('#emailNext');
    const signinBtn = $('#signinBtn');

    const params   = new URLSearchParams(location.search);
    const redirect = params.get('redirect') || 'user.html';

    // If already logged in, go straight to redirect target
    try {
      const { data: { session } } = await sb.auth.getSession();
      if (session) {
        location.href = redirect;
        return;
      }
    } catch(_) {}

    // If membership passed ?email=, prefill & go straight to password step
    const preset = params.get('email');
    if (preset) {
      emailInput.value = preset;
      emailForm.hidden = true;
      passForm.hidden  = false;
      passInput.focus();
    }

    function setMsg(text, ok=false, err=false){
      msg.textContent = text || '';
      msg.className = ok ? 'ok' : err ? 'err' : '';
    }

    emailForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const email = (emailInput.value || '').trim();
      if (!email) { setMsg('Please enter your email.', false, true); return; }
      setMsg('');
      emailForm.hidden = true;
      passForm.hidden  = false;
      passInput.focus();
    });

    passForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = (emailInput.value || '').trim().toLowerCase();
      const password = passInput.value;

      if (!email || !password) { setMsg('Enter your email and password.', false, true); return; }

      setMsg('Signing you in…');
      signinBtn.disabled = true;
      emailNext.disabled = true;

      try{
        const { data, error } = await sb.auth.signInWithPassword({ email, password });

        if (error) {
          // Most common is invalid credentials. Offer quick signup.
          setMsg('Invalid email or password. You can try again or create an account.', false, true);

          // Add a lightweight CTA just below:
          if (!document.getElementById('ctaSignup')) {
            const a = document.createElement('a');
            a.id = 'ctaSignup';
            a.href = 'signup.html?email=' + encodeURIComponent(email);
            a.textContent = 'Create a new account →';
            a.style.display = 'inline-block';
            a.style.marginTop = '6px';
            a.style.fontWeight = '800';
            a.style.color = getComputedStyle(document.documentElement).getPropertyValue('--brand-2').trim() || '#8A8841';
            a.style.textDecoration = 'underline';
            msg.insertAdjacentElement('afterend', a);
          }
          return;
        }

        // success: go where we need to
        setMsg('Success! Redirecting…', true, false);
        location.href = redirect;
      } catch (err){
        console.error(err);
        setMsg('Network error. Please try again.', false, true);
      } finally {
        signinBtn.disabled = false;
        emailNext.disabled = false;
      }
    });

    $('#backEmail').addEventListener('click', (e)=>{
      e.preventDefault();
      setMsg('');
      passForm.hidden  = true;
      emailForm.hidden = false;
      emailInput.focus();
    });
  })();
  </script>
</body>
</html>
