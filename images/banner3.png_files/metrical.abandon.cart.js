_MetricalDeployment={version:"0dc4e82e182eb59eb93d35029c77c8c68a901383",lastUpdated:"2023-01-18 21:15:38 UTC"},_MetricalHosts={legacy:{apiendpointhost:"api.getmetrical.com",staticendpointhost:"content.getmetrical.com",probabilityenginehost:"probability.getmetrical.com",probabilityenginetesthost:!1,surveyanswerendpoint:"https://hfcqk5kiya.execute-api.us-east-1.amazonaws.com/prod/postanswer",cxinteractionendpoint:"https://hfcqk5kiya.execute-api.us-east-1.amazonaws.com/prod/postcxinteraction"},endpoints:{previousVisitor:"https://g4ipuvvgf7.execute-api.us-east-1.amazonaws.com/prod/visit/{surveyId}/{uuid}/{sessionId}/previousVisitor",previousCustomer:"https://g4ipuvvgf7.execute-api.us-east-1.amazonaws.com/prod/visit/{surveyId}/{uuid}/{sessionId}/previousCustomer",coupon:"https://g4ipuvvgf7.execute-api.us-east-1.amazonaws.com/prod/coupon",provision:"https://g4ipuvvgf7.execute-api.us-east-1.amazonaws.com/prod/site/provision",interaction:"https://api-v2.getmetrical.com/interaction",offerFlow:"https://api-v2.getmetrical.com/offerflow",singleUseCoupon:"https://api-v2.getmetrical.com/singleusecoupon",timeframeCoupon:"https://api-v2.getmetrical.com/coupon/timeframe",pe:"https://api-v2.getmetrical.com/pe",storageSync:"https://api-v2.getmetrical.com/storagesync",callBridge:"https://phoneservices.getmetrical.com/bridgeCall",message:"https://phoneservices.getmetrical.com/message"}},String.prototype.includes||(String.prototype.includes=function(){"use strict";return-1!==String.prototype.indexOf.apply(this,arguments)}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){if(null==this)throw new TypeError('"this" is null or not defined');var r=Object(this),i=r.length>>>0;if(0===i)return!1;var o,n,a=0|t,s=Math.max(a>=0?a:i-Math.abs(a),0);for(;s<i;){if((o=r[s])===(n=e)||"number"==typeof o&&"number"==typeof n&&isNaN(o)&&isNaN(n))return!0;s++}return!1}}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var r=Object(e),i=1;i<arguments.length;i++){var o=arguments[i];if(null!=o)for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(r[n]=o[n])}return r},writable:!0,configurable:!0}),function(){const e=function(e){return"string"==typeof e},t=function(e){return e instanceof Blob};(function(){if(function(){return"navigator"in this&&"sendBeacon"in this.navigator}.call(this))return;"navigator"in this||(this.navigator={});this.navigator.sendBeacon=function(r,i){var o=this.event&&this.event.type,n="unload"===o||"beforeunload"===o;const a="XMLHttpRequest"in this?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.open("POST",r,!n),a.withCredentials=!0,a.setRequestHeader("Accept","*/*"),e(i)?(a.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),a.responseType="text/plain"):t(i)&&i.type&&a.setRequestHeader("Content-Type",i.type);try{a.send(i)}catch(e){return!1}return!0}.bind(this)}).call("object"==typeof window?window:this)}(),Object.setPrototypeOf||(Object.prototype.setPrototypeOf=function(e,t){if(e.__proto__)return e.__proto__=t,e;var r=function(){for(var t in e)Object.defineProperty(this,t,{value:e[t]})};return r.prototype=t,new r}),function(){var e;e=function(){"use strict";function e(e){var t=this.constructor;return this.then(function(r){return t.resolve(e()).then(function(){return r})},function(r){return t.resolve(e()).then(function(){return t.reject(r)})})}function t(e){return!(!e||void 0===e.length)}function r(){}function i(e){if(!(this instanceof i))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],c(e,this)}function o(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,i._immediateFn(function(){var r=1===e._state?t.onFulfilled:t.onRejected;if(null!==r){var i;try{i=r(e._value)}catch(e){return void a(t.promise,e)}n(t.promise,i)}else(1===e._state?n:a)(t.promise,e._value)})):e._deferreds.push(t)}function n(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var r=t.then;if(t instanceof i)return e._state=3,e._value=t,void s(e);if("function"==typeof r)return void c(function(e,t){return function(){e.apply(t,arguments)}}(r,t),e)}e._state=1,e._value=t,s(e)}catch(t){a(e,t)}}function a(e,t){e._state=2,e._value=t,s(e)}function s(e){2===e._state&&0===e._deferreds.length&&i._immediateFn(function(){e._handled||i._unhandledRejectionFn(e._value)});for(var t=0,r=e._deferreds.length;r>t;t++)o(e,e._deferreds[t]);e._deferreds=null}function c(e,t){var r=!1;try{e(function(e){r||(r=!0,n(t,e))},function(e){r||(r=!0,a(t,e))})}catch(e){if(r)return;r=!0,a(t,e)}}var l=setTimeout;i.prototype.catch=function(e){return this.then(null,e)},i.prototype.then=function(e,t){var i=new this.constructor(r);return o(this,new function(e,t,r){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=r}(e,t,i)),i},i.prototype.finally=e,i.all=function(e){return new i(function(r,i){function o(e,t){try{if(t&&("object"==typeof t||"function"==typeof t)){var s=t.then;if("function"==typeof s)return void s.call(t,function(t){o(e,t)},i)}n[e]=t,0==--a&&r(n)}catch(e){i(e)}}if(!t(e))return i(new TypeError("Promise.all accepts an array"));var n=Array.prototype.slice.call(e);if(0===n.length)return r([]);for(var a=n.length,s=0;n.length>s;s++)o(s,n[s])})},i.resolve=function(e){return e&&"object"==typeof e&&e.constructor===i?e:new i(function(t){t(e)})},i.reject=function(e){return new i(function(t,r){r(e)})},i.race=function(e){return new i(function(r,o){if(!t(e))return o(new TypeError("Promise.race accepts an array"));for(var n=0,a=e.length;a>n;n++)i.resolve(e[n]).then(r,o)})},i._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){l(e,0)},i._unhandledRejectionFn=function(e){void 0!==console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};var u=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw Error("unable to locate global object")}();"Promise"in u?u.Promise.prototype.finally||(u.Promise.prototype.finally=e):u.Promise=i},"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(),"".trim||(String.prototype.trim=function(){return this.replace(/^[\s]+|[\s]+$/g,"")}),function(e){"use strict";e.DOMException||((DOMException=function(e){this.message=e}).prototype=new Error);var t,r,i=/[\11\12\14\15\40]/,o=0,n=function(e,t){if(""===t)throw new DOMException("Failed to execute '"+e+"' on 'DOMTokenList': The token provided must not be empty.");if(-1!==(o=t.search(i)))throw new DOMException("Failed to execute '"+e+"' on 'DOMTokenList': The token provided ('"+t[o]+"') contains HTML space characters, which are not valid in tokens.")};"function"!=typeof DOMTokenList&&function(e){var t=e.document,r=e.Object,o=r.prototype.hasOwnProperty,a=r.defineProperty,s=0,c=0;function l(){if(!s)throw TypeError("Illegal constructor")}function u(){var t=e.event,r=t.propertyName;if(!c&&("className"===r||"classList"===r&&!a)){var o=t.srcElement,n=o[" uCLp"],s=""+o[r],l=s.trim().split(i),u=o["classList"===r?" uCL":"classList"],p=n.length;e:for(var d=0,f=n.length=l.length,h=0;d!==f;++d){for(var g=0;g!==d;++g)if(l[g]===l[d]){h++;continue e}u[d-h]=l[d]}for(var m=f-h;m<p;++m)delete u[m];if("classList"!==r)return;c=1,o.classList=u,o.className=s,c=0,u.length=l.length-h}}function p(e){if(!(e&&"innerHTML"in e))throw TypeError("Illegal invocation");e.detachEvent("onpropertychange",u),s=1;try{function t(){}t.prototype=new l}finally{s=0}var r=t.prototype,o=new t;e:for(var n=e.className.trim().split(i),p=0,d=n.length,f=0;p!==d;++p){for(var h=0;h!==p;++h)if(n[h]===n[p]){f++;continue e}this[p-f]=n[p]}r.length=d-f,r.value=e.className,r[" uCL"]=e,a?(a(e,"classList",{enumerable:1,get:function(){return o},configurable:0,set:function(t){c=1,e.className=r.value=t+="",c=0;var n=t.trim().split(i),a=r.length;e:for(var s=0,l=r.length=n.length,u=0;s!==l;++s){for(var p=0;p!==s;++p)if(n[p]===n[s]){u++;continue e}o[s-u]=n[s]}for(var d=l-u;d<a;++d)delete o[d]}}),a(e," uCLp",{enumerable:0,configurable:0,writeable:0,value:t.prototype}),a(r," uCL",{enumerable:0,configurable:0,writeable:0,value:e})):(e.classList=o,e[" uCL"]=o,e[" uCLp"]=t.prototype),e.attachEvent("onpropertychange",u)}l.prototype.toString=l.prototype.toLocaleString=function(){return this.value},l.prototype.add=function(){e:for(var e=0,t=arguments.length,r="",i=this[" uCL"],o=i[" uCLp"];e!==t;++e){r=arguments[e]+"",n("add",r);for(var a=0,s=o.length,l=r;a!==s;++a){if(this[a]===r)continue e;l+=" "+this[a]}this[s]=r,o.length+=1,o.value=l}c=1,i.className=o.value,c=0},l.prototype.remove=function(){for(var e=0,t=arguments.length,r="",i=this[" uCL"],o=i[" uCLp"];e!==t;++e){r=arguments[e]+"",n("remove",r);for(var a=0,s=o.length,l="",u=0;a!==s;++a)u?this[a-1]=this[a]:this[a]!==r?l+=this[a]+" ":u=1;u&&(delete this[s],o.length-=1,o.value=l)}c=1,i.className=o.value,c=0},e.DOMTokenList=l;try{e.Object.defineProperty(e.Element.prototype,"classList",{enumerable:1,get:function(e){return o.call(this,"classList")||p(this),this.classList},configurable:0,set:function(e){this.className=e}})}catch(r){e[" uCL"]=p,t.documentElement.firstChild.appendChild(t.createElement("style")).styleSheet.cssText='_*{x-uCLp:expression(!this.hasOwnProperty("classList")&&window[" uCL"](this))}[class]{x-uCLp/**/:expression(!this.hasOwnProperty("classList")&&window[" uCL"](this))}'}}(e),t=e.DOMTokenList.prototype,r=e.document.createElement("div").classList,t.item||(t.item=function(e){return void 0===(t=this[e])?null:t;var t}),t.toggle&&!1===r.toggle("a",0)||(t.toggle=function(e){if(arguments.length>1)return this[arguments[1]?"add":"remove"](e),!!arguments[1];var t=this.value;return this.remove(t),t===this.value&&(this.add(e),!0)}),t.replace&&"boolean"==typeof r.replace("a","b")||(t.replace=function(e,t){n("replace",e),n("replace",t);var r=this.value;return this.remove(e),this.value!==r&&(this.add(t),!0)}),t.contains||(t.contains=function(e){for(var t=0,r=this.length;t!==r;++t)if(this[t]===e)return!0;return!1}),t.forEach||(t.forEach=function(e){if(1===arguments.length)for(var t=0,r=this.length;t!==r;++t)e(this[t],t,this);else{t=0,r=this.length;for(var i=arguments[1];t!==r;++t)e.call(i,this[t],t,this)}}),t.entries||(t.entries=function(){var e=0,t=this;return{next:function(){return e<t.length?{value:[e,t[e++]],done:!1}:{done:!0}}}}),t.values||(t.values=function(){var e=0,t=this;return{next:function(){return e<t.length?{value:t[e++],done:!1}:{done:!0}}}}),t.keys||(t.keys=function(){var e=0,t=this;return{next:function(){return e<t.length?{value:e++,done:!1}:{done:!0}}}})}(window),function(){"use strict";if("object"==typeof window)if("IntersectionObserver"in window&&"IntersectionObserverEntry"in window&&"intersectionRatio"in window.IntersectionObserverEntry.prototype)"isIntersecting"in window.IntersectionObserverEntry.prototype||Object.defineProperty(window.IntersectionObserverEntry.prototype,"isIntersecting",{get:function(){return this.intersectionRatio>0}});else{var e=function(e){for(var t=window.document,r=o(t);r;)r=o(t=r.ownerDocument);return t}(),t=[],r=null,i=null;a.prototype.THROTTLE_TIMEOUT=100,a.prototype.POLL_INTERVAL=null,a.prototype.USE_MUTATION_OBSERVER=!0,a._setupCrossOriginUpdater=function(){return r||(r=function(e,r){i=e&&r?p(e,r):{top:0,bottom:0,left:0,right:0,width:0,height:0},t.forEach(function(e){e._checkForIntersections()})}),r},a._resetCrossOriginUpdater=function(){r=null,i=null},a.prototype.observe=function(e){if(!this._observationTargets.some(function(t){return t.element==e})){if(!e||1!=e.nodeType)throw new Error("target must be an Element");this._registerInstance(),this._observationTargets.push({element:e,entry:null}),this._monitorIntersections(e.ownerDocument),this._checkForIntersections()}},a.prototype.unobserve=function(e){this._observationTargets=this._observationTargets.filter(function(t){return t.element!=e}),this._unmonitorIntersections(e.ownerDocument),0==this._observationTargets.length&&this._unregisterInstance()},a.prototype.disconnect=function(){this._observationTargets=[],this._unmonitorAllIntersections(),this._unregisterInstance()},a.prototype.takeRecords=function(){var e=this._queuedEntries.slice();return this._queuedEntries=[],e},a.prototype._initThresholds=function(e){var t=e||[0];return Array.isArray(t)||(t=[t]),t.sort().filter(function(e,t,r){if("number"!=typeof e||isNaN(e)||e<0||e>1)throw new Error("threshold must be a number between 0 and 1 inclusively");return e!==r[t-1]})},a.prototype._parseRootMargin=function(e){var t=(e||"0px").split(/\s+/).map(function(e){var t=/^(-?\d*\.?\d+)(px|%)$/.exec(e);if(!t)throw new Error("rootMargin must be specified in pixels or percent");return{value:parseFloat(t[1]),unit:t[2]}});return t[1]=t[1]||t[0],t[2]=t[2]||t[0],t[3]=t[3]||t[1],t},a.prototype._monitorIntersections=function(t){var r=t.defaultView;if(r&&-1==this._monitoringDocuments.indexOf(t)){var i=this._checkForIntersections,n=null,a=null;this.POLL_INTERVAL?n=r.setInterval(i,this.POLL_INTERVAL):(s(r,"resize",i,!0),s(t,"scroll",i,!0),this.USE_MUTATION_OBSERVER&&"MutationObserver"in r&&(a=new r.MutationObserver(i)).observe(t,{attributes:!0,childList:!0,characterData:!0,subtree:!0})),this._monitoringDocuments.push(t),this._monitoringUnsubscribes.push(function(){var e=t.defaultView;e&&(n&&e.clearInterval(n),c(e,"resize",i,!0)),c(t,"scroll",i,!0),a&&a.disconnect()});var l=this.root&&(this.root.ownerDocument||this.root)||e;if(t!=l){var u=o(t);u&&this._monitorIntersections(u.ownerDocument)}}},a.prototype._unmonitorIntersections=function(t){var r=this._monitoringDocuments.indexOf(t);if(-1!=r){var i=this.root&&(this.root.ownerDocument||this.root)||e;if(!this._observationTargets.some(function(e){var r=e.element.ownerDocument;if(r==t)return!0;for(;r&&r!=i;){var n=o(r);if((r=n&&n.ownerDocument)==t)return!0}return!1})){var n=this._monitoringUnsubscribes[r];if(this._monitoringDocuments.splice(r,1),this._monitoringUnsubscribes.splice(r,1),n(),t!=i){var a=o(t);a&&this._unmonitorIntersections(a.ownerDocument)}}}},a.prototype._unmonitorAllIntersections=function(){var e=this._monitoringUnsubscribes.slice(0);this._monitoringDocuments.length=0,this._monitoringUnsubscribes.length=0;for(var t=0;t<e.length;t++)e[t]()},a.prototype._checkForIntersections=function(){if(this.root||!r||i){var e=this._rootIsInDom(),t=e?this._getRootRect():{top:0,bottom:0,left:0,right:0,width:0,height:0};this._observationTargets.forEach(function(i){var o=i.element,a=l(o),s=this._rootContainsTarget(o),c=i.entry,u=e&&s&&this._computeTargetAndRootIntersection(o,a,t),p=null;this._rootContainsTarget(o)?r&&!this.root||(p=t):p={top:0,bottom:0,left:0,right:0,width:0,height:0};var d=i.entry=new n({time:window.performance&&performance.now&&performance.now(),target:o,boundingClientRect:a,rootBounds:p,intersectionRect:u});c?e&&s?this._hasCrossedThreshold(c,d)&&this._queuedEntries.push(d):c&&c.isIntersecting&&this._queuedEntries.push(d):this._queuedEntries.push(d)},this),this._queuedEntries.length&&this._callback(this.takeRecords(),this)}},a.prototype._computeTargetAndRootIntersection=function(t,o,n){if("none"!=window.getComputedStyle(t).display){for(var a,s,c,u,d,h,g,m,v=o,b=f(t),y=!1;!y&&b;){var _=null,w=1==b.nodeType?window.getComputedStyle(b):{};if("none"==w.display)return null;if(b==this.root||9==b.nodeType)if(y=!0,b==this.root||b==e)r&&!this.root?!i||0==i.width&&0==i.height?(b=null,_=null,v=null):_=i:_=n;else{var M=f(b),C=M&&l(M),E=M&&this._computeTargetAndRootIntersection(M,C,n);C&&E?(b=M,_=p(C,E)):(b=null,v=null)}else{var A=b.ownerDocument;b!=A.body&&b!=A.documentElement&&"visible"!=w.overflow&&(_=l(b))}if(_&&(a=_,s=v,c=void 0,u=void 0,d=void 0,h=void 0,g=void 0,m=void 0,c=Math.max(a.top,s.top),u=Math.min(a.bottom,s.bottom),d=Math.max(a.left,s.left),h=Math.min(a.right,s.right),m=u-c,v=(g=h-d)>=0&&m>=0&&{top:c,bottom:u,left:d,right:h,width:g,height:m}||null),!v)break;b=b&&f(b)}return v}},a.prototype._getRootRect=function(){var t;if(this.root&&!h(this.root))t=l(this.root);else{var r=h(this.root)?this.root:e,i=r.documentElement,o=r.body;t={top:0,left:0,right:i.clientWidth||o.clientWidth,width:i.clientWidth||o.clientWidth,bottom:i.clientHeight||o.clientHeight,height:i.clientHeight||o.clientHeight}}return this._expandRectByRootMargin(t)},a.prototype._expandRectByRootMargin=function(e){var t=this._rootMarginValues.map(function(t,r){return"px"==t.unit?t.value:t.value*(r%2?e.width:e.height)/100}),r={top:e.top-t[0],right:e.right+t[1],bottom:e.bottom+t[2],left:e.left-t[3]};return r.width=r.right-r.left,r.height=r.bottom-r.top,r},a.prototype._hasCrossedThreshold=function(e,t){var r=e&&e.isIntersecting?e.intersectionRatio||0:-1,i=t.isIntersecting?t.intersectionRatio||0:-1;if(r!==i)for(var o=0;o<this.thresholds.length;o++){var n=this.thresholds[o];if(n==r||n==i||n<r!=n<i)return!0}},a.prototype._rootIsInDom=function(){return!this.root||d(e,this.root)},a.prototype._rootContainsTarget=function(t){var r=this.root&&(this.root.ownerDocument||this.root)||e;return d(r,t)&&(!this.root||r==t.ownerDocument)},a.prototype._registerInstance=function(){t.indexOf(this)<0&&t.push(this)},a.prototype._unregisterInstance=function(){var e=t.indexOf(this);-1!=e&&t.splice(e,1)},window.IntersectionObserver=a,window.IntersectionObserverEntry=n}function o(e){try{return e.defaultView&&e.defaultView.frameElement||null}catch(e){return null}}function n(e){this.time=e.time,this.target=e.target,this.rootBounds=u(e.rootBounds),this.boundingClientRect=u(e.boundingClientRect),this.intersectionRect=u(e.intersectionRect||{top:0,bottom:0,left:0,right:0,width:0,height:0}),this.isIntersecting=!!e.intersectionRect;var t=this.boundingClientRect,r=t.width*t.height,i=this.intersectionRect,o=i.width*i.height;this.intersectionRatio=r?Number((o/r).toFixed(4)):this.isIntersecting?1:0}function a(e,t){var r,i,o,n=t||{};if("function"!=typeof e)throw new Error("callback must be a function");if(n.root&&1!=n.root.nodeType&&9!=n.root.nodeType)throw new Error("root must be a Document or Element");this._checkForIntersections=(r=this._checkForIntersections.bind(this),i=this.THROTTLE_TIMEOUT,o=null,function(){o||(o=setTimeout(function(){r(),o=null},i))}),this._callback=e,this._observationTargets=[],this._queuedEntries=[],this._rootMarginValues=this._parseRootMargin(n.rootMargin),this.thresholds=this._initThresholds(n.threshold),this.root=n.root||null,this.rootMargin=this._rootMarginValues.map(function(e){return e.value+e.unit}).join(" "),this._monitoringDocuments=[],this._monitoringUnsubscribes=[]}function s(e,t,r,i){"function"==typeof e.addEventListener?e.addEventListener(t,r,i||!1):"function"==typeof e.attachEvent&&e.attachEvent("on"+t,r)}function c(e,t,r,i){"function"==typeof e.removeEventListener?e.removeEventListener(t,r,i||!1):"function"==typeof e.detatchEvent&&e.detatchEvent("on"+t,r)}function l(e){var t;try{t=e.getBoundingClientRect()}catch(e){}return t?(t.width&&t.height||(t={top:t.top,right:t.right,bottom:t.bottom,left:t.left,width:t.right-t.left,height:t.bottom-t.top}),t):{top:0,bottom:0,left:0,right:0,width:0,height:0}}function u(e){return!e||"x"in e?e:{top:e.top,y:e.top,bottom:e.bottom,left:e.left,x:e.left,right:e.right,width:e.width,height:e.height}}function p(e,t){var r=t.top-e.top,i=t.left-e.left;return{top:r,left:i,height:t.height,width:t.width,bottom:r+t.height,right:i+t.width}}function d(e,t){for(var r=t;r;){if(r==e)return!0;r=f(r)}return!1}function f(t){var r=t.parentNode;return 9==t.nodeType&&t!=e?o(t):(r&&r.assignedSlot&&(r=r.assignedSlot.parentNode),r&&11==r.nodeType&&r.host?r.host:r)}function h(e){return e&&9===e.nodeType}}(),_MetricalUtils={evaluate:function(input){try{var result=eval(input);return result}catch(e){var name="EvalParsingError",message=name+" - "+e.message+" - "+input;throw e.name=name,e.message=message,e}},evaluateObject:function(e){var t={};if("object"!=typeof e)throw new Error("_MetricalUtils.evaluateObject() expects the input to be an object");null!==e&&Object.keys(e).forEach(function(r){for(var i=e[r],o=Array.isArray(i)?i:[i],n=null,a=0;a<o.length&&null===(n=_MetricalUtils.evaluate(o[a]));a++);t[r]=n});return t},evaluateRule:function(rule,conditions,tags){var result=!1,originalRule=rule;try{var keys=Object.keys(conditions);keys.sort(function(e,t){return t.length-e.length});var tagKeys=Object.keys(tags||[]);tagKeys.sort(function(e,t){return t.length-e.length});for(var i=0;i<tagKeys.length;i++){var tagKey=tagKeys[i],searchKey="#"+tagKey,tagValue="object"==typeof tags[tagKey]&&null!==tags[tagKey]&&void 0!==tags[tagKey]&&"result"in tags[tagKey]?tags[tagKey].result:tags[tagKey];rule=rule.replace(searchKey,String(tagValue))}for(var i=0;i<keys.length;i++){var conditionKey=keys[i],conditionValue="object"==typeof conditions[conditionKey]&&"result"in conditions[conditionKey]?conditions[conditionKey].result:conditions[conditionKey];rule=rule.replace(conditionKey,String(conditionValue))}result=eval(rule)}catch(e){var name="RuleParsingError",message=e.message+" - "+originalRule+" - "+rule+" - "+JSON.stringify(conditions)+" - "+JSON.stringify(tags);throw e.name=name,e.message=message,e}return result},ruleCriteriaString:function(e,t,r){r=r||{};var i=Object.keys(t);i.sort(function(e,t){return t.length-e.length});var o=Object.keys(r||[]);o.sort(function(e,t){return t.length-e.length});for(var n=0;n<o.length;n++){var a=o[n],s=r[a],c="#"+a,l=c+" ("+String(s)+") ",u=new RegExp(c+"\\s{1}|"+c+"$","g");e=e.replace(u,l).trim()}for(n=0;n<i.length;n++){var p=i[n],d="object"==typeof t[p]&&"result"in t[p]?t[p].result:t[p];l=p+" ("+String(d)+")";e=e.replace(p,l)}return e},chooseRandomItem:function(e){for(var t,r,i=e.reduce(function(e,t){return e+t.weight},0),o=(t=0,r=i,Math.random()*(r-t)+t),n=0,a=0;a<e.length;a++)if(o<=(n=+(n+=e[a].weight).toFixed(4)))return e[a].item},testRegex:function(e,t){return new RegExp(e).test(t)},determineDevice:function(){var e="desktop";/Touch|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(e=window.matchMedia("(max-width: 730px)").matches?"mobile":window.matchMedia("screen and (orientation: portrait)").matches?screen.width<=480?"mobile":"tabletvertical":screen.height<=480?"mobile":"tablethorizontal");return e},isPlusDelimitedFormat:function(e){return/^\[(.*?\+)+[^\+]+?\]$/.test(e)},plusDelimitedParts:function(e){return 1==this.isPlusDelimitedFormat(e)?e.slice(1).slice(0,-1).split("+"):(newInput=e.replace("[","").replace("]",""),newInput.length>0?[newInput]:[])},plusDelimitArray:function(e){var t=Array.isArray(e)?e:[e];return t.length>0?"["+t.join("+")+"]":null},round:function(e,t){var r=Math.pow(10,t),i=e*r;return Math.round(i)/r},cleanMoney:function(e){var t=0;if("number"==typeof e&&(t=e),"string"==typeof e){var r=e.replace("$","").replace(",","").match(/[\d]+(\.\d+)?/g);null!==r&&(t=parseFloat(r[0]))}return t},getIEVersion:function(){var e=navigator.userAgent.match(/(?:MSIE |Trident\/.*; rv:)(\d+)/);return e?parseInt(e[1]):void 0},makeUUID:function(){var e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?r:7&r|8).toString(16)})},getFullDateUTC:function(e){var t=""+e.getUTCFullYear(),r=""+(e.getUTCMonth()+1);1==r.length&&(r="0"+r);var i=""+e.getUTCDate();1==i.length&&(i="0"+i);var o=""+e.getUTCHours();1==o.length&&(o="0"+o);var n=""+e.getUTCMinutes();1==n.length&&(n="0"+n);var a=""+e.getUTCSeconds();return 1==a.length&&(a="0"+a),t+"-"+r+"-"+i+" "+o+":"+n+":"+a},identifierIsIOS:function(){return!!/iPhone|iPad|iPod/i.test(navigator.userAgent)},PubSub:function(){var e={subscriptions:{},subscriptionKeys:{},topicPublishCount:{},subscribers:function(e){var t=this;return(e in this.subscriptions?Object.keys(this.subscriptions[e]):[]).map(function(r){return e in t.subscriptions?t.subscriptions[e][r]:function(){}})},subscribe:function(e,t){e in this.subscriptions||(this.subscriptions[e]={},this.subscriptionKeys[e]=0);var r=e+"-"+this.subscriptionKeys[e];return this.subscriptions[e][r]=t,this.subscriptionKeys[e]++,r},unsubscribe:function(e,t){var r=e in this.subscriptions?this.subscriptions[e]:{};t in r&&delete r[t]},publish:function(e,t,r){var i=e in this.subscriptions?this.subscriptions[e]:{};if(this.topicPublishCount[e]=e in this.topicPublishCount?this.topicPublishCount[e]+1:1,void 0===r||this.topicPublishCount[e]<=r)for(var o in i){(0,i[o])(t)}}};return e},jsonPath:function(obj,expr,arg){var P={resultType:arg&&arg.resultType||"VALUE",result:[],normalize:function(e){var t=[];return e.replace(/[\['](\??\(.*?\))[\]']/g,function(e,r){return"[#"+(t.push(r)-1)+"]"}).replace(/'?\.'?|\['?/g,";").replace(/;;;|;;/g,";..;").replace(/;$|'?\]|'$/g,"").replace(/#([0-9]+)/g,function(e,r){return t[r]})},asPath:function(e){for(var t=e.split(";"),r="$",i=1,o=t.length;i<o;i++)r+=/^[0-9*]+$/.test(t[i])?"["+t[i]+"]":"['"+t[i]+"']";return r},store:function(e,t){return e&&(P.result[P.result.length]="PATH"==P.resultType?P.asPath(e):t),!!e},trace:function(e,t,r){if(e){var i=e.split(";"),o=i.shift();if(i=i.join(";"),t&&t.hasOwnProperty(o))P.trace(i,t[o],r+";"+o);else if("*"===o)P.walk(o,i,t,r,function(e,t,r,i,o){P.trace(e+";"+r,i,o)});else if(".."===o)P.trace(i,t,r),P.walk(o,i,t,r,function(e,t,r,i,o){"object"==typeof i[e]&&P.trace("..;"+r,i[e],o+";"+e)});else if(/,/.test(o))for(var n=o.split(/'?,'?/),a=0,s=n.length;a<s;a++)P.trace(n[a]+";"+i,t,r);else/^\(.*?\)$/.test(o)?P.trace(P.eval(o,t,r.substr(r.lastIndexOf(";")+1))+";"+i,t,r):/^\?\(.*?\)$/.test(o)?P.walk(o,i,t,r,function(e,t,r,i,o){P.eval(t.replace(/^\?\((.*?)\)$/,"$1"),i[e],e)&&P.trace(e+";"+r,i,o)}):/^(-?[0-9]*):(-?[0-9]*):?([0-9]*)$/.test(o)&&P.slice(o,i,t,r)}else P.store(r,t)},walk:function(e,t,r,i,o){if(r instanceof Array)for(var n=0,a=r.length;n<a;n++)n in r&&o(n,e,t,r,i);else if("object"==typeof r)for(var s in r)r.hasOwnProperty(s)&&o(s,e,t,r,i)},slice:function(e,t,r,i){if(r instanceof Array){var o=r.length,n=0,a=o,s=1;e.replace(/^(-?[0-9]*):(-?[0-9]*):?(-?[0-9]*)$/g,function(e,t,r,i){n=parseInt(t||n),a=parseInt(r||a),s=parseInt(i||s)}),n=n<0?Math.max(0,n+o):Math.min(o,n),a=a<0?Math.max(0,a+o):Math.min(o,a);for(var c=n;c<a;c+=s)P.trace(c+";"+t,r,i)}},eval:function(x,_v,_vname){try{return $&&_v&&eval(x.replace(/@/g,"_v"))}catch(e){throw new SyntaxError("jsonPath: "+e.message+": "+x.replace(/@/g,"_v").replace(/\^/g,"_a"))}}},$=obj;if(expr&&obj&&("VALUE"==P.resultType||"PATH"==P.resultType))return P.trace(P.normalize(expr).replace(/^\$;/,""),obj,"$"),!!P.result.length&&P.result},get:function(e,t,r){r=void 0!==r?r:null,t=0!==t.indexOf("$.")?"$."+t:t;var i=this.jsonPath(e,t);return Array.isArray(i)&&i.length>0?i[0]:r},isJson:function(e){try{JSON.parse(e);return!0}catch(e){return!1}},getParameterByName:function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var r=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null},waitForIdToAppear:function(e,t){if(document.getElementById(e))t();else{var r=new MutationObserver(function(i){document.getElementById(e)&&(r.disconnect(),t())});r.observe(document,{attributes:!1,childList:!0,characterData:!1,subtree:!0})}},parseUserMetaArray:function(e){return/^\[(.*?)\]$/.test(e)?e.slice(1).slice(0,-1).split("+"):[e]},querySelector:function(e){return document.querySelector(e)},querySelectorAll:function(e){return document.querySelectorAll(e)},isEqual:function(){var e=200,t="__lodash_hash_undefined__",r=1,i=2,o=9007199254740991,n="[object Arguments]",a="[object Array]",s="[object Boolean]",c="[object Date]",l="[object Error]",u="[object Function]",p="[object GeneratorFunction]",d="[object Map]",f="[object Number]",h="[object Object]",g="[object RegExp]",m="[object Set]",v="[object String]",b="[object Symbol]",y="[object ArrayBuffer]",_="[object DataView]",w=/^\[object .+?Constructor\]$/,M=/^(?:0|[1-9]\d*)$/,C={};C["[object Float32Array]"]=C["[object Float64Array]"]=C["[object Int8Array]"]=C["[object Int16Array]"]=C["[object Int32Array]"]=C["[object Uint8Array]"]=C["[object Uint8ClampedArray]"]=C["[object Uint16Array]"]=C["[object Uint32Array]"]=!0,C[n]=C[a]=C[y]=C[s]=C[_]=C[c]=C[l]=C[u]=C[d]=C[f]=C[h]=C[g]=C[m]=C[v]=C["[object WeakMap]"]=!1;var E="object"==typeof global&&global&&global.Object===Object&&global,A="object"==typeof self&&self&&self.Object===Object&&self,I=E||A||Function("return this")(),O="object"==typeof exports&&exports&&!exports.nodeType&&exports,x=O&&"object"==typeof module&&module&&!module.nodeType&&module,S=x&&x.exports===O&&E.process,k=function(){try{return S&&S.binding("util")}catch(e){}}(),T=k&&k.isTypedArray;function j(e,t){for(var r=-1,i=e?e.length:0;++r<i;)if(t(e[r],r,e))return!0;return!1}function L(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function D(e){var t=-1,r=Array(e.size);return e.forEach(function(e,i){r[++t]=[i,e]}),r}function P(e){var t=-1,r=Array(e.size);return e.forEach(function(e){r[++t]=e}),r}var R,B,F,V=Array.prototype,U=Function.prototype,q=Object.prototype,H=I["__core-js_shared__"],N=(R=/[^.]+$/.exec(H&&H.keys&&H.keys.IE_PROTO||""))?"Symbol(src)_1."+R:"",K=U.toString,J=q.hasOwnProperty,z=q.toString,$=RegExp("^"+K.call(J).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),G=I.Symbol,W=I.Uint8Array,Q=q.propertyIsEnumerable,Y=V.splice,X=(B=Object.keys,F=Object,function(e){return B(F(e))}),Z=Ee(I,"DataView"),ee=Ee(I,"Map"),te=Ee(I,"Promise"),re=Ee(I,"Set"),ie=Ee(I,"WeakMap"),oe=Ee(Object,"create"),ne=Oe(Z),ae=Oe(ee),se=Oe(te),ce=Oe(re),le=Oe(ie),ue=G?G.prototype:void 0,pe=ue?ue.valueOf:void 0;function de(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var i=e[t];this.set(i[0],i[1])}}function fe(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var i=e[t];this.set(i[0],i[1])}}function he(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var i=e[t];this.set(i[0],i[1])}}function ge(e){var t=-1,r=e?e.length:0;for(this.__data__=new he;++t<r;)this.add(e[t])}function me(e){this.__data__=new fe(e)}function ve(e,t){var r=Se(e)||function(e){return function(e){return De(e)&&ke(e)}(e)&&J.call(e,"callee")&&(!Q.call(e,"callee")||z.call(e)==n)}(e)?function(e,t){for(var r=-1,i=Array(e);++r<e;)i[r]=t(r);return i}(e.length,String):[],i=r.length,o=!!i;for(var a in e)!t&&!J.call(e,a)||o&&("length"==a||Ie(a,i))||r.push(a);return r}function be(e,t){for(var r=e.length;r--;)if(xe(e[r][0],t))return r;return-1}function ye(e,t,o,u,p){return e===t||(null==e||null==t||!Le(e)&&!De(t)?e!=e&&t!=t:function(e,t,o,u,p,w){var M=Se(e),C=Se(t),E=a,A=a;M||(E=(E=Ae(e))==n?h:E);C||(A=(A=Ae(t))==n?h:A);var I=E==h&&!L(e),O=A==h&&!L(t),x=E==A;if(x&&!I)return w||(w=new me),M||Pe(e)?Me(e,t,o,u,p,w):function(e,t,o,n,a,u,p){switch(o){case _:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case y:return!(e.byteLength!=t.byteLength||!n(new W(e),new W(t)));case s:case c:case f:return xe(+e,+t);case l:return e.name==t.name&&e.message==t.message;case g:case v:return e==t+"";case d:var h=D;case m:var w=u&i;if(h||(h=P),e.size!=t.size&&!w)return!1;var M=p.get(e);if(M)return M==t;u|=r,p.set(e,t);var C=Me(h(e),h(t),n,a,u,p);return p.delete(e),C;case b:if(pe)return pe.call(e)==pe.call(t)}return!1}(e,t,E,o,u,p,w);if(!(p&i)){var S=I&&J.call(e,"__wrapped__"),k=O&&J.call(t,"__wrapped__");if(S||k){var T=S?e.value():e,j=k?t.value():t;return w||(w=new me),o(T,j,u,p,w)}}if(!x)return!1;return w||(w=new me),function(e,t,r,o,n,a){var s=n&i,c=Re(e),l=c.length,u=Re(t).length;if(l!=u&&!s)return!1;for(var p=l;p--;){var d=c[p];if(!(s?d in t:J.call(t,d)))return!1}var f=a.get(e);if(f&&a.get(t))return f==t;var h=!0;a.set(e,t),a.set(t,e);for(var g=s;++p<l;){d=c[p];var m=e[d],v=t[d];if(o)var b=s?o(v,m,d,t,e,a):o(m,v,d,e,t,a);if(!(void 0===b?m===v||r(m,v,o,n,a):b)){h=!1;break}g||(g="constructor"==d)}if(h&&!g){var y=e.constructor,_=t.constructor;y!=_&&"constructor"in e&&"constructor"in t&&!("function"==typeof y&&y instanceof y&&"function"==typeof _&&_ instanceof _)&&(h=!1)}return a.delete(e),a.delete(t),h}(e,t,o,u,p,w)}(e,t,ye,o,u,p))}function _e(e){return!(!Le(e)||(t=e,N&&N in t))&&(Te(e)||L(e)?$:w).test(Oe(e));var t}function we(e){if(r=(t=e)&&t.constructor,i="function"==typeof r&&r.prototype||q,t!==i)return X(e);var t,r,i,o=[];for(var n in Object(e))J.call(e,n)&&"constructor"!=n&&o.push(n);return o}function Me(e,t,o,n,a,s){var c=a&i,l=e.length,u=t.length;if(l!=u&&!(c&&u>l))return!1;var p=s.get(e);if(p&&s.get(t))return p==t;var d=-1,f=!0,h=a&r?new ge:void 0;for(s.set(e,t),s.set(t,e);++d<l;){var g=e[d],m=t[d];if(n)var v=c?n(m,g,d,t,e,s):n(g,m,d,e,t,s);if(void 0!==v){if(v)continue;f=!1;break}if(h){if(!j(t,function(e,t){if(!h.has(t)&&(g===e||o(g,e,n,a,s)))return h.add(t)})){f=!1;break}}else if(g!==m&&!o(g,m,n,a,s)){f=!1;break}}return s.delete(e),s.delete(t),f}function Ce(e,t){var r,i,o=e.__data__;return("string"==(i=typeof(r=t))||"number"==i||"symbol"==i||"boolean"==i?"__proto__"!==r:null===r)?o["string"==typeof t?"string":"hash"]:o.map}function Ee(e,t){var r=function(e,t){return null==e?void 0:e[t]}(e,t);return _e(r)?r:void 0}de.prototype.clear=function(){this.__data__=oe?oe(null):{}},de.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},de.prototype.get=function(e){var r=this.__data__;if(oe){var i=r[e];return i===t?void 0:i}return J.call(r,e)?r[e]:void 0},de.prototype.has=function(e){var t=this.__data__;return oe?void 0!==t[e]:J.call(t,e)},de.prototype.set=function(e,r){return this.__data__[e]=oe&&void 0===r?t:r,this},fe.prototype.clear=function(){this.__data__=[]},fe.prototype.delete=function(e){var t=this.__data__,r=be(t,e);return!(r<0||(r==t.length-1?t.pop():Y.call(t,r,1),0))},fe.prototype.get=function(e){var t=this.__data__,r=be(t,e);return r<0?void 0:t[r][1]},fe.prototype.has=function(e){return be(this.__data__,e)>-1},fe.prototype.set=function(e,t){var r=this.__data__,i=be(r,e);return i<0?r.push([e,t]):r[i][1]=t,this},he.prototype.clear=function(){this.__data__={hash:new de,map:new(ee||fe),string:new de}},he.prototype.delete=function(e){return Ce(this,e).delete(e)},he.prototype.get=function(e){return Ce(this,e).get(e)},he.prototype.has=function(e){return Ce(this,e).has(e)},he.prototype.set=function(e,t){return Ce(this,e).set(e,t),this},ge.prototype.add=ge.prototype.push=function(e){return this.__data__.set(e,t),this},ge.prototype.has=function(e){return this.__data__.has(e)},me.prototype.clear=function(){this.__data__=new fe},me.prototype.delete=function(e){return this.__data__.delete(e)},me.prototype.get=function(e){return this.__data__.get(e)},me.prototype.has=function(e){return this.__data__.has(e)},me.prototype.set=function(t,r){var i=this.__data__;if(i instanceof fe){var o=i.__data__;if(!ee||o.length<e-1)return o.push([t,r]),this;i=this.__data__=new he(o)}return i.set(t,r),this};var Ae=function(e){return z.call(e)};function Ie(e,t){return!!(t=null==t?o:t)&&("number"==typeof e||M.test(e))&&e>-1&&e%1==0&&e<t}function Oe(e){if(null!=e){try{return K.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function xe(e,t){return e===t||e!=e&&t!=t}(Z&&Ae(new Z(new ArrayBuffer(1)))!=_||ee&&Ae(new ee)!=d||te&&"[object Promise]"!=Ae(te.resolve())||re&&Ae(new re)!=m||ie&&"[object WeakMap]"!=Ae(new ie))&&(Ae=function(e){var t=z.call(e),r=t==h?e.constructor:void 0,i=r?Oe(r):void 0;if(i)switch(i){case ne:return _;case ae:return d;case se:return"[object Promise]";case ce:return m;case le:return"[object WeakMap]"}return t});var Se=Array.isArray;function ke(e){return null!=e&&je(e.length)&&!Te(e)}function Te(e){var t=Le(e)?z.call(e):"";return t==u||t==p}function je(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=o}function Le(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function De(e){return!!e&&"object"==typeof e}var Pe=T?function(e){return function(t){return e(t)}}(T):function(e){return De(e)&&je(e.length)&&!!C[z.call(e)]};function Re(e){return ke(e)?ve(e):we(e)}return function(e,t){return ye(e,t)}}(),throttle:function(e,t){let r,i;return function(){var o=this,n=arguments;i?(clearTimeout(r),r=setTimeout(function(){Date.now()-i>=t&&(e.apply(o,n),i=Date.now())},t-(Date.now()-i))):(e.apply(o,n),i=Date.now())}},debounce:function(e,t){let r;return function(){var i=this,o=arguments;clearTimeout(r),r=setTimeout(function(){e.apply(i,o)},t)}},intersection:function(e,t){var r;return t.length>e.length&&(r=t,t=e,e=r),e.filter(function(e){return t.indexOf(e)>-1}).filter(function(e,t,r){return r.indexOf(e)===t})},categoryList:function(e,t){return t=t||"/",0==!!e?[]:String(e).split(t).map(function(e){return String(e).trim()})},applyFunctionToObject:function(e,t){if("object"!=typeof e||null===e)throw new Error("applyFunctionToObject expects an input object to be provided");if("function"!=typeof t)throw new Error("applyFunctionToObject expects a function to be provided that accepts a value and key parameter");var r=function(e){var i={};for(var o in e){var n=e[o],a="object"==typeof n&&null!==n?r(n):t(n,o);i[o]=a}return i};return r(e)},template:function(e,t){if(t="object"==typeof t?t:{},"string"!=typeof e)return e;for(var r in t){var i="{{"+r+"}}";e=e.replace(i,t[r])}return e},promiseSequence:function(e){return new Promise(function(t,r){var i=Promise.resolve(),o=[];e.filter(function(e){return"function"==typeof e}).length!=e.length&&r(new Error("promiseSequence was provided an input value that is not a function")),e.forEach(function(e){i=i.then(function(){return e()}).then(function(e){return o.push(e),e}).catch(function(e){r(e)})}),i.then(function(){t(o)}).catch(function(e){r(e)})})},sessionIdentifiers:function(){return{surveyId:_MetricalAbandonCart.Config.surveyid,uuid:_MetricalIdentity.getDeviceId(),sessionId:_MetricalIdentity.getSessionId()}},watchForElement:function(e,t){try{var r=document.getElementsByTagName("body"),i=(o=function(){_MetricalAbandonCart.logger.debug("selector check function");var r=document.querySelector(e);null!==r&&(_MetricalAbandonCart.logger.debug("el has a value"),_MetricalAbandonCart.logger.debug(typeof t),t(r))},n=250,function(){var e=this,t=arguments,r=a&&!s;clearTimeout(s),s=setTimeout(function(){s=null,a||o.apply(e,t)},n),r&&o.apply(e,t)});new MutationObserver(function(e,t){_MetricalAbandonCart.logger.debug(e.length);for(var r=0;r<e.length;r++)"childList"===e[r].type&&(_MetricalAbandonCart.logger.debug("calling debounce method"),i())}).observe(r[0],{attributes:!1,childList:!0,subtree:!0})}catch(e){console.error(e)}var o,n,a,s},run:function(inputCommands){const commands=Array.isArray(inputCommands)?inputCommands:[inputCommands];var context=void 0;return commands.forEach(function(cur){var result=eval(cur);context=result}),context}},_MetricalDateUtils={getLocalUtcTimestamp:function(){return(new Date).getTime()},isValidTimestamp:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},getTimestamp:function(e){if(null!=e)return this.isValidTimestamp(e)?e:Date.parse(e)},isTimestampBetweenDates:function(e,t,r){return(void 0===t||!isNaN(t))&&((void 0===r||!isNaN(r))&&(t&&r?t<=e&&e<=r:t&&!r?t<=e:!(t||!r)&&e<=r))},dbFormat:function(e){var t=e||(new Date).getTime();return new Date(t).toISOString()}},_MetricalStandardStorage=function(e){var t={localStorage:void 0!==globalThis.localStorage?globalThis.localStorage:null,localStorageKey:"_MSS"};if(this.properties=Object.assign({},t,e||{}),0==!!this.properties.localStorage)throw new Error("_MetricalStandardStorage could not determine a proper localStorage solution to use")},_MetricalStandardStorage.prototype.hasItem=function(e){return null!==this.getItem(e)},_MetricalStandardStorage.prototype.getItem=function(e){var t=null,r=this._get(e);return null!==r&&(1==this._hasExpired(r)?this._remove(e):(this._resetExpiredAfter(e,r),t=r.value)),t},_MetricalStandardStorage.prototype.setItem=function(e,t,r){var i=r||{},o={expires:null,expiresAfter:null,value:t};"expires"in i&&(o.expires="object"==typeof i.expires?i.expires.getTime():i.expires),"expiresInSeconds"in i&&(o.expires=(new Date).getTime()+1e3*i.expiresInSeconds),"expiresAfter"in i&&(o.expiresAfter=i.expiresAfter,o.expires=(new Date).getTime()+1e3*i.expiresAfter),this._set(e,o)},_MetricalStandardStorage.prototype.keys=function(){var e=this,t=[];return e._keys().filter(function(t){return e.keyHasPrefix(t)}).forEach(function(r){var i=e.unformatKey(r);e.hasItem(i)&&t.push(i)}),t},_MetricalStandardStorage.prototype.all=function(){var e=this;return this.keys().reduce(function(t,r){return t[r]=e.getItem(r),t},{})},_MetricalStandardStorage.prototype.removeItem=function(e){this.hasItem(e)&&this._remove(e)},_MetricalStandardStorage.prototype.removeMatchingItems=function(e){var t=this,r=Array.isArray(e)?e:[e],i=t.keys();r.forEach(function(e){var r=new RegExp(e);i.forEach(function(e){r.test(e)&&t.removeItem(e)})})},_MetricalStandardStorage.prototype.clear=function(){var e=this;this.keys().forEach(function(t){e.removeItem(t)})},_MetricalStandardStorage.prototype._resetExpiredAfter=function(e,t){"expiresAfter"in t&&null!==t.expiresAfter&&(t.expires=(new Date).getTime()+1e3*t.expiresAfter,this._set(e,t))},_MetricalStandardStorage.prototype._hasExpired=function(e){return"expires"in e&&null!==e.expires&&(new Date).getTime()>e.expires},_MetricalStandardStorage.prototype.prefix=function(){return this.properties.localStorageKey+"_"},_MetricalStandardStorage.prototype.keyHasPrefix=function(e){return e.indexOf(this.prefix())>-1},_MetricalStandardStorage.prototype.formatKey=function(e){return this.prefix()+e},_MetricalStandardStorage.prototype.unformatKey=function(e){var t=this.prefix();return e.indexOf(t)>-1?e.substr(t.length):e},_MetricalStandardStorage.prototype._remove=function(e){try{this.properties.localStorage.removeItem(this.formatKey(e))}catch(e){throw e}},_MetricalStandardStorage.prototype._get=function(e){try{var t=this.properties.localStorage.getItem(this.formatKey(e));return JSON.parse(t)}catch(e){throw e}},_MetricalStandardStorage.prototype._set=function(e,t){try{var r=t?JSON.stringify(t):"";this.properties.localStorage.setItem(this.formatKey(e),r)}catch(e){throw e}},_MetricalStandardStorage.prototype._keys=function(){try{return Object.keys(this.properties.localStorage)}catch(e){throw e}},_MetricalStorage={root:this,import:function(e){var t=this;"object"==typeof e&&null!==e&&("storage"in e&&"object"==typeof e.storage&&Object.keys(e.storage).forEach(function(r){t.Storage.setItem(r,e.storage[r])}),"sessionStorage"in e&&"object"==typeof e.sessionStorage&&Object.keys(e.sessionStorage).forEach(function(r){t.SessionStorage.setItem(r,e.sessionStorage[r])}),"cookie"in e&&"object"==typeof e.cookie&&Object.keys(e.cookie).forEach(function(r){t.Cookie.setItem(r,e.cookie[r],1/0,"/",t.Cookie.rootDomain())}),"sessionCookie"in e&&"object"==typeof e.sessionCookie&&Object.keys(e.sessionCookie).forEach(function(r){t.Cookie.sessionQuickSet(r,e.sessionCookie[r])}))},export:function(){var e=this,t={};t.storage=e.Storage.metricalObject(),t.sessionStorage=e.SessionStorage.metricalObject();var r=e.Cookie.metricalObject(),i=Object.keys(r).reduce(function(t,i){return 1==e.Cookie.isLongLivedKey(i)&&(t[i]=r[i]),t},{});t.cookie=i;var o=Object.keys(r).reduce(function(t,i){return 0==e.Cookie.isLongLivedKey(i)&&(t[i]=r[i]),t},{});return t.sessionCookie=o,t},Storage:{storagePrefix:"_Metrical_",prefixKey:function(e){return e=0===e.indexOf(this.storagePrefix)?e:this.storagePrefix+e},getItem:function(e){e=this.prefixKey(e);var t=localStorage.getItem(e);return _MetricalUtils.isJson(t)&&(t=JSON.parse(t)),t},setItem:function(e,t){var r=this.prefixKey(e);value="object"==typeof t?JSON.stringify(t):t;var i=this.getItem(e);localStorage.setItem(r,value),0==_MetricalUtils.isEqual(i,t)&&_MetricalStorage.publish("data-change",{action:"storage-set",key:r,value:t})},removeItem:function(e){var t=this.prefixKey(e);return localStorage.removeItem(t),_MetricalStorage.publish("data-change",{action:"storage-remove",key:t}),!0},clear:function(){for(var e=this.keys(),t=0;t<e.length;t++){var r=e[t];0===r.indexOf(this.storagePrefix)&&this.removeItem(r.replace(this.storagePrefix,""))}},keys:function(){for(var e=[],t=0,r=localStorage.length;t<r;++t){var i=localStorage.key(t);0===i.indexOf(this.storagePrefix)&&e.push(i)}return e},metricalObject:function(){for(var e={},t=this.keys(),r=0;r<t.length;r++){var i=t[r],o=this.getItem(i);e[i]=o}return e}},SessionStorage:{storagePrefix:"_Metrical_",prefixKey:function(e){return e=0===e.indexOf(this.storagePrefix)?e:this.storagePrefix+e},getItem:function(e){e=this.prefixKey(e);var t=sessionStorage.getItem(e);return _MetricalUtils.isJson(t)&&(t=JSON.parse(t)),t},setItem:function(e,t){var r=this.prefixKey(e);value="object"==typeof t?JSON.stringify(t):t;var i=this.getItem(e);sessionStorage.setItem(r,value),0==_MetricalUtils.isEqual(i,t)&&_MetricalStorage.publish("data-change",{action:"session-set",key:r,value:t})},removeItem:function(e){var t=this.prefixKey(e);return sessionStorage.removeItem(t),_MetricalStorage.publish("data-change",{action:"session-remove",key:t}),!0},clear:function(){for(var e=this.keys(),t=0;t<e.length;t++){var r=e[t];0===r.indexOf(this.storagePrefix)&&this.removeItem(r.replace(this.storagePrefix,""))}},keys:function(){for(var e=[],t=0,r=sessionStorage.length;t<r;++t){var i=sessionStorage.key(t);0===i.indexOf(this.storagePrefix)&&e.push(i)}return e},metricalObject:function(){for(var e={},t=this.keys(),r=0;r<t.length;r++){var i=t[r],o=this.getItem(i);e[i]=o}return e}},Cookie:{path:"/",domain:document.domain,prefix:"_Metrical_",altPrefix:"_MetricalObject_",longLivedCookies:["_Metrical_ACStatusOutputCounter","_Metrical_UserAbandonCount","_Metrical_ConditionsObserver_enabled","_Metrical_promoopened_general","_Metrical_PageViewCount","_Metrical_TimeOnSite","_Metrical_offers_disabled","_Metrical_CookiesUpdated","_MetricalObject_QA","_MetricalObject_did","_MetricalObject_sample","_MetricalObject_tracking","_Metrical_clickregistered_","_MetricalAbandonCart_","_treatmenttag","_testgroup","_localtime_override"],isLongLivedKey:function(e){return e=this.prefixKey(e),this.longLivedCookies.filter(function(t){return-1!==e.indexOf(t)}).length>0},rootDomain:function(){var e=location.hostname.split(".").reverse();return e.length>1?"uk"==e[0]&&"co"==e[1]&&e.length>2?"."+e[2]+"."+e[1]+"."+e[0]:"com"==e[0]&&"myshopify"==e[1]?location.hostname:"."+e[1]+"."+e[0]:"."+e[0]},prefixKey:function(e){return e=0===e.indexOf(this.prefix)||0===e.indexOf(this.altPrefix)?e:this.prefix+e},getItem:function(e){e=this.prefixKey(e);var t=decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null;return _MetricalUtils.isJson(t)&&(t=JSON.parse(t)),t},getItemWithoutPrefix:function(e){var t=decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null;return _MetricalUtils.isJson(t)&&(t=JSON.parse(t)),t},sessionQuickSet:function(e,t){return this.quickSet(e,t,0)},quickSet:function(e,t,r){return void 0===r&&(r=1/0),this.setItem(e,t,r,this.path,this.rootDomain(),!1)},setItem:function(e,t,r,i,o,n,a){if(i||(i=this.path),o||(o=this.rootDomain()),!e||/^(?:expires|max\-age|path|domain|secure|SameSite)$/i.test(e))return!1;e=this.prefixKey(e);var s="";if(r)switch(r.constructor){case Number:s=r===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+r;break;case String:s="; expires="+r;break;case Date:s="; expires="+r.toUTCString()}sValue="object"==typeof t?JSON.stringify(t):t;var c=location.protocol;n||"https:"!=c||(n="secure"),a||(a="Lax");var l=this.getItem(e),u=encodeURIComponent(e)+"="+encodeURIComponent(sValue)+s+(o?"; domain="+o:"")+(i?"; path="+i:"")+(n?"; secure":"")+"; SameSite="+a;return document.cookie=u,0==_MetricalUtils.isEqual(l,t)&&_MetricalStorage.publish("data-change",{action:"cookie-set",key:e,value:t}),!0},removeItem:function(e,t,r){return!(!e||!this.hasItem(e))&&(e=this.prefixKey(e),t=t||this.path,r=r||this.rootDomain(),document.cookie=encodeURIComponent(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(r?"; domain="+r:"")+(t?"; path="+t:""),_MetricalStorage.publish("data-change",{action:"cookie-remove",key:e}),!0)},hasItem:function(e){return e=this.prefixKey(e),new RegExp("(?:^|;\\s*)"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){for(var e=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),t=0;t<e.length;t++)e[t]=decodeURIComponent(e[t]);return e},getAllCookies:function(){return this.getCookies(!1)},getCookies:function(e){null==e&&(e=!0);for(var t=this.keys(),r=[],i=0;i<t.length;i++){var o=t[i],n=this.getItem(o);1==e&&-1==o.indexOf(this.metricalCookieNamePrefix)||r.push({"cookie-key":o,value:n})}return r},getAllCookieObject:function(){return this.getCookieObject(!1)},getCookieObject:function(e){for(var t=this.getCookies(e),r={},i=0;i<t.length;i++){var o=t[i],n=o["cookie-key"],a=o.value;r[n]=a}return r},makeExpires:function(e){var t=new Date;return t.setTime(t.getTime()+1e3*e),t},metricalObject:function(){for(var e={},t=this.keys(),r=0;r<t.length;r++){var i=t[r];if(0===i.indexOf(this.prefix)||0===i.indexOf(this.altPrefix)){var o=this.getItem(i);e[i]=o}}return e},addSameSiteSupport:function(){var e=this;if(!this.hasItem("CookiesUpdated")){var t=[];this.keys().forEach(function(r){-1!==r.indexOf("Metrical")&&e.longLivedCookies.forEach(function(e){-1!==r.indexOf(e)&&t.push(r)})}),t.forEach(function(t){var r=e.getItem(t);r&&e.setItem(t,r,1/0,"/",e.rootDomain())}),e.setItem("CookiesUpdated",!0,1/0,"/",e.rootDomain())}}},ServerStore:{store:{},objKey:null,init:function(e,t){if(this.objKey=t,0!=!!e){var r=this,i=_MetricalHosts.endpoints.offerFlowStore+"/"+e;jQuery.ajax({type:"GET",url:i,dataType:"json",async:!1,success:function(e){r.store[r.objKey]=e,console.log("data"),console.log(e)},error:function(e,t,r){console.log(e),console.log(t),console.log(r)}})}},getItem:function(e){return this.store[e]?this.store[e]:null},setItem:function(e,t){this.store[e]=t},_post:function(e){var t=_MetricalHosts.endpoints.offerFlowStore;navigator.sendBeacon(t,JSON.stringify(e))}}},Object.setPrototypeOf(_MetricalStorage,_MetricalUtils.PubSub()),_MetricalStorageManager=function(e){if(this.properties=Object.assign({},{storage:null,ss:null},e||{}),0==!!this.properties.ss)throw new Error("_MetricalStorageManager requires a ss parameter");if(0==!!this.properties.storage)throw new Error("_MetricalStorageManager requires a storage parameter")},_MetricalStorageManager.prototype._getObj=function(e){switch(e){case"SessionStorage":return this.properties.storage.SessionStorage;case"Storage":return this.properties.storage.Storage;case"Cookie":return this.properties.storage.Cookie;case"MSS":return this.properties.ss;default:throw new Error("_MetricalStorageManager could not identify the source "+e)}},_MetricalStorageManager.prototype.migrate=function(e){var t=this._getObj(e.source),r=this._getObj(e.target),i=e.removeAfterMigration||!1,o=Array.isArray(e.records)?e.records:[e.records],n=[];return o.forEach(function(e){var o=t.getItem(e.sourceKey);if(null!==o){var a=e.options||{};r.setItem(e.targetKey,o,a),n.push(e.targetKey),i&&t.removeItem(e.sourceKey)}}),n},_MetricalStorageManager.prototype.remove=function(e){var t=this._getObj(e.source),r=Array.isArray(e.records)?e.records:[e.records],i=[],o=t.keys();return r.forEach(function(e){o.filter(function(t){return new RegExp(e).test(t)}).forEach(function(e){t.removeItem(e),i.push(e)})}),i},_MetricalTransportDefault=function(e){var t={logLevel:"warning",levels:{trace:10,debug:20,info:30,warning:40,error:50,fatal:60},filters:[],infoLogFunc:console.log,errorLogFunc:console.error};this.properties=Object.assign({},t,e),this.levels=this.properties.levels},_MetricalTransportDefault.prototype.write=function(e){var t=this.levels[this.properties.logLevel];this.levels[e.level]>=t&&this.entryPassesFilters(e)&&(e.value>=50?this.properties.errorLogFunc(e):this.properties.infoLogFunc(e))},_MetricalTransportDefault.prototype.setLogLevel=function(e){if(!(e in this.levels))throw new Error("Passed value "+e+" is not a valid log level");this.properties.logLevel=e},_MetricalTransportDefault.prototype.clearFilters=function(){this.properties.filters=[]},_MetricalTransportDefault.prototype.addFilter=function(e){if(!("path"in e))throw new Error("path parameter is a required key in the filter");if(!("is"in e||"not"in e))throw new Error("is or not parameters are a required key in the filter");this.properties.filters.push(e)},_MetricalTransportDefault.prototype.entryPassesFilters=function(e){return 0==this.properties.filters.length||1!=this.properties.filters.map(function(t){try{var r=t.path,i=null,o=!0;if("is"in t&&(i=t.is),"not"in t&&(i=t.not,o=!o),r in e&&null!==i)if(e[r]==i)return o;return!o}catch(e){return console.error(e),!0}}).includes(!1)},_MetricalTransportMonitor=function(e){if(this.properties=Object.assign({},{monitor:null},e),0==!!this.properties.monitor)throw new Error("_MetricalTransportMonitor requires a monitor object to be passed")},_MetricalTransportMonitor.prototype.write=function(e){e.terminal&&1==e.terminal&&this.properties.monitor.addLogEntry(e)},_MetricalLogger=function(e){this.properties=Object.assign({},{defaultLevel:"info",extra:{},transports:[],levels:{trace:10,debug:20,info:30,warning:40,error:50,fatal:60}},e),this.levels=this.properties.levels,this.transports=this.properties.transports},_MetricalLogger.prototype.addTransport=function(e){this.transports.push(e)},_MetricalLogger.prototype.clearTransports=function(){this.transports=[]},_MetricalLogger.prototype.child=function(e){var t=Object.assign({},this.properties,{extra:e||{}});return new _MetricalLogger(t)},_MetricalLogger.prototype._formatEntry=function(e,t,r){var i=(new Date).toISOString();return Object.assign({level:e,value:this.levels[e],ts:i},this.properties.extra||{},t||{},r||{})},_MetricalLogger.prototype.transport=function(e){this.transports.forEach(function(t){switch(typeof t){case"function":t(e);break;case"object":"write"in t&&t.write(e)}})},_MetricalLogger.prototype.log=function(){var e=this.properties.defaultLevel,t="",r={};if(1==arguments.length)t="object"==typeof arguments[0]?Object.assign(arguments[0]):{msg:String(arguments[0])};else if(2==arguments.length){var i=arguments[0];i in this.levels?(e=i,t="object"==typeof arguments[1]?Object.assign(arguments[1]):{msg:String(arguments[1])}):(t="object"==typeof arguments[0]?Object.assign(arguments[0]):{msg:String(arguments[0])},r="object"==typeof arguments[1]?Object.assign(arguments[1]):{})}else 3==arguments.length&&(e=arguments[0],t="object"==typeof arguments[1]?Object.assign(arguments[1]):{msg:String(arguments[1])},r="object"==typeof arguments[2]?Object.assign(arguments[2]):{});var o=this._formatEntry(e,t,r);this.transport(o)},_MetricalLogger.prototype.traceStart=function(e,t){this.trace(">>> "+e,t)},_MetricalLogger.prototype.traceEnd=function(e,t){this.trace("<<< "+e,t)},_MetricalLogger.prototype.trace=function(e,t){this.log("trace",e,t)},_MetricalLogger.prototype.debug=function(e,t){this.log("debug",e,t)},_MetricalLogger.prototype.info=function(e,t){this.log("info",e,t)},_MetricalLogger.prototype.warning=function(e,t){this.log("warning",e,t)},_MetricalLogger.prototype.error=function(e,t){this.log("error",e,t)},_MetricalLogger.prototype.fatal=function(e,t){this.log("fatal",e,t)},_MetricalBrowser=function(e){var t={logger:new _MetricalLogger({extra:{module:"browser"}}),fetchFunction:void 0};this.params=Object.assign({},t,e),this.logger=this.params.logger,this.fetchFunction=this.params.fetchFunction?this.params.fetchFunction:this.browserFetchFunction()},_MetricalBrowser.prototype.each=function(e,t){if(null!=e)if(t=t||function(e,t){console.info(`Key: ${e}: Value ${t}`)},"object"==typeof e&&0==Array.isArray(e)){var r=Object.keys(e);for(i=0;i<r.length;i++){var o=r[i];t(o,e[o])}}else for(i=0;i<e.length;i++){var n=e[i];t(i,n)}},_MetricalBrowser.prototype.extend=function(e,...t){return Object.assign(e,...t)},_MetricalBrowser.prototype.browserFetchFunction=function(){return fetch},_MetricalBrowser.prototype.fetch=function(e,t){return this.fetchFunction.apply(null,arguments)},_MetricalBrowser.prototype.fetchSimple=function(e,t){var r=this,i=function(e){if(e.ok)return e;var t=new Error(e.status+" "+e.statusText);throw t.response=e,t},o=function(e){return new Promise(function(t,r){e.text().then(function(e){try{var r=JSON.parse(e);t(r)}catch(r){t(e)}}).catch(function(e){r(e)})})};return new Promise(function(n,a){try{var s=Object.assign({},{mode:"cors",cache:"no-cache"},t||{});r.logger.debug("fetch options",{url:e,options:s}),r.fetch(e,s).then(i).then(o).then(function(t){r.logger.debug("fetch results",{data:t,url:e,options:s}),n(t)}).catch(function(e){r.logger.error("fetch run error",{error:e}),a(e)})}catch(e){r.logger.error("fetch general error",{error:e}),a(e)}})},_MetricalBrowser.prototype.get=function(e,t){var r=Object.assign({},{method:"GET"},t||{});return this.fetchSimple(e,r)},_MetricalBrowser.prototype.post=function(e,t){var r="body"in(t=t||{})?t.body:"";"object"==typeof r&&(r=JSON.stringify(r));var i=Object.assign({},{method:"POST",headers:{"Content-Type":"text/plain"}},t,{body:r});return this.fetchSimple(e,i)},_MetricalBrowser.prototype.sendBeacon=function(e,t){return"object"==typeof t&&(t=JSON.stringify(t)),this.navigator().sendBeacon(e,t)},_MetricalBrowser.prototype.getElement=function(e){return document.querySelector(e)},_MetricalBrowser.prototype.getAllElements=function(e){return document.querySelectorAll(e)},_MetricalBrowser.prototype.hasClass=function(e,t){return(" "+e.className+" ").indexOf(" "+t+" ")>-1},_MetricalBrowser.prototype.getStyle=function(e,t){var r,i=(e.ownerDocument||document).defaultView;return i&&i.getComputedStyle?(t=t.replace(/([A-Z])/g,"-$1").toLowerCase(),i.getComputedStyle(e,null).getPropertyValue(t)):e.currentStyle?(t=t.replace(/\-(\w)/g,function(e,t){return t.toUpperCase()}),r=e.currentStyle[t],/^\d+(em|pt|%|ex)?$/i.test(r)?function(t){var r=e.style.left,i=e.runtimeStyle.left;return e.runtimeStyle.left=e.currentStyle.left,e.style.left=t||0,t=e.style.pixelLeft+"px",e.style.left=r,e.runtimeStyle.left=i,t}(r):r):void 0},_MetricalBrowser.prototype.eventFire=function(e,t){if(e.fireEvent)e.fireEvent("on"+etype);else{var r=document.createEvent("Events");r.initEvent(t,!0,!1),e.dispatchEvent(r)}},_MetricalBrowser.prototype.addEvent=function(e,t,r){e.addEventListener(t,r)},_MetricalBrowser.prototype.removeEvent=function(e,t,r){e.removeEventListener(t,r)},_MetricalBrowser.prototype.window=function(){return window},_MetricalBrowser.prototype.matchMedia=function(e){return window.matchMedia(e)},_MetricalBrowser.prototype.document=function(){return document},_MetricalBrowser.prototype.navigator=function(){return navigator},_MetricalBrowser.prototype.btoa=function(e){return btoa(e)},_MetricalBrowser.prototype.atob=function(e){return atob(e)},_MetricalBrowser.prototype.IntersectionObserver=function(){return IntersectionObserver},_MetricalBrowser.prototype.nodeToString=function(e){for(var t=[],r=0;r<e.attributes.length;r++){var i=e.attributes[r],o=i.name,n=i.value;t.push(o+'="'+n+'"')}return"<"+e.tagName.toLowerCase()+" "+t.join(" ")+">"},_MetricalStorageSync=function(e){var t={storage:_MetricalStorage,utils:_MetricalUtils,browser:new _MetricalBrowser,logger:new _MetricalLogger({extra:{module:"storagesync"}}),endpoint:_MetricalHosts.endpoints.storageSync};this.properties=Object.assign({},t,e||{}),this.browser=this.properties.browser,this.logger=this.properties.logger},_MetricalStorageSync.prototype.sync=function(e,t){var r=this;return new Promise(function(i,o){r.logger.traceStart("sync"),r.logger.debug("inputs",{surveyId:e,uuid:t});try{var n=r.properties.endpoint+"/"+e+"/"+t;r.browser.get(n).then(function(e){r.logger.debug("sync get results",{data:e}),r.properties.storage.import(e),i(!0)}).catch(function(e){r.logger.error("error on sync get call",{error:e}),o(e)}),r.logger.traceEnd("sync")}catch(e){r.logger.error("storage sync error",{error:e,errorMessage:e.message}),o(e)}})},_MetricalStorageSync.prototype.post=function(e,t,r){try{this.browser.sendBeacon(this.properties.endpoint,{surveyId:e,uuid:t,record:r})}catch(e){throw this.logger.error({error:e}),e}},_MetricalValues=function(e){var t={logger:new _MetricalLogger({extra:{module:"api"}})};this.properties=Object.assign({},t,e||{}),this.logger=this.properties.logger},_MetricalValues.prototype.values=function(inputValues){var that=this;return new Promise(function(resolve,reject){try{var parse=function(obj){return new Promise(function(resolve,reject){try{var val=obj.val;val=eval(val.parse),obj.val=val,resolve(obj)}catch(e){var newError=new Error(e.message+": "+JSON.stringify(obj));reject(newError)}})},singleUse=function(e){return new Promise(function(t,r){try{var i=e.val.singleUse;(new _MetricalApi).fetchSingleUseCouponCode({couponId:i}).then(function(r){var i=r.coupon;e.val=i,t(e)}).catch(function(t){var i=new Error(t.message+": "+JSON.stringify(e));r(i)})}catch(t){var o=new Error(t.message+": "+JSON.stringify(e));r(o)}})},timeframe=function(e){return new Promise(function(t,r){try{var i=e.val.timeframe;(new _MetricalApi).fetchTimeframeCouponCode({couponId:i}).then(function(r){var i=r.coupon;e.val=i,t(e)}).catch(function(t){var i=new Error(t.message+": "+JSON.stringify(e));r(i)})}catch(t){var o=new Error(t.message+": "+JSON.stringify(e));r(o)}})};if(inputValues&&"object"==typeof inputValues&&null!==inputValues){var keys=Object.keys(inputValues),temp=keys.map(function(e){var t=inputValues[e],r={key:e,val:t};return"object"==typeof t&&"parse"in t?parse(r):"object"==typeof t&&"singleUse"in t?singleUse(r):"object"==typeof t&&"timeframe"in t?timeframe(r):Promise.resolve(r)});Promise.all(temp).then(function(e){var t=e.reduce(function(e,t){return e[t.key]=t.val,e},{});resolve(t)}).catch(function(e){reject(e)})}else resolve({})}catch(e){reject(e)}})},_MetricalApi=function(e){var t={browser:new _MetricalBrowser,utils:_MetricalUtils,logger:new _MetricalLogger({extra:{module:"api"}}),hosts:_MetricalHosts};this.properties=Object.assign({},t,e||{}),this.browser=this.properties.browser,this.logger=this.properties.logger,this.utils=this.properties.utils,this.hosts=this.properties.hosts},_MetricalApi.prototype.fetchSingleUseCouponCode=function(e){var t=this;return new Promise(function(r,i){try{var o=t.utils.sessionIdentifiers();if(0==!!(e=Object.assign({},o,e)).uuid)throw new Error("uuid is a required input for fetching a single use coupon");if(0==!!e.sessionId)throw new Error("sessionId is a required input for fetching a single use coupon");if(0==!!e.surveyId)throw new Error("surveyId is a required input for fetching a single use coupon");if(0==!!e.couponId)throw new Error("couponId is a required input for fetching a single use coupon");t.logger.debug("fetching single use coupon code",{inputs:e}),t.browser.post(t.hosts.endpoints.singleUseCoupon,{body:e}).then(function(e){t.logger.debug("received single use coupon code",{response:e}),r(e)}).catch(function(e){t.logger.error("Error when fetching single use coupon code",{error:e}),i(e)})}catch(e){t.logger.error("Error in single use coupon code",{error:e}),i(e)}})},_MetricalApi.prototype.fetchTimeframeCouponCode=function(e){var t=this;return new Promise(function(r,i){try{var o=t.utils.sessionIdentifiers();if(0==!!(e=Object.assign({},o,e)).uuid)throw new Error("uuid is a required input for fetching a single use coupon");if(0==!!e.sessionId)throw new Error("sessionId is a required input for fetching a single use coupon");if(0==!!e.surveyId)throw new Error("surveyId is a required input for fetching a single use coupon");if(0==!!e.couponId)throw new Error("couponId is a required input for fetching a single use coupon");t.logger.debug("fetching timeframe coupon code",{inputs:e}),t.browser.post(t.hosts.endpoints.timeframeCoupon,{body:e}).then(function(e){t.logger.debug("received timeframe coupon code",{response:e}),r(e)}).catch(function(e){t.logger.error("Error when fetching timeframe coupon code",{error:e}),i(e)})}catch(e){t.logger.error("Error in timeframe coupon code",{error:e}),i(e)}})},_MetricalEventBus=function(e){var t={logger:new _MetricalLogger({extra:{module:"eventbus"}}),predefinedTopics:{"init/pre":{aliases:[]},"init/post":{aliases:[]}},constants:{topics:{INIT_PRE:"init/pre",INIT_POST:"init/post",ACTION_ADD_TO_CART:"action/add_to_cart",ACTION_REMOVE_FROM_CART:"action/remove_from_cart",ACTION_CLEAR_CART:"action/clear_cart",ACTION_VIEW_CART:"action/view_cart",ACTION_START_CHECKOUT:"action/start_checkout",ACTION_ORDER_PLACED:"action/order_placed",MCART_ADD:"mcart/add",MCART_UPDATE:"mcart/update",MCART_DELETE:"mcart/delete",MCART_CLEAR:"mcart/clear"}}};this.properties=Object.assign({},t,e||{}),this.logger=this.properties.logger,this.topicsData={},this.subscriptions={},this.constants=this.properties.constants;var r=this;Object.keys(this.properties.predefinedTopics).forEach(function(e){var t=r.properties.predefinedTopics[e];r.addTopic(e,t)})},_MetricalEventBus.prototype.topics=function(e){return Object.keys(this.topicsData)},_MetricalEventBus.prototype.topic=function(e){if(e in this.topicsData)return e;var t=this,r=Object.keys(this.topicsData).reduce(function(r,i){return 1==(t.topicsData[i].aliases||[]).includes(e)&&null===r&&(r=i),r},null);return null!==r?r:(t.addTopic(e),e)},_MetricalEventBus.prototype.addTopic=function(e,t){var r=t||[],i=Array.isArray(r)?r:[r];this.topicsData[e]={aliases:i}},_MetricalEventBus.prototype.makeToken=function(e){var t=this.topic(e);return t+"-"+Object.keys(this.subscriptions[t]).length},_MetricalEventBus.prototype.subscribe=function(e,t){var r=this.topic(e);r in this.subscriptions||(this.subscriptions[r]={});var i=this.makeToken(r);return this.subscriptions[r][i]=t,this.logger.debug("subscribe",{topic:r,token:i}),i},_MetricalEventBus.prototype.subscribers=function(e){var t=this.topic(e);return t in this.subscriptions||(this.subscriptions[t]={}),Object.keys(this.subscriptions[t])},_MetricalEventBus.prototype.subscriber=function(e,t){var r=this.topic(e);if(r in this.subscriptions||(this.subscriptions[r]={}),!(t in this.subscriptions[r]))throw new Error("Token "+t+" was not found in topic "+r);return this.subscriptions[r][t]},_MetricalEventBus.prototype.unsubscribe=function(e,t){var r=this.topic(e);return r in this.subscriptions||(this.subscriptions[r]={}),t in this.subscriptions[r]&&delete this.subscriptions[r][t],!0},_MetricalEventBus.prototype.publish=function(e,t){var r=this,i=this.topic(e).split("/").reduce(function(e,t,r,i){for(var o=[],n=0;n<=r;n++)o.push(i[n]);return e.push(o.join("/")),e},[]);i.push("/");var o=0;return i.forEach(function(e){e in r.subscriptions||(r.subscriptions[e]={});var i=r.subscriptions[e];for(var n in i){(0,i[n])(t,{topic:e}),o++}r.logger.debug("publish",{topic:e,payload:t,pubCount:o})}),o},_MetricalUsermeta=function(e){var t={logger:new _MetricalLogger({extra:{module:"usermeta"}}),usermeta:{}};this.properties=Object.assign({},t,e||{}),this.logger=this.properties.logger,this.initUsermeta=this.properties.usermeta,this.providers=[]},_MetricalUsermeta.prototype.new=function(){return Object.assign({},{isloggedin:!1,customerid:null,gender:null,language:null,currency:null,currencyUS:null,zipcode:null,latitude:null,longitude:null,pagetype:null,trafficsource:null,trafficsourcetype:null,accountcreationdate:null,previouspurchasecount:null,previouspurchasevalue:null,itemname:null,itemgender:null,msrpprice:null,itemprice:null,itemsaleprice:null,itemid:null,numskusavailable:null,sku:null,itemstocklife:null,itemvendor:null,itemcategory:null,itemsubcategory:null,isfeatured:null,isitemdeal:null,itemdealpercent:null,itemdealamount:null,isbookmarked:null,couponavailable:null,couponcode:null,coupontext:null,numreviews:null,customerrating:null,isloyaltyprogrammember:null,loyaltyprogramnumber:null,numimages:null,itemimages:null,itemfeaturedimage:null,numuniqueitemsincart:0,totalnumitemsincart:0,cartidlist:null,cartskulist:null,cartqtylist:null,cartpricelist:null,isgift:null,cartid:null,isresidentialdelivery:null,isbusinessdelivery:null,deliverydate:null,subtotalcartvalue:0,tax:0,discountedshipping:null,shippingcost:null,discountsapplied:null,discountvalue:0,totalcartvalue:0,orderid:null,ispurchase:!1,paymentmethod:null,shippingtmethod:null,shippingmethodcost:null,billaddress:null,billcity:null,billstate:null,billzip:null,billcountry:null,shipdifferentthanbill:null,shipaddress:null,shipcity:null,shipstate:null,shipzip:null,shipcountry:null})},_MetricalUsermeta.prototype.add=function(e,t){void 0===t&&(t="replace"),0==this.providers.includes({provider:e,behavior:t})&&this.providers.push({provider:e,behavior:t})},_MetricalUsermeta.prototype.get=function(e){var t=this.all();return e in t?t[e]:null},_MetricalUsermeta.prototype.all=function(){var e=this,t=Object.assign({},e.initUsermeta);return e.logger.debug("initial usermeta",{usermeta:t}),e.providers.forEach(function(r){var i=r.provider,o=r.behavior||"replace",n={};("function"==typeof i?n=Object.assign({},i()):"object"==typeof i&&null!==i&&(n=Object.assign({},i)),"replaceIfEmpty"==o)&&Object.keys(n).forEach(function(r){null!==t[r]&&(delete n[r],e.logger.debug("removing "+r+" because it is present in usermeta"))});e.logger.debug("added usermeta",{usermeta:n}),t=Object.assign({},t,n),e.logger.debug("adjusted usermeta",{usermeta:t})}),e.logger.debug("final usermeta",{usermeta:t}),t},_MetricalUsermeta.prototype.parse=function(e){return _MetricalUtils.evaluateObject(e)},_MetricalPageType=function(e){var t={logger:new _MetricalLogger,usermeta:void 0,config:{pagetype:{isactive:!1,types:{Home:[],CLP:[],PLP:[],PDP:[],Landing:[],Search:[],Content:[],Other:[],Account:[],Cart:[],Checkout:[],"Order Confirmation":[]}}},utils:_MetricalUtils,pageType:null};this.params=Object.assign({},t,e)},_MetricalPageType.prototype.run=function(){let e=this;if(e.params.config.pagetype.isactive)return Object.entries(e.params.config.pagetype.types).forEach(t=>{t[1].length>0&&t[1].forEach(r=>{this.params.utils.evaluate(r)&&(e.params.pageType={[t[0]]:r})})}),e.params.pageType&&(e.params.usermeta.add({pagetype:Object.keys(e.params.pageType)[0]}),e.params.logger.debug("PageType found",e.params.pageType)),e.params.pageType},_MetricalCouponDriverBase=function(e){var t={metricalCoupon:void 0,browser:new _MetricalBrowser,logger:new _MetricalLogger({extra:{module:"coupon"}})};if(this.properties=Object.assign({},t,e||{}),this.browser=this.properties.browser,this.logger=this.properties.logger,0==!!this.properties.metricalCoupon){var r=new Error("metricalCoupon is a required property");throw this.logger.error({error:r}),r}this.metricalCoupon=this.properties.metricalCoupon,this.properties.forceredirect="forceredirect"in this.properties&&this.properties.forceredirect,this.values={}},_MetricalCouponDriverBase.prototype.sessionIdentifiers=function(){return{surveyId:_MetricalAbandonCart.Config.surveyid,uuid:_MetricalIdentity.getDeviceId(),sessionId:_MetricalIdentity.getSessionId()}},_MetricalCouponDriverBase.prototype.fetchSingleUseCouponCode=function(e){return new Promise(function(t,r){(new _MetricalApi).fetchSingleUseCouponCode(e).then(function(e){t(e)}).catch(function(e){r(e)})})},_MetricalCouponDriverBase.prototype.prepareValues=function(){var e=this;return new Promise(function(t,r){(new _MetricalValues).values(e.properties.values).then(function(r){e.values=r,t(r)}).catch(function(e){r(e)})})},_MetricalCouponDriverBase.prototype.doExecute=function(){this.logger.error("doExecute was not overridden")},_MetricalCouponDriverBase.prototype.execute=function(e){var t=this;return e=void 0!==e?e:{},new Promise(function(r,i){try{t.logger.traceStart("driver base execute"),t.prepareValues().then(function(r){return t.logger.debug("prepared values",{valueResult:r}),t.doExecute(e)}).then(function(e){t.logger.debug("doExecute completed",{doExecuteResult:e}),r(e)}).catch(function(e){i(e)}),t.logger.traceEnd("driver base execute")}catch(e){i(e)}})},_MetricalCouponDriverBase.prototype.redirect=function(e){this.logger.debug("Performing redirect",{target:e}),this.browser.window().location.href==e&&1!=this.properties.forceredirect||(this.browser.window().location.href=e)},_MetricalCouponDriverBase.prototype._template=function(e,t){if(t="object"==typeof t?t:this.values,"string"!=typeof e)return e;for(var r in t){var i="{{"+r+"}}";e=e.replace(i,t[r])}return e},_MetricalCouponDriverActions=function(e){if(_MetricalCouponDriverBase.call(this,e),this.logger.traceStart("actions constructor"),0==!!this.properties.actions)throw new Error("ActionsDriver expects a actions parameter");if(0==Array.isArray(this.properties.actions))throw new Error("FetchDriver expects actions to be an array");this.logger.traceEnd("actions constructor")},_MetricalCouponDriverActions.prototype=Object.create(_MetricalCouponDriverBase.prototype),_MetricalCouponDriverActions.prototype.constructor=_MetricalCouponDriverActions,_MetricalCouponDriverActions.prototype.doExecute=function(){var e=this;return new Promise(function(t,r){try{e.logger.traceStart("actions execute");var i=e.properties.actions.map(function(t){return e.properties.metricalCoupon.driver(t.coupondriver,t)});e.logger.debug("drivers",{drivers:i});var o=[],n=Promise.resolve();i.forEach(function(t){n=n.then(function(){return t.execute()}).then(function(t){return e.logger.debug("driver result",{driverResult:t}),o.push(t),t}).catch(function(e){r(e)})}),n.then(function(r){e.logger.debug("sequence result",{result:r}),e.properties.redirecturl?(e.redirect(e._template(e.properties.redirecturl)),e.logger.debug("fetch driver final result"),t(!0)):t(!0)}).catch(function(e){r(e)}),e.logger.traceEnd("actions execute")}catch(t){e.logger.error({error:t}),r(t)}})},_MetricalCouponDriverApplier=function(e){if(_MetricalCouponDriverBase.call(this,e),0==!!this.properties.values)throw new Error("ApplierDriver expects a value property");if(0==!!this.properties.values.applier)throw new Error("ApplierDriver expects a value.applier property");if(0==!!this.properties.values.urlfilter)throw new Error("ApplierDriver expects a value.urlfilter property")},_MetricalCouponDriverApplier.prototype=Object.create(_MetricalCouponDriverBase.prototype),_MetricalCouponDriverApplier.prototype.constructor=_MetricalCouponDriverApplier,_MetricalCouponDriverApplier.prototype.doExecute=function(){var e=this;return new Promise(function(t,r){try{e.logger.traceStart("execute");var i=Object.assign({},e.values||{});e.logger.debug("applier object",{obj:i});var o=encodeURIComponent(e.browser.btoa(JSON.stringify(i)));e.logger.debug("applier payload",{payload:o}),_MetricalAbandonCart.storage.setItem("payload",o,{expiresAfter:1800}),e.properties.redirecturl?(e.redirect(e._template(e.properties.redirecturl)),t(o)):t(o),e.logger.traceEnd("execute")}catch(t){e.logger.error({error:t}),r(t)}})},_MetricalCouponDriverCallBridge=function(e){if(_MetricalCouponDriverBase.call(this,e),0==!!this.properties.callbackEndpoint)throw new Error("CallBridgeDriver needs callbackEndpoint defined")},_MetricalCouponDriverCallBridge.prototype=Object.create(_MetricalCouponDriverBase.prototype),_MetricalCouponDriverCallBridge.prototype.constructor=_MetricalCouponDriverCallBridge,_MetricalCouponDriverCallBridge.prototype.doExecute=function(e){var t=this;return e=void 0!==e?e:{},new Promise(function(r,i){t.logger.traceStart("execute"),t.logger.debug("callbridge inputs",{inputs:e}),"phoneNumber"in e||i("phoneNumber needs to be provided to CallBridgeDriver.execute()");var o={body:{phone:e.phoneNumber}};t.logger.debug("callbridge fetch params",{params:o}),t.browser.post(t.properties.callbackEndpoint,o).then(function(e){t.logger.debug("callbridge results",{data:e}),t.properties.redirecturl?(t.redirect(t._template(t.properties.redirecturl)),r(e)):r(e)}).catch(function(e){t.logger.error("callbridge error",{error:e}),i(e)}),t.logger.traceEnd("execute")})},_MetricalCouponDriverEval=function(e){if(_MetricalCouponDriverBase.call(this,e),0==!!this.properties.statements)throw new Error("EvalDriver expects either a string or array of strings containing statements to run")},_MetricalCouponDriverEval.prototype=Object.create(_MetricalCouponDriverBase.prototype),_MetricalCouponDriverEval.prototype.constructor=_MetricalCouponDriverEval,_MetricalCouponDriverEval.prototype.doExecute=function(){var that=this;return new Promise(function(resolve,reject){try{var statements=1==Array.isArray(that.properties.statements)?that.properties.statements:[that.properties.statements],result=statements.reduce(function(acc,statement,index){var previousValue=acc.length>0?acc[acc.length-1]:void 0;statement=that._template(statement),that.logger.debug("evaluating statement",{statement:statement,currentIndex:index,accumulation:acc,previousValue:previousValue});try{var val=eval(statement)}catch(e){throw that.logger.error("evaluation error",{currentStatement:statement,currentIndex:index,accumulation:acc,previousValue:previousValue,statements:statements}),e}return that.logger.debug("evaulation value",{statement:statement,val:val}),acc.push(val),acc},[]);that.properties.redirecturl?(that.redirect(that._template(that.properties.redirecturl)),resolve(result)):resolve(result)}catch(e){that.logger.error({error:e}),reject(e)}})},_MetricalCouponDriverFetch=function(e){if(_MetricalCouponDriverBase.call(this,e),this.logger.traceStart("fetch constructor"),0==!!this.properties.couponoperations)throw new Error("FetchDriver expects a couponoperations parameter");if(0==Array.isArray(this.properties.couponoperations))throw new Error("FetchDriver expects couponoperations to be an array");this.logger.traceEnd("fetch constructor")},_MetricalCouponDriverFetch.prototype=Object.create(_MetricalCouponDriverBase.prototype),_MetricalCouponDriverFetch.prototype.constructor=_MetricalCouponDriverFetch,_MetricalCouponDriverFetch.prototype.doExecute=function(){var e=this;return new Promise(function(t,r){try{e.logger.traceStart("fetch doExecute");var i=Promise.resolve({status:200,statusText:"OK"});e.properties.couponoperations.reduce(function(t,r){var i=e._template(r.url),o=r.params||{},n=_MetricalUtils.applyFunctionToObject(o,function(t){return e._template(t)});return t.then(function(t){return e.logger.debug("Fetch driver result",{status:t.status,statusText:t.statusText}),e.logger.debug("Fetch driver params",{url:i,params:n}),e.browser.fetch(i,n)})},i).then(function(r){e.logger.debug("Fetch driver result",{status:r.status,statusText:r.statusText}),e.properties.redirecturl?(e.redirect(e._template(e.properties.redirecturl)),e.logger.debug("fetch driver final result"),t(!0)):t(!0)}).catch(function(t){e.logger.error("Fetch driver errors",{error:t}),r(t)}),e.logger.traceEnd("fetch doExecute")}catch(t){e.logger.error({error:t}),r(t)}})},_MetricalCouponDriverJcp=function(e){if(_MetricalCouponDriverBase.call(this,e),0==!!this.properties.couponcode)throw new Error("JcpDriver expects a couponcode parameter");this.properties.singleuse="singleuse"in this.properties&&this.properties.singleuse},_MetricalCouponDriverJcp.prototype=Object.create(_MetricalCouponDriverBase.prototype),_MetricalCouponDriverJcp.prototype.constructor=_MetricalCouponDriverJcp,_MetricalCouponDriverJcp.prototype.doExecute=function(){var e=this;return new Promise(function(t,r){try{var i=Array.isArray(e.properties.couponcode)?e.properties.couponcode:[e.properties.couponcode],o=e.properties.singleuse?e.fetchSingleUseCouponCode:e.normalCode,n={uuid:_MetricalIdentity.getDeviceId(),sessionId:_MetricalIdentity.getSessionId(),surveyId:_MetricalAbandonCart.Config.surveyid,couponId:i},a=[],s=[];o.call(e,n).then(function(t){s=Array.isArray(t.coupon)?t.coupon:[t.coupon];var r={couponCode:i[0],serialCode:s[0]||null};return e.applyCode(r)}).then(function(t){if(a.push(t),i.length>1){var r={couponCode:i[1],serialCode:s[1]||null};return e.applyCode(r)}return Promise.resolve(!0)}).then(function(r){a.push(r),1==a.includes(!1)?(e.renderOfferError({couponcode:i.join(", "),killcode:s.join(", ")}),t(!1)):(e.customRedirect(),t(!0))}).catch(function(t){e.logger.error("JCP coupon fetch error",{error:t}),r(t)})}catch(t){e.logger.error({error:t}),r(t)}})},_MetricalCouponDriverJcp.prototype.normalCode=function(e){return new Promise(function(e,t){try{e({success:!0,coupon:null})}catch(e){t(e)}})},_MetricalCouponDriverJcp.prototype.applyCode=function(e){var t=this;return new Promise(function(r,i){try{t.logger.traceStart("applyCode"),t.browser.window().handleVendorAction("apply_coupon",e,function(e){t.logger.debug("JCP applyCode",{status:e}),r("error"!=e&&0!=e)}),t.logger.traceEnd("applyCode")}catch(e){t.logger.error("JCP apply code error",{error:e}),i(e)}})},_MetricalCouponDriverJcp.prototype.customRedirect=function(){var e=this.properties.redirecturl||null;e&&(this.browser.window().location.href!=e||1==this.properties.forceredirect?this.browser.window().location.href=e:this.browser.window().location.reload())},_MetricalCouponDriverJcp.prototype.renderOfferError=function(e){var t=_MetricalAbandonCart.Config.views.couponerror;t.viewconfig.textblocks[0].tagreplacements.COUPON=e.couponcode,t.viewconfig.textblocks[0].tagreplacements.SERIAL=e.killcode,new _MetricalOfferViewV2({view:t,config:_MetricalAbandonCart.Config}).render(),_MetricalACInteractions.recordInteraction("couponerror")},_MetricalCouponDriverRedirect=function(e){if(_MetricalCouponDriverBase.call(this,e),0==!!this.properties.redirecturl)throw new Error("RedirectDriver expects a redirecturl parameter")},_MetricalCouponDriverRedirect.prototype=Object.create(_MetricalCouponDriverBase.prototype),_MetricalCouponDriverRedirect.prototype.constructor=_MetricalCouponDriverRedirect,_MetricalCouponDriverRedirect.prototype.doExecute=function(){var e=this;return new Promise(function(t,r){try{e.redirect(e._template(e.properties.redirecturl)),t(!0)}catch(t){e.logger.error({error:t}),r(t)}})},_MetricalCouponDriverShopifyRecharge=function(e){_MetricalCouponDriverBase.call(this,e),this.properties.carturl=this.properties.carturl?this.properties.carturl:"/cart.js",this.properties.values=this.properties.values?this.properties.values:{},this.properties.shopify=this.properties.shopify?this.properties.shopify:{},this.properties.recharge=this.properties.recharge?this.properties.recharge:{}},_MetricalCouponDriverShopifyRecharge.prototype=Object.create(_MetricalCouponDriverBase.prototype),_MetricalCouponDriverShopifyRecharge.prototype.constructor=_MetricalCouponDriverShopifyRecharge,_MetricalCouponDriverShopifyRecharge.prototype.doExecute=function(e){var t=this;return new Promise(function(e,r){try{var i=t._template(t.properties.carturl);t.browser.get(i).then(function(e){console.log(e);var t=function(e){return items="items"in e&&Array.isArray(e.items)?e.items:[],items.reduce(function(e,t){return"properties"in t&&"object"==typeof t.properties&&null!==t.properties&&"shipping_interval_frequency"in t.properties&&(e=!0),e},!1)}(e);return console.log(t),t?Promise.resolve("recharge"):Promise.resolve("shopify")}).then(function(e){return function(e,r,i){return new Promise(function(o,n){if("discounturl"in r){var a=t._template(r.discounturl,i);t.browser.get(a).then(function(t){o(e,!0)}).catch(function(e){n(new Error("Response to discount url "+a+" failed"))})}else o(e,!0)})}(e,t.properties[e],t.values)}).then(function(e){return function(e,r,i){return new Promise(function(o,n){if("redirecturl"in r){var a=t._template(r.redirecturl,i);t.redirect(a),o(e,!0)}else o(e,!0)})}(e,t.properties[e],t.values)}).then(function(t){e(t)}).catch(function(e){r(e)})}catch(e){t.logger.error({error:e}),r(e)}})},_MetricalCouponDriverApplyCoupon=function(e){if(_MetricalCouponDriverBase.call(this,e),0==!!this.properties.applytype)throw new Error("ApplyCouponDriver expects an applytype parameter");if(0==!!this.properties.values)throw new Error("ApplyCouponDriver expects a values parameter")},_MetricalCouponDriverApplyCoupon.prototype=Object.create(_MetricalCouponDriverBase.prototype),_MetricalCouponDriverApplyCoupon.prototype.constructor=_MetricalCouponDriverApplyCoupon,_MetricalCouponDriverApplyCoupon.prototype.doExecute=function(){var e=this;return new Promise(function(t,r){var i=Object.assign({},e.sessionIdentifiers(),{type:e.properties.applytype,params:e.values}),o=_MetricalHosts.endpoints.coupon;e.browser.fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(function(r){r.ok?e.properties.redirecturl?(e.redirect(e._template(e.properties.redirecturl)),t(!0)):t(!0):t(!1)}).catch(function(e){r(e)})})},_MetricalOperationBase=function(e){var t={browser:new _MetricalBrowser,utils:_MetricalUtils,logger:new _MetricalLogger({extra:{module:"operation"}})};this.properties=Object.assign({},t,e||{}),this.browser=this.properties.browser,this.logger=this.properties.logger,this.utils=this.properties.utils},_MetricalOperationEval=function(e){if(_MetricalOperationBase.call(this,e),0==!!this.properties.statements)throw new Error("Eval Operations expects either a string or array of strings containing statements to run")},_MetricalOperationEval.prototype=Object.create(_MetricalOperationBase.prototype),_MetricalOperationEval.prototype.constructor=_MetricalOperationEval,_MetricalOperationEval.prototype.execute=function(values){var that=this;return new Promise(function(resolve,reject){try{var statements=1==Array.isArray(that.properties.statements)?that.properties.statements:[that.properties.statements],result=statements.reduce(function(acc,statement,index){var previousValue=acc.length>0?acc[acc.length-1]:void 0,statementKey="_statement"+(index-1),obj={};obj[statementKey]=previousValue;var tempValues=void 0!==previousValue?Object.assign({},values,obj):values;statement=that.utils.template(statement,tempValues),that.logger.debug("evaluating statement",{statement:statement,currentIndex:index,accumulation:acc,previousValue:previousValue});try{var val=eval(statement)}catch(e){throw that.logger.error("evaluation error",{currentStatement:statement,currentIndex:index,accumulation:acc,previousValue:previousValue,statements:statements}),e}return that.logger.debug("evaulation value",{statement:statement,val:val}),acc.push(val),acc},[]);0==result.length?resolve(null):1==result.length?resolve(result[0]):resolve(result)}catch(e){that.logger.error({error:e}),reject(e)}})},_MetricalOperationFetch=function(e){if(_MetricalOperationBase.call(this,e),0==!!this.properties.fetchoperations)throw new Error("Fetch Operation expects a fetchoperations parameter");if(0==Array.isArray(this.properties.fetchoperations))throw new Error("Fetch Operation expects fetchoperations to be an array")},_MetricalOperationFetch.prototype=Object.create(_MetricalOperationBase.prototype),_MetricalOperationFetch.prototype.constructor=_MetricalOperationFetch,_MetricalOperationFetch.prototype.execute=function(e){var t=this;return new Promise(function(r,i){try{t.logger.traceStart("fetch operation execute");var o=t.properties.fetchoperations.map(function(r){var i=t.utils.template(r.url,e),o=r.params||{},n=t.utils.applyFunctionToObject(o,function(r){return t.utils.template(r,e)});return t.logger.debug("fetchSimple parameters",{url:i,params:n}),t.browser.fetchSimple.bind(t.browser,i,n)});t.utils.promiseSequence(o).then(function(e){t.logger.debug("fetchResults",{fetchResults:e}),r(e)}).catch(function(e){i(e)}),t.logger.traceEnd("fetch operation execute")}catch(e){t.logger.error({error:e}),i(e)}})},_MetricalOperationSubscribe=function(e){if(_MetricalOperationBase.call(this,e),0==!!this.properties.type)throw new Error("Subscribe Operation expects a type property");if(0==!!this.properties.engine)throw new Error("Subscribe Operation expects an engine property")},_MetricalOperationSubscribe.prototype=Object.create(_MetricalOperationBase.prototype),_MetricalOperationSubscribe.prototype.constructor=_MetricalOperationSubscribe,_MetricalOperationSubscribe.prototype.execute=function(e){var t=this;return new Promise(function(r,i){try{var o=Object.assign({},e||{},{type:t.properties.type,engine:t.properties.engine});0==!!o.uuid&&i(new Error("Subscribe Opration requires a uuid to be defined")),0==!!o.sessionId&&i(new Error("Subscribe Opration requires a sessionId to be defined")),0==!!o.surveyId&&i(new Error("Subscribe Opration requires a surveyId to be defined")),0==!!o.engagement&&i(new Error("Subscribe Opration requires an engagement to be defined")),0==!!o.data&&i(new Error("Subscribe Opration requires a data object to be defined")),t.browser.post(_MetricalHosts.endpoints.subscribe,{body:o}).then(function(e){t.logger.debug("subscribe post results",{results:e}),r(e)}).catch(function(e){t.logger.error("subscribe post error",{error:e}),i(e)})}catch(e){t.logger.error({error:e}),i(e)}})},_MetricalOperationRedirect=function(e){if(_MetricalOperationBase.call(this,e),0==!!this.properties.redirecturl)throw new Error("Redirect Operation expects a redirecturl parameter")},_MetricalOperationRedirect.prototype=Object.create(_MetricalOperationBase.prototype),_MetricalOperationRedirect.prototype.constructor=_MetricalOperationRedirect,_MetricalOperationRedirect.prototype.execute=function(e){var t=this;return new Promise(function(r,i){try{t.logger.traceStart("redirect operation execute");var o=t.properties.utils.template(t.properties.redirecturl,e),n=t.properties.forceReloadOnSamePage||!1,a=t.properties.newtab||!1,s=t.browser.window(),c=!0;s.location.href==o&&0==n&&(c=!1),r({redirectUrl:o,willReload:c}),t.logger.traceEnd("redirect operation execute"),c&&!a?s.location.href=o:s.open(o,"_blank")}catch(e){t.logger.error({error:e}),i(e)}})},_MetricalOperationCloseView=function(e){if(_MetricalOperationBase.call(this,e),0==!!this.properties.bus)throw new Error("_MetricalOperationCloseView expects a bus parameter");this.properties.topic=this.properties.topic||"view/close"},_MetricalOperationCloseView.prototype=Object.create(_MetricalOperationBase.prototype),_MetricalOperationCloseView.prototype.constructor=_MetricalOperationCloseView,_MetricalOperationCloseView.prototype.execute=function(e){var t=this;return new Promise(function(r,i){try{t.logger.traceStart("closeview operation execute"),t.properties.bus.publish(t.properties.topic,{closedView:!0,values:e}),r({closedView:!0}),t.logger.traceEnd("closeview operation execute")}catch(e){t.logger.error({error:e}),i(e)}})},_MetricalOperationRecordOfferflow=function(e){if(_MetricalOperationBase.call(this,e),0==!!this.properties.offerflow)throw new Error("_MetricalOperationRecordOfferflow expects an offerflow parameter");if(0==!!this.properties.status)throw new Error("_MetricalOperationRecordOfferflow expects a status parameter")},_MetricalOperationRecordOfferflow.prototype=Object.create(_MetricalOperationBase.prototype),_MetricalOperationRecordOfferflow.prototype.constructor=_MetricalOperationRecordOfferflow,_MetricalOperationRecordOfferflow.prototype.execute=function(e){var t=this;return new Promise(function(e,r){try{t.logger.traceStart("recordofferflow operation execute");var i=t.properties.status;t.properties.offerflow.response(i),e({recordOfferflow:!0,status:i}),t.logger.traceEnd("recordofferflow operation execute")}catch(e){t.logger.error({error:e}),r(e)}})},_MetricalOperationJcpCoupon=function(e){if(_MetricalOperationBase.call(this,e),0==!!this.properties.bus)throw new Error("_MetricalOperationJcpCoupon expects a bus parameter");this.vendorFunctionName=this.properties.vendorfunctionname?this.properties.vendorfunctionname:"apply_coupon",this.couponmap=this.properties.couponmap&&Array.isArray(this.properties.couponmap)?this.properties.couponmap:[["couponcode","serial"]]},_MetricalOperationJcpCoupon.prototype=Object.create(_MetricalOperationBase.prototype),_MetricalOperationJcpCoupon.prototype.constructor=_MetricalOperationJcpCoupon,_MetricalOperationJcpCoupon.prototype.execute=function(e){var t=this;return new Promise(function(r,i){try{t.logger.traceStart("jcpcoupon operation execute");var o=t.couponmap.map(function(r){var i=r[0],o=r[1],n={couponCode:e[i]||null,serialCode:e[o]||null};return t.applyCode.bind(t,n)});t.utils.promiseSequence(o).then(function(e){t.logger.debug("apply results",{promiseResults:e}),r(e)}).catch(function(e){i(e)}),t.logger.traceEnd("jcpcoupon operation execute")}catch(e){t.logger.error({error:e}),i(e)}})},_MetricalOperationJcpCoupon.prototype.applyCode=function(e){var t=this;return new Promise(function(r,i){try{t.logger.traceStart("applyCode"),t.browser.window().handleVendorAction(t.vendorFunctionName,e,function(i){t.logger.debug("JCP applyCode",{payload:e,status:i}),r("error"==i||0==i?Object.assign({},e,{success:!1}):Object.assign({},e,{success:!0}))}),t.logger.traceEnd("applyCode")}catch(e){t.logger.error("JCP apply code error",{error:e}),i(e)}})},_MetricalViewBase=function(e){var t={bus:void 0,view:void 0,browser:new _MetricalBrowser,utils:_MetricalUtils,logger:new _MetricalLogger({extra:{module:"view"}}),cssContainerId:"Metrical_container_css",closeTopic:"view/close",deviceMediaCondition:"screen and (min-width: 601px)",eventSelector:null,textReplacements:{}};if(this.properties=Object.assign({},t,e||{}),0==!!this.properties.bus)throw new Error("_MetricalViewBase expects a bus parameter to be set.");if(0==!!this.properties.view)throw new Error("_MetricalViewBase expects a view parameter to be set.");this.browser=this.properties.browser,this.logger=this.properties.logger,this.utils=this.properties.utils,this.bus=this.properties.bus,this.view=this.properties.view;var r=this.view.inputProperties||{};this.properties=Object.assign({},this.properties,r),this.additionalInfoIsOpen=!1},_MetricalViewBase.prototype.render=function(){var e=this;return new Promise(function(t,r){try{e.loadAssets().then(function(t){return e.logger.debug("load asset results",{loadResult:t}),e.attachStyles()}).then(function(t){return e.logger.debug("attach styles results",{stylesResult:t}),e.doRender()}).then(function(r){e.logger.debug("doRender results",{doRenderResults:r}),e.bus.subscribe(e.properties.closeTopic,function(){e.close()}),t(r)}).catch(function(t){e.logger.error("view render error",{error:t}),r(t)})}catch(e){r(e)}})},_MetricalViewBase.prototype.doRender=function(){throw new Error("_MetricalViewBase.doRender() needs to be overridden")},_MetricalViewBase.prototype.close=function(){return new Promise(function(e,t){e(!0)})},_MetricalViewBase.prototype.loadAssets=function(){var e=this;return new Promise(function(t,r){"assets"in e.view?(e.logger.debug("view assets",{assets:e.view.assets}),(new _MetricalAssets).load(e.view.assets).then(function(e){t(e.length)}).catch(function(t){e.logger.error("asset loader error",{error:t}),r(t)})):t(0)})},_MetricalViewBase.prototype.attachStyles=function(){var e=this;return new Promise(function(t,r){try{if("style"in e.view||"styles"in e.view){var i=e.properties.cssContainerId,o=e.browser.document();if(null===o.getElementById(i)){var n=e.view.style||e.view.styles||[],a=e.view.desktopStyle||e.view.desktopStyles||[],s=o.createElement("style");s.id=i;var c=Array.isArray(n)?n:[n],l=Array.isArray(a)?a:[a];l.unshift("@media only "+e.properties.deviceMediaCondition+" {"),l.push("}"),s.appendChild(o.createTextNode(c.join("\n"))),s.appendChild(o.createTextNode(l.join("\n"))),o.getElementsByTagName("head")[0].appendChild(s),t(c.length)}else t(0)}else t(0)}catch(e){r(e)}})},_MetricalViewBase.prototype.objectVal=function(e,t,r){var i=this.utils.get(e,t,r);if(this.logger.debug("objectVal",{obj:e,path:t,val:i}),void 0===i&&void 0===r)throw new Error("objectVal could not find property in "+t);return i},_MetricalViewBase.prototype.device=function(){return this.browser.matchMedia(this.properties.deviceMediaCondition).matches?"desktop":"mobile"},_MetricalViewBase.prototype.replaceContent=function(e,t){var r=this.browser.document(),i=(Array.isArray(t),t).join("\n");r.querySelector(e).innerHTML=this.utils.template(i,this.properties.textReplacements)},_MetricalViewBase.prototype.modifyDOM=function(){let e=this;e.view.delete&&e.view.delete.map(t=>e.removeChildren(t)),e.view.replace&&e.view.replace.map(t=>e.replaceContent(t.selector,t.content))},_MetricalViewBase.prototype.removeChildren=function(e){var t=this.browser.document().querySelector(e);t.parentElement.removeChild(t)},_MetricalViewBase.prototype.makeInnerHtml=function(e,t){try{var r=this.browser.document();if("html"in t){var i=(Array.isArray(t.html)?t.html:[t.html]).join("\n");e.innerHTML=this.utils.template(i,this.properties.textReplacements)}if("js"in t){var o=Array.isArray(t.js)?t.js:[t.js];if(o.length>0){var n=o.join("\n"),a=r.createElement("script");a.innerHTML=this.utils.template(n,this.properties.textReplacements),e.appendChild(a)}}return e}catch(e){throw this.logger.error(e),e}},_MetricalViewBase.prototype.setupEvents=function(){var e=this,t=[];e.properties.eventSelector?e.browser.document().querySelectorAll(e.properties.eventSelector).forEach(function(r){var i=r.dataset.event,o=r.dataset.payload||null;e.utils.isJson(o)&&(o=JSON.parse(o));var n=i.split("/"),a=2==n.length?n[0]:"click";r.addEventListener(a,function(t){e.bus.publish(i,{event:t,payload:o})}),t.push(i)}):e.logger.warning("setupEvents in _MetricalViewBase was called but eventSelector was null");return t},_MetricalViewHtmlLightBox=function(e){_MetricalViewBase.call(this,Object.assign({},{bodySelector:"body",lightBoxClass:"Metrical_LightBox",lightBoxContentClass:"Metrical_LightBoxContent",hideClass:"Metrical_hide",showClass:"Metrical_show",viewPageClass:"Metrical_ViewPage",additionalInfoTopic:"click/additionalinfo",additionalInfoClass:"Metrical_AdditionalInfo",additionalInfoChevronClass:"Metrical_Chevron",additionalInfoSlideInClass:"MetricalSlideIn",additionalInfoSlideOutClass:"MetricalSlideOut",formSelector:".Metrical_ViewPage form",selectControlSelector:".Metrical_ViewPage form select",inputControlSelector:".Metrical_ViewPage form input",disabledToggleSelector:".Metrical_ViewPage form *[data-toggle-disabled-from-validation]",navSelector:".Metrical_ViewPage *[data-nav]",eventSelector:".Metrical_ViewPage *[data-event]",loadingOnClickSelector:".Metrical_ViewPage *[data-loading-on-click]",defaultPage:"index",ellipsisHtml:'<div class="Metrical-lds-ellipsis"><div></div><div></div><div></div><div></div></div>'},e||{})),this.additionalInfoIsOpen=!1,this.contentEl=null,this.currentPageKey=null,this.data=null},_MetricalViewHtmlLightBox.prototype=Object.create(_MetricalViewBase.prototype),_MetricalViewHtmlLightBox.prototype.constructor=_MetricalViewHtmlLightBox,_MetricalViewHtmlLightBox.prototype.renderSlideOffer=function(){this.browser.document()},_MetricalViewHtmlLightBox.prototype.doRender=function(){var e=this;return new Promise(function(t,r){try{var i=e.browser.document(),o=i.createElement("div");o.classList.add(e.properties.lightBoxClass);var n=i.createElement("div");n.classList.add(e.properties.lightBoxContentClass),e.contentEl=n;var a=e.renderContent();(a=Array.isArray(a)?a:[a]).forEach(function(e){n.appendChild(e)}),e.setupOverlayEvents(n),e.setupOverlays(n),o.appendChild(n),e.setupAdditionalInfo(o),e.attachLightbox(o),e.modifyDOM(),e.properties.defaultPage&&e.navigate(e.properties.defaultPage);var s=e.setupEvents();e.logger.debug("registered topics",{topics:s});var c=e.setupNavigation();if(e.logger.debug("navigation targets",{navTargets:c}),e.setupForms(),e.setupControlMonitoring(),e.setupLoadingOnClick(),e.setupResizeMonitoring(),"slideout"===e.view.display){n.classList.add(`Metrical-Slideout-${e.view.slideout.side}`),e.renderSlideOffer(),o.removeChild(i.querySelector(`.${e.properties.additionalInfoClass}`)),i.querySelector(`.${e.properties.viewPageClass}`).appendChild(e._makeAdditionalInfoEl(i))}t(!0)}catch(t){e.logger.error(t),r(t)}})},_MetricalViewHtmlLightBox.prototype.attachLightbox=function(e){this.browser.document().querySelector(this.properties.bodySelector).appendChild(e)},_MetricalViewHtmlLightBox.prototype.showLoader=function(){var e=this;return new Promise(function(t,r){try{var i=e.browser.document(),o=i.createElement("div");o.classList.add("MetricalLoader");var n=i.createElement("div");n.classList.add("loader"),n.classList.add("--1"),o.appendChild(n),e.contentEl.appendChild(o),t()}catch(e){r(e)}})},_MetricalViewHtmlLightBox.prototype.removeLoader=function(){var e=this;return new Promise(function(t,r){try{var i=e.browser.document().querySelector(".MetricalLoader");i&&i.remove(),t()}catch(e){r(e)}})},_MetricalViewHtmlLightBox.prototype.renderContent=function(){this.browser.document();var e=this.properties.view.pages||{},t=[];for(var r in e){var i=this.renderPage(r,e[r]);t.push(i)}return t},_MetricalViewHtmlLightBox.prototype.close=function(){var e=this;return new Promise(function(t,r){var i=e.browser.document().querySelector("."+e.properties.lightBoxClass);i&&i.remove(),t(!0)})},_MetricalViewHtmlLightBox.prototype.setupControlMonitoring=function(){var e=this,t=e.browser.document();t.querySelectorAll(e.properties.selectControlSelector).forEach(function(t){e.logger.debug("monitoring control changes",{controlEl:t}),t.addEventListener("change",e.handleControlChange.bind(e))}),t.querySelectorAll(e.properties.inputControlSelector).forEach(function(t){e.logger.debug("monitoring control changes",{controlEl:t}),t.addEventListener("input",e.handleControlChange.bind(e))})},_MetricalViewHtmlLightBox.prototype.handleControlChange=function(){var e=this.browser.document(),t=this.browser.window(),r=e.querySelectorAll(this.properties.formSelector);this.logger.debug("control change forms",{formElements:r});var i={},o=[];(r.forEach(function(e,r){var n=e.id||e.name||r;if(null!==e.offsetParent){var a=e.checkValidity();if(o.push(a),"validationFunction"in e.dataset){var s=e.dataset.validationFunction;if("function"==typeof window[s]){var c=window[s](e);o.push(c)}}}var l=new t.FormData(e),u={};for(var p of l.entries())u[p[0]]=p[1];i[n]=u}),this.logger.debug("form validity",{formValidity:o}),this.logger.debug("form data",{data:i}),this.data=i,0==o.includes(!1))?(this.logger.debug("form is valid"),e.querySelectorAll(this.properties.disabledToggleSelector).forEach(function(e){e.disabled=!1})):(this.logger.debug("form is not valid"),e.querySelectorAll(this.properties.disabledToggleSelector).forEach(function(e){e.disabled=!0}))},_MetricalViewHtmlLightBox.prototype.setupForms=function(){var e=this;e.browser.document().querySelectorAll(e.properties.formSelector).forEach(function(t){t.addEventListener("submit",e.handleFormSubmit.bind(e))})},_MetricalViewHtmlLightBox.prototype.handleFormSubmit=function(e){return e.stopPropagation(),e.preventDefault(),!1},_MetricalViewHtmlLightBox.prototype.setupNavigation=function(){var e=this,t=e.browser.document().querySelectorAll(e.properties.navSelector),r=[];return t.forEach(function(t){var i=t.dataset.nav,o=i.split("/"),n=2==o.length?o[0]:"click",a=2==o.length?o[1]:i;t.addEventListener(n,function(t){e.logger.debug("navigating to "+a),e.navigate(a)}),r.push(i)}),r},_MetricalViewHtmlLightBox.prototype.setupLoadingOnClick=function(){var e=this;e.browser.document().querySelectorAll(e.properties.loadingOnClickSelector).forEach(function(t){t.addEventListener("click",function(t){t.target.disabled=!0,t.target.innerHTML=e.properties.ellipsisHtml})})},_MetricalViewHtmlLightBox.prototype.makePageId=function(e){return this.properties.viewPageClass+"_"+e},_MetricalViewHtmlLightBox.prototype.navigate=function(e){try{var t=this.browser.document(),r=this.properties.view.pages||{};for(var i in r){var o=this.makePageId(i);(n=t.getElementById(o)).classList.remove(this.properties.showClass),n.classList.add(this.properties.hideClass)}if(Object.keys(r).length>0){var n,a=this.makePageId(e);(n=t.getElementById(a)).classList.add(this.properties.showClass),n.classList.remove(this.properties.hideClass),this.logger.debug("navigated to page "+e)}}catch(e){throw this.logger.error(e),e}},_MetricalViewHtmlLightBox.prototype.renderPage=function(e,t){try{var r=this.browser.document(),i=this.makePageId(e),o=r.createElement("div");return o.classList.add(this.properties.viewPageClass),o.classList.add(i),o.classList.add(this.properties.hideClass),o.id=i,o=this.makeInnerHtml(o,t)}catch(e){throw this.logger.error(e),e}},_MetricalViewHtmlLightBox.prototype.setupOverlays=function(e){var t=this,r=t.browser.document();t.browser.window();"overlays"in t.view&&1==Array.isArray(t.view.overlays)&&t.view.overlays.forEach(function(i,o){var n=t.objectVal(i,"imagemap."+t.device()),a=t.objectVal(i,"highlight",!1),s=t.objectVal(i,"style",""),c=t.objectVal(i,"class",[]),l=t.objectVal(i,"id",null),u=t.objectVal(i,"html",""),p={style:s,classes:Array.isArray(c)?c:[c],id:l},d=t._makeDivOverlayEl(r,o,n,a,p);d.innerHTML=u,e.appendChild(d)})},_MetricalViewHtmlLightBox.prototype.setupOverlayEvents=function(e){var t=this,r=t.browser.document();"events"in t.view&&1==Array.isArray(t.view.events)&&t.view.events.forEach(function(i,o){var n=t.objectVal(i,"imagemap."+t.device()),a=t.objectVal(i,"highlight",!1),s=t.objectVal(i,"style",""),c=t.objectVal(i,"class",[]),l=t.objectVal(i,"id",null),u=t.objectVal(i,"topic"),p=Array.isArray(c)?c:[c];p.push("Metrical_Overlay_Pointer");var d={style:s,classes:p,id:l},f=t._makeDivOverlayEl(r,o,n,a,d);f.addEventListener("click",function(e){e.stopPropagation(),t.bus.publish(u)}),e.appendChild(f)})},_MetricalViewHtmlLightBox.prototype._makeDivOverlayEl=function(e,t,r,i,o){var n=e.createElement("div"),a=o.id?o.id:"MetricalDivOverlay_"+t;return n.id=a,n.classList.add("Metrical_Overlay"),i&&n.classList.add("Metrical_Overlay_Highlight"),o.classes.length>0&&o.classes.forEach(function(e){e&&n.classList.add(e)}),n.style=o.style,this.assignOverlayPosition(n,r),n},_MetricalViewHtmlLightBox.prototype.assignOverlayPosition=function(e,t){var r,i,o,n,a="object"==typeof t&&null!==t?t:null;if(null===a)throw new Error("Position for overlay needs to be defined with coordinates or have width/height/left/top defined. Received ".inputPosition);if("coordinates"in a){var s=a.coordinates,c=s.split(",");if(4!=c.length)throw new Error("An invalid set of coordinates was passed to the makeDivOverlayEl function: "+s);r=c[2]-c[0],i=c[3]-c[1],o=c[1],n=c[0]}else r=a.width,i=a.height,o=a.top,n=a.left;e.style.width=r+"px",e.style.height=i+"px",e.style.top=o+"px",e.style.left=n+"px"},_MetricalViewHtmlLightBox.prototype.resizeOverlays=function(){var e=this,t=e.browser.document();"events"in e.view&&1==Array.isArray(e.view.events)&&e.view.events.forEach(function(r,i){var o=e.objectVal(r,"imagemap."+e.device()),n="#MetricalDivOverlay_"+i,a=t.querySelector(n);a&&e.assignOverlayPosition(a,o)})},_MetricalViewHtmlLightBox.prototype.setupAdditionalInfo=function(e){var t=this,r=t.browser.document();"additionalinfo"in t.view&&(e.appendChild(t._makeAdditionalInfoEl(r)),t.bus.subscribe(t.properties.additionalInfoTopic,function(e){t.toggleAdditionalInfo()}))},_MetricalViewHtmlLightBox.prototype._makeAdditionalInfoEl=function(e){var t=this,r=t.objectVal(t.view,"additionalinfo",{}),i=t.objectVal(r,"text","");infoEl=e.createElement("div"),infoEl.classList.add(t.properties.additionalInfoClass);var o=t.objectVal(r,"style",null);return o&&(infoEl.style=o),chevronSpanEl=e.createElement("span"),chevronSpanEl.classList.add(t.properties.additionalInfoChevronClass),chevronSpanEl.addEventListener("click",function(e){e.stopPropagation(),t.bus.publish(t.properties.additionalInfoTopic)}),chevronEl=e.createElement("div"),chevronEl.appendChild(chevronSpanEl),textEl=e.createElement("span"),textEl.innerHTML=i,infoEl.appendChild(chevronEl),infoEl.appendChild(textEl),infoEl},_MetricalViewHtmlLightBox.prototype.toggleAdditionalInfo=function(){var e=this.browser.document(),t="."+this.properties.lightBoxClass+" ."+this.properties.additionalInfoClass,r=e.querySelector(t);r&&(this.additionalInfoIsOpen?(r.classList.remove(this.properties.additionalInfoSlideOutClass),r.classList.add(this.properties.additionalInfoSlideInClass),this.additionalInfoIsOpen=!1):(r.classList.remove(this.properties.additionalInfoSlideInClass),r.classList.add(this.properties.additionalInfoSlideOutClass),this.additionalInfoIsOpen=!0))},_MetricalViewHtmlLightBox.prototype.setupResizeMonitoring=function(){var e=this;e.browser.window().addEventListener("resize",e.utils.debounce(function(t){e.resizeOverlays()},100))},_MetricalViewImageMap=function(e){_MetricalViewHtmlLightBox.call(this,Object.assign({},{},e||{}))},_MetricalViewImageMap.prototype=Object.create(_MetricalViewHtmlLightBox.prototype),_MetricalViewImageMap.prototype.constructor=_MetricalViewImageMap,_MetricalViewImageMap.prototype.renderContent=function(){var e=this.browser.document(),t=this.objectVal(this.view,"imageurl."+this.device()),r=e.createElement("img");return r.setAttribute("src",t),r},_MetricalViewEmbedded=function(e){if(_MetricalViewHtmlLightBox.call(this,Object.assign({},{lightBoxClass:"Metrical_Embedded",lightBoxContentClass:"Metrical_EmbeddedContent"},e||{})),0==!!this.view.selector)throw new Error("_MetricalViewEmbedded expects a selector property");this.position=this.view.position?this.view.position:"append",this.classes=this.view.classes?this.view.classes:[],this.selector=this.view.selector},_MetricalViewEmbedded.prototype=Object.create(_MetricalViewHtmlLightBox.prototype),_MetricalViewEmbedded.prototype.constructor=_MetricalViewEmbedded,_MetricalViewEmbedded.prototype.attachLightbox=function(e){var t=this.browser.document().querySelector(this.selector);if(null===t)throw this.logger.warning("Could not locate an element for the embedded view with selector "+this.selector,{selector:this.selector}),new Error("Could not locate an element for the embedded view with selector "+this.selector);"after"==this.position?t.after(e):"before"==this.position?t.before(e):t.appendChild(e)},_MetricalViewModuleTimer=function(e){var t={bus:void 0,view:void 0,browser:new _MetricalBrowser,utils:_MetricalUtils,logger:new _MetricalLogger({extra:{module:"viewmodule"}}),deadline:null,fidelity:"days",interval:1e3,tickFunction:null,daysSelector:"#MetricalTimer_days",daysPaddingAmount:1,daysPaddingCharacter:"0",hoursSelector:"#MetricalTimer_hours",hoursPaddingAmount:2,hoursPaddingCharacter:"0",minutesSelector:"#MetricalTimer_minutes",minutesPaddingAmount:2,minutesPaddingCharacter:"0",secondsSelector:"#MetricalTimer_seconds",secondsPaddingAmount:2,secondsPaddingCharacter:"0",stopAtZero:!0,startOnCreation:!0};if(this.properties=Object.assign({},t,e||{}),this.timerToken=null,0==!!this.properties.deadline)throw new Error("_MetricalViewModuleTimer expects a deadline parameter");this.properties=Object.assign({},t,e||{}),this.properties.startOnCreation&&this.start()},_MetricalViewModuleTimer.prototype.remainingTime=function(e){const t=Date.parse(e)-Date.parse(new Date),r=Math.floor(t/1e3%60),i=Math.floor(t/1e3/60%60),o=Math.floor(t/36e5%24),n=Math.floor(t/864e5);return t<=0&&this.properties.stopAtZero?{total:0,days:0,hours:0,minutes:0,seconds:0}:{total:t,days:n,hours:o,minutes:i,seconds:r}},_MetricalViewModuleTimer.prototype.rollup=function(e,t){var r=Object.assign({},e);return"hours"==t&&(r.hours=24*r.days+r.hours,r.days=0),"minutes"==t&&(r.hours=24*r.days+r.hours,r.days=0,r.minutes=60*r.hours+r.minutes,r.hours=0),"seconds"==t&&(r.hours=24*r.days+r.hours,r.days=0,r.minutes=60*r.hours+r.minutes,r.hours=0,r.seconds=60*r.minutes+r.seconds,r.minutes=0),r},_MetricalViewModuleTimer.prototype.internalTickFunction=function(e){var t=this.properties.browser.document(),r=t.querySelector(this.properties.daysSelector);r&&(r.innerHTML=String(e.days).padStart(this.properties.daysPaddingAmount,this.properties.daysPaddingCharacter));var i=t.querySelector(this.properties.hoursSelector);i&&(i.innerHTML=String(e.hours).padStart(this.properties.hoursPaddingAmount,this.properties.hoursPaddingCharacter));var o=t.querySelector(this.properties.minutesSelector);o&&(o.innerHTML=String(e.minutes).padStart(this.properties.minutesPaddingAmount,this.properties.minutesPaddingCharacter));var n=t.querySelector(this.properties.secondsSelector);n&&(n.innerHTML=String(e.seconds).padStart(this.properties.secondsPaddingAmount,this.properties.secondsPaddingCharacter))},_MetricalViewModuleTimer.prototype.start=function(){var e=this;e.timerToken=setInterval(function(){var t=e.remainingTime(e.properties.deadline),r=e.rollup(t,e.properties.fidelity);"function"==typeof e.properties.tickFunction?e.properties.tickFunction(r):e.internalTickFunction(r)},e.properties.interval)},_MetricalViewModuleTimer.prototype.stop=function(){clearInterval(this.timerToken)},_MetricalViewFactory=function(e){var t={bus:void 0,browser:new _MetricalBrowser,utils:_MetricalUtils,logger:new _MetricalLogger({extra:{module:"view"}})};this.properties=Object.assign({},t,e||{}),this.logger=this.properties.logger},_MetricalViewFactory.prototype.create=function(e,t){var r=this.determineType(e);this.logger.debug("viewType",{viewType:r});var i=Object.assign({},this.properties,{view:e},t||{});this.logger.debug("inputProperties",{inputProperties:i});var o={imagemap:function(e){return new _MetricalViewImageMap(i)},htmllightbox:function(e){return new _MetricalViewHtmlLightBox(i)},embedded:function(e){return new _MetricalViewEmbedded(i)},default:function(e){throw new Error("A default view creation behanvior is not defined")}};return o[r](e)||o.default(e)},_MetricalViewFactory.prototype.determineType=function(e){var t=e.type||void 0;if(["imagemap","htmllightbox","embedded"].includes(t))return t;throw new Error("ViewType "+t+" was passed but is not valid")},_MetricalViewModules=function(e){var t={bus:void 0,browser:new _MetricalBrowser,utils:_MetricalUtils,logger:new _MetricalLogger({extra:{module:"viewmodules"}}),viewModules:null};if(this.properties=Object.assign({},t,e||{}),!1==!!this.properties.viewModules||"object"!=typeof this.properties.viewModules)throw new Error("ViewModules expects a viewModules object with a key/object pairing of configured modules");this.logger=this.properties.logger,this.modules={},this._init()},_MetricalViewModules.prototype._init=function(){var e=this;Object.keys(e.properties.viewModules).forEach(function(t){var r=e.properties.viewModules[t],i=e.determineType(r);e.logger.debug("moduleType",{moduleType:i});var o=Object.assign({},e.properties,{config:r,id:t},r.properties||{});e.logger.debug("inputProperties",{inputProperties:o});var n={timer:function(){return new _MetricalViewModuleTimer(o)},default:function(){throw new Error("A default module type creation behavior is not defined")}},a=n[i]()||n.default();e.modules[t]=a})},_MetricalViewModules.prototype.module=function(e){if(e in this.modules)return this.modules[e];throw new Error("Could not locate a module identified by key: "+e)},_MetricalViewModules.prototype.determineType=function(e){var t=e.type||void 0;if(["timer"].includes(t))return t;throw new Error("ModuleType "+t+" was passed but is not valid")},_MetricalActions=function(e){var t={browser:new _MetricalBrowser,logger:new _MetricalLogger({extra:{module:"actions"}}),utils:_MetricalUtils,bus:null,offerflow:null};if(this.properties=Object.assign({},t,e||{}),0==!!this.properties.bus)throw new Error("MetricalActions expects a bus parameter");this.logger=this.properties.logger,this.browser=this.properties.browser,this.utils=this.properties.utils},_MetricalActions.prototype.driver=function(e,t){var r=Object.assign({},this.properties,e||{});this.logger.debug("operation properties",{properties:r});var i=t||r.driver||null;switch(this.logger.debug("operation driver",{driver:i}),i){case"Eval":case"EvalDriver":case"eval":return new _MetricalOperationEval(r);case"Fetch":case"FetchDriver":case"fetch":return new _MetricalOperationFetch(r);case"Subscribe":case"SubscribeDriver":case"subscribe":return new _MetricalOperationSubscribe(r);case"RecordOfferFlow":case"RecordOfferFlowDriver":case"recordofferflow":return new _MetricalOperationRecordOfferflow(r);case"CloseView":case"CloseViewDriver":case"closeview":return new _MetricalOperationCloseView(r);case"JcpCoupon":case"JcpCouponDriver":case"jcpcoupon":return new _MetricalOperationJcpCoupon(r);case"ApplyCoupon":case"ApplyCouponDriver":case"applycoupon":return new _MetricalOperationApplyCoupon(r);case"Applier":case"ApplierDriver":case"applier":return new _MetricalOperationApplier(r);case"Redirect":case"RedirectDriver":case"redirect":return new _MetricalOperationRedirect(r);default:throw new Error("Could not find a matching driver case for "+i)}},_MetricalActions.prototype.execute=function(){var e=this;return new Promise(function(t,r){try{var i=void 0,o="object"==typeof e.properties.operations&&null!==e.properties.operations?e.properties.operations:{},n=Object.keys(o);(new _MetricalValues).values(e.properties.values).then(function(t){i=t;var r=n.map(function(t){var r=o[t],n=e.driver(r);return n.execute.bind(n,i)});return e.utils.promiseSequence(r)}).then(function(e){var r=n.reduce(function(t,r,i){return t[r]=e[i],t},{});t(Object.assign({},i,r))}).catch(function(t){e.logger.error({error:t}),r(t)})}catch(t){e.logger.error({error:t}),r(t)}})},_MetricalMonitor=function(e){var t={logger:new _MetricalLogger,show:!1,browser:{document:document},styles:null};this.properties=Object.assign({},t,e||{}),this.logger=this.properties.logger,this.browser=this.properties.browser,this.containerEl=null,this.mainEl=null,this.entries=[],1==this.properties.show&&this.show()},_MetricalMonitor.prototype.stylesEl=function(){var e=Array.isArray(this.properties.styles)?this.properties.styles:[".MetricalMonitor { width: 400px; height: 200px; border: solid 1px black; position: fixed; bottom: 10px; left: 10px; padding: 3px; z-index: 2000;}",".MetricalMonitorMain { background-color: black; color: lime; height: 100%; width: 99%; padding-left: 1%; overflow-y: auto; font-size: .8em;}"],t=this.browser.document.getElementById("Metrical_Monitor_css");if(null===t){var r=this.browser.document.createElement("style");return r.id="Metrical_Monitor_css",r.appendChild(this.browser.document.createTextNode(e.join("\n"))),this.browser.document.getElementsByTagName("head")[0].appendChild(r),r}return t},_MetricalMonitor.prototype.render=function(){this.logger.log("render called");var e=this.browser.document.createElement("div");e.classList.add("MetricalMonitor");var t=this.browser.document.createElement("div");t.classList.add("MetricalMonitorMain"),t.innerHTML="",this.mainEl=t,this.printEntries(t),e.append(t),this.stylesEl(),this.containerEl=e},_MetricalMonitor.prototype.printEntries=function(e){var t=this.entries.join("<br />");e.innerHTML=t,e.scrollTop=e.scrollHeight},_MetricalMonitor.prototype.addLogEntry=function(e){0==this.entries.includes(e.msg)&&this.addEntry(e.msg)},_MetricalMonitor.prototype.addEntry=function(e){var t="string"!=typeof e?JSON.stringify(e):String(e);this.entries.push(t),this.mainEl&&this.printEntries(this.mainEl)},_MetricalMonitor.prototype.show=function(){this.containerEl||this.render(),this.containerEl&&this.browser.document.querySelector("body").appendChild(this.containerEl)},_MetricalMonitor.prototype.hide=function(){this.containerEl&&this.containerEl.remove()},_MetricalTimer=function(e){var t={logger:new _MetricalLogger({extra:{module:"timer"}}),bus:null,pageIdleMinutes:30,pageIdleTopic:"event/session-idle"};if(this.properties=Object.assign({},t,e||{}),0==!!this.properties.bus)throw new Error("_MetricalTimer expects a bus parameter");this.logger=this.properties.logger,this.bus=this.properties.bus,this.timerTokens={}},_MetricalTimer.prototype.startPageIdleTimer=function(){var e=this;e.logger.debug("setting page idle timer",{minutes:e.properties.pageIdleMinutes}),e.start("page-idle",60*e.properties.pageIdleMinutes*1e3,function(){e.bus.publish(e.properties.pageIdleTopic)})},_MetricalTimer.prototype.start=function(e,t,r){this.stop(e);var i=setTimeout(r,t);this.timerTokens[e]=i},_MetricalTimer.prototype.stop=function(e){var t=this.timerTokens[e]||null;t&&(clearTimeout(t),delete this.timerTokens[e])};var _MetricalAbandonCart={timeOnPage:0,initTimestamp:null,passedInProperties:{},metricalInteractions:null,abandonprobable:{},useLegacyOfferDisplay:!0,captureSelectedTextInteraction:!1,captureCopyTextInteraction:!1,isSuppressed:!1,appliedDiscountCode:null,observables:{postInit:[]},revisits:null,groups:null,ei:null,conditions:null,localInteractions:null,dataPoints:null,eventEmitter:null,cart:null,offerFlows:{},EventBus:new _MetricalEventBus,storage:new _MetricalStandardStorage,timers:null,usermeta:null,suppressionKey:"suppress",heartbeat:null,unsuppress:function(){this.storage.removeItem(this.suppressionKey),_MetricalAbandonCart.isSuppressed=!1},suppress:function(){_MetricalAbandonCart.isSuppressed=!0},suppressSession:function(){this.storage.setItem(this.suppressionKey,!0,{expiresAfter:1800}),_MetricalAbandonCart.suppress()},suppressHours:function(e){const t=3600*e;this.storage.setItem(this.suppressionKey,!0,{expiresInSeconds:t}),_MetricalAbandonCart.suppress()},suppressForever:function(){this.storage.setItem(this.suppressionKey,!0),_MetricalAbandonCart.suppress()},_notifyObservers:function(e){e in this.observables&&this.observables[e].map(function(e){e()})},observe:function(e,t){this.observables[e].push(t)},resetOfferFlowSession:function(){for(var e in _MetricalAbandonCart.offerFlows){var t=_MetricalAbandonCart.offerFlows[e];_MetricalAbandonCart.storage.removeItem(t.properties.namespace+"_offerRecordGuid")}},offerFlowRecords:function(){for(var e in _MetricalAbandonCart.offerFlows){var t=_MetricalAbandonCart.offerFlows[e];_MetricalAbandonCart.logger.info(e+" Record",{record:t.offerRecord})}},resetOfferFlow:function(){var e={};for(var t in _MetricalTestMode.enable(),_MetricalAbandonCart.offerFlows){var r={},i=_MetricalAbandonCart.offerFlows[t],o=i.properties.namespace,n=o+"_offerRecordGuid";r.cookie_guid=_MetricalAbandonCart.storage.removeItem(n);n=o+"_offerRecord";r.storage_record=_MetricalStorage.Storage.removeItem(n),r.cookie_record=_MetricalAbandonCart.storage.removeItem(n);n=o+"_offerlimits";r.storage_limits=_MetricalStorage.Storage.removeItem(n),r.cookie_limits=_MetricalAbandonCart.storage.removeItem(n);n="payload";r.cookie_payload=_MetricalAbandonCart.storage.removeItem(n),i.reset();n=o+"_limboOfferIsSynced";r.limbo_offer_is_syncd=_MetricalAbandonCart.storage.removeItem(n);n=o+"_limit";r.limit_cookie=_MetricalAbandonCart.storage.removeItem(n),r.offers_selected=_MetricalStorage.Storage.removeItem("offers_selected"),i.reset(),e[t]=r}return e},enableOffers:function(){_MetricalAbandonCart.storage.removeItem("offers_disabled")},disableOffers:function(){_MetricalAbandonCart.storage.setItem("offers_disabled",1)},offersActive:function(){return!_MetricalAbandonCart.storage.hasItem("offers_disabled")||1!=_MetricalAbandonCart.storage.getItem("offers_disabled")},isInTestMode:function(){return _MetricalTestMode.isInTestMode()},code:function(){return _MetricalCouponDataAccess.getC()||null},codeAndClear:function(){var e=_MetricalCouponDataAccess.getC()||null;return _MetricalCouponDataAccess.removeC(),e},override:function(e){_MetricalAbandonCart.storage.setItem("oc",e,{expiresAfter:1800})},clearOverrides:function(){_MetricalAbandonCart.storage.removeItem("oc")},updateUserMeta:function(e){_MetricalAbandonCart.usermeta.add(e),_MetricalCart.loaded&&_MetricalCart.syncWithUserMeta({usermeta:e})},enableDebug:function(e,t){var r=this;e=e||"trace",t=t&&Array.isArray(t)?t:[t],_MetricalStorage.Storage.setItem("loglevel",e);var i=[];0==t.includes("offerflow")&&0==t.includes("offerflowpoll")&&i.push({path:"module",not:"offerflowpoll"}),0==t.includes("cxflows")&&0==t.includes("cxflowspoll")&&i.push({path:"module",not:"cxflowspoll"}),_MetricalStorage.Storage.setItem("logfilters",i),this.defaultTransport.setLogLevel(_MetricalStorage.Storage.getItem("loglevel")||"error"),(_MetricalStorage.Storage.getItem("logfilters")||[]).forEach(function(e){r.defaultTransport.addFilter(e)})},disableDebug:function(){_MetricalStorage.Storage.removeItem("loglevel"),_MetricalStorage.Storage.removeItem("logfilters"),this.defaultTransport.setLogLevel("warning"),this.defaultTransport.clearFilters()},initTimestamp:null,initUtcTimestamp:null,monitor:null,logger:new _MetricalLogger,defaultTransport:null,monitorTransport:null,mBrowser:mBrowser,init:function(e,t,r){"abandoncartid"in e&&(t=e),"usermeta"in t||(t.usermeta={});var i=this;if(this.logger=new _MetricalLogger,this.defaultTransport=new _MetricalTransportDefault,this.defaultTransport.setLogLevel(_MetricalStorage.Storage.getItem("loglevel")||"error"),(_MetricalStorage.Storage.getItem("logfilters")||[]).forEach(function(e){i.defaultTransport.addFilter(e)}),this.logger.addTransport(this.defaultTransport),this.EventBus.logger=this.logger.child({module:"eventbus"}),this.monitor=new _MetricalMonitor({logger:this.logger,show:i.storage.getItem("showmonitor")||!1}),this.monitorTransport=new _MetricalTransportMonitor({monitor:i.monitor}),this.logger.addTransport(this.monitorTransport),mBrowser.logger=this.logger.child({module:"browser"}),this.logger.trace(">>> starting init"),this.logger.debug("init parameters",{input:[e,t,r]}),this.logger.info("Initializing _MetricalAbandonCart"),_MetricalAbandonCart.initializeTimestamps(),_MetricalUserEvents.init({logger:this.logger}),_MetricalBrowserHistory.init(),_MetricalCouponDataAccess.init({mb:mBrowser,endpoint:_MetricalHosts.endpoints.singleUseCoupon}),this.usermeta=new _MetricalUsermeta({logger:this.logger.child({module:"usermeta"}),usermeta:t.usermeta||{}}),null!=t.abandoncartid){this.passedInProperties=t;i=this;null!=this.passedInProperties.assets&&this.passedInProperties.assets.length>0?(this.logger.info("Loading assets"),_MetricalAssetLoader.logger=this.logger.child({module:"assetloader"}),_MetricalAssetLoader.init(mBrowser,{assets:this.passedInProperties.assets},function(){this.logger.info("Loading configuration file"),_MetricalAbandonCart.loadConfig(i.passedInProperties,r)}),_MetricalAssetLoader.exec()):(this.logger.info("Loading configuration file"),_MetricalAbandonCart.loadConfig(this.passedInProperties)),this.initTimestamp=Date.now()}else this.logger.error("The ID for the abandon cart config is not specified, the AbandonCart will not be loaded");this.logger.trace("<<< ending init")},loadConfig:function(properties,abandonCartAction){var that=this;that.logger.traceStart("loadConfig"),_MetricalAbandonCart.Config.loadConfigData(properties.abandoncartid,properties,function(){if(that.logger.traceStart("loadConfig callback"),that.logger.debug("Config Values",{config:_MetricalAbandonCart.Config}),that.logger.debug("Checking Storage Management Migration"),"migration"in _MetricalAbandonCart.Config.storage&&_MetricalAbandonCart.Config.storage.migration){that.logger.debug("Performing storage migration");var sm=new _MetricalStorageManager({storage:_MetricalStorage,ss:_MetricalAbandonCart.storage}),migrationResults=sm.migrate(_MetricalAbandonCart.Config.storage.migration);that.logger.debug("Migrated Keys",migrationResults)}if(that.logger.debug("Checking Storage Manager Removal"),"remove"in _MetricalAbandonCart.Config.storage&&_MetricalAbandonCart.Config.storage.remove){that.logger.debug("Performing storage removal");var sm=new _MetricalStorageManager({storage:_MetricalStorage,ss:_MetricalAbandonCart.storage}),removeResults=sm.remove(_MetricalAbandonCart.Config.storage.remove);that.logger.debug("Removed Keys",removeResults)}that.logger.debug("Setting page idle timer"),that.timers=new _MetricalTimer({bus:that.EventBus,logger:that.logger.child({module:"timer"}),pageIdleMinutes:_MetricalAbandonCart.Config.pageIdleMinutes}),that.timers.startPageIdleTimer(),that.logger.info("Initializing Identity"),_MetricalIdentity.init({storage:_MetricalAbandonCart.storage,bus:_MetricalAbandonCart.EventBus,utils:_MetricalUtils}),that.EventBus.subscribe("event/session-idle",function(){that.logger.debug("event/session-idle fired, resetting session"),_MetricalIdentity.resetSessionId()}),_MetricalAbandonCart.Config.usermeta&&that.usermeta.add(function(){return _MetricalAbandonCart.usermeta.parse(_MetricalAbandonCart.Config.usermeta)});var monitorStylesFromConfig=_MetricalAbandonCart.Config.monitor.styles||null,monitorStylesFromStorage=_MetricalStorage.Storage.getItem("monitor_styles")||null;that.monitor=new _MetricalMonitor({logger:that.logger,show:that.storage.getItem("showmonitor")||!1,styles:monitorStylesFromStorage||monitorStylesFromConfig||null}),that.monitorTransport=new _MetricalTransportMonitor({monitor:that.monitor}),that.logger.addTransport(that.monitorTransport),_MetricalAbandonCart.conditions=new _MetricalConditions({conditions:_MetricalAbandonCart.Config.conditions||{}});var storageSyncPromise=Promise.resolve();if(1==_MetricalAbandonCart.Config.storagesyncisactive){var ss=new _MetricalStorageSync({logger:_MetricalAbandonCart.logger.child("storagesync"),browser:mBrowser});storageSyncPromise=ss.sync(_MetricalAbandonCart.Config.surveyid,_MetricalIdentity.getDeviceId()),_MetricalUserEvents.subscribe("unload",function(e){ss.post(_MetricalAbandonCart.Config.surveyid,_MetricalIdentity.getDeviceId(),_MetricalStorage.export())})}storageSyncPromise.then(function(){that.pageType=new _MetricalPageType({logger:that.logger,usermeta:that.usermeta,config:_MetricalAbandonCart.Config}),that.pageType.run(),_MetricalTestMode.init(_MetricalAbandonCart.storage),_MetricalDebug.init({isActive:_MetricalAbandonCart.Config.debugisactive||!1,ac:_MetricalAbandonCart}),_MetricalAbandonCart.conditions=new _MetricalConditions({conditions:_MetricalAbandonCart.Config.conditions||{}}),_MetricalCartDA.init({useCookieOverLocal:_MetricalAbandonCart.Config.usecookieoverlocal});var expandItemsFunc=null;if(_MetricalAbandonCart.Config.expanditemsfunc&&(eval(_MetricalAbandonCart.Config.expanditemsfunc),expandItemsFunc=expandItems||null),_MetricalCart.init({da:_MetricalCartDA,expandItemsFunc:expandItemsFunc,bus:that.EventBus}),_MetricalAbandonCart.cart=_MetricalCart,_MetricalAbandonCart.dataPoints=new _MetricalDataPoints({storage:_MetricalStorage.SessionStorage,utils:_MetricalUtils,config:_MetricalAbandonCart.Config.datapoints||[]}),_MetricalAbandonCart.dataPoints.evaluate(),_MetricalAbandonCart.Config.usemcartusermeta&&_MetricalAbandonCart.usermeta.add(function(){return _MetricalAbandonCart.cart.usermetaValues()},"replaceIfEmpty"),_MetricalAbandonCart.Config.useprobabilityengine&&(_MetricalPE.init({mb:mBrowser,ac:_MetricalAbandonCart,log:that.logger.child({module:"pe"}),identity:_MetricalIdentity,endpoint:_MetricalHosts.endpoints.pe,conditions:_MetricalAbandonCart.conditions}),_MetricalACInteractions.registerRecordInteractionObserver("pe",function(e){that.logger.debug("calling interaction callback for pe",{data:e}),_MetricalPE.shouldRun().then(function(t){that.logger.debug("pe shouldrun promise",{results:t}),1==t&&(that.logger.debug("calling pe send interaction data",{data:e}),_MetricalPE.sendInteractionData(e).then(function(e){that.logger.debug("pe results",{peResults:e})}).catch(function(e){throw e}))}).catch(function(e){throw e})}),that.logger.info("Probability Engine enabled")),void 0!==_MetricalAbandonCart.Config.uselegacyofferdisplay&&(_MetricalAbandonCart.useLegacyOfferDisplay=_MetricalAbandonCart.Config.uselegacyofferdisplay),_MetricalACInteractions.registerRecordInteractionObserver("cartSync",function(e){_MetricalCart.syncWithUserMeta(e)}),_MetricalAbandonCart.localInteractions=new _MetricalLocalInteractions({storage:_MetricalStorage.SessionStorage,utils:_MetricalUtils,uuid:_MetricalIdentity.getDeviceId(),sessionId:_MetricalIdentity.getSessionId()}),1==_MetricalAbandonCart.Config.savelocalinteractions&&_MetricalACInteractions.registerRecordInteractionObserver("localinteractions",function(e){_MetricalAbandonCart.localInteractions.record(e)}),_MetricalAbandonCart.metricalInteractions=_MetricalACInteractions,_MetricalAbandonCart.setupInteractions(),_MetricalAbandonCart.Config.custominteractions,_MetricalAbandonCart.Config.interactionobservers.length>0?(that.logger.info("Registering interaction observers from the config"),_MetricalACInteractions.registerRecordInteractionObserver("observerConfig",function(e){_MetricalCallbacks.parseObserverConfig(_MetricalAbandonCart.Config.interactionobservers,e)})):that.logger.info("Skipping interaction observer registration"),_MetricalAbandonCart.EventBus.subscribe("interaction",function(e,t){_MetricalAbandonCart.metricalInteractions.handleInteractionEvent(e,t)}),1==_MetricalAbandonCart.Config.heartbeat.isactive?(that.logger.info("Enabling heartbeat system"),_MetricalAbandonCart.heartbeat=new _MetricalHeartBeat({interaction_action:_MetricalAbandonCart.Config.heartbeat.interaction_action,interactions:_MetricalAbandonCart.metricalInteractions,sequenceConfiguration:_MetricalAbandonCart.Config.heartbeat.sequence,logger:that.logger}),_MetricalAbandonCart.heartbeat.start()):that.logger.info("Skipping heartbeat system"),void 0!==_MetricalAbandonCart.Config.captureselectedtextinteraction&&(_MetricalAbandonCart.captureSelectedTextInteraction=_MetricalAbandonCart.Config.captureselectedtextinteraction),1==_MetricalAbandonCart.captureSelectedTextInteraction&&_MetricalUserEvents.subscribe("textSelect",function(e){that.logger.info("Text Selected",e),_MetricalAbandonCart.recordInteraction("selected-text",{field_key:"event",target:e})}),void 0!==_MetricalAbandonCart.Config.capturecopytextinteraction&&(_MetricalAbandonCart.captureCopyTextInteraction=_MetricalAbandonCart.Config.capturecopytextinteraction),1==_MetricalAbandonCart.captureCopyTextInteraction&&_MetricalUserEvents.subscribe("copy",function(e){that.logger.info("Copy Text",e),_MetricalAbandonCart.recordInteraction("copy",{field_key:"event",target:e})}),_MetricalAbandonCart.Config.interactions.capture_clicks_is_active){that.logger.info("Initializing click capture");var captureClicksFilters=_MetricalAbandonCart.Config.interactions.capture_clicks_filters,captureClicksTargets=_MetricalAbandonCart.Config.interactions.capture_clicks_targets;_MetricalUserEvents.initializeClicks(captureClicksFilters,captureClicksTargets),_MetricalUserEvents.subscribe("capture-click",function(e){that.logger.info("capture-click",{target:e.outerHTML}),_MetricalAbandonCart.recordInteraction("click",{field_key:"event",target:e.outerHTML})})}if(_MetricalAbandonCart.Config.interactions.capture_forms_is_active){that.logger.info("Initializing form capture");var captureFormsFilters=_MetricalAbandonCart.Config.interactions.capture_forms_filters,captureFormsWhitelist=_MetricalAbandonCart.Config.interactions.capture_forms_whitelist,captureFormsBlacklist=_MetricalAbandonCart.Config.interactions.capture_forms_blacklist;_MetricalUserEvents.initializeForms(captureFormsFilters,captureFormsWhitelist,captureFormsBlacklist),_MetricalUserEvents.subscribe("capture-form",function(e){that.logger.info("capture-form",{data:e}),_MetricalAbandonCart.recordInteraction("form-data",{field_key:"event",target:e})})}if(_MetricalAbandonCart.revisits=new _MetricalRevisits({storage:that.storage,namespace:_MetricalAbandonCart.Config.revisitsnamespace||"default",resetPoints:_MetricalAbandonCart.Config.revisitresetpoints?_MetricalAbandonCart.Config.revisitresetpoints:[]}),_MetricalAbandonCart.Config.revisitsisactive&&(that.logger.info("Configuring the revists system"),_MetricalAbandonCart.revisits.record(_MetricalIdentity.getSessionId()),_MetricalAbandonCart.EventBus.subscribe("event/reset-session-id",function(e){_MetricalAbandonCart.revisits.record(e.sessionId),_MetricalAbandonCart.groups&&"reset"in _MetricalAbandonCart.groups&&_MetricalAbandonCart.groups.reset()})),_MetricalAbandonCart.groups=new _MetricalGroups({storage:_MetricalStorage.SessionStorage,groups:_MetricalAbandonCart.Config.groups||{}}),1==!!_MetricalAbandonCart.Config.exitintentisactive&&1==_MetricalAbandonCart.Config.exitintentisactive&&(_MetricalAbandonCart.ei=new _MetricalExitIntent({dimensions:new _MetricalDimensions}),"desktop"==_MetricalUtils.determineDevice()?_MetricalUserEvents.subscribe("documentout",function(e){null!=e&&null!=e.clientX&&null!=e.clientY&&_MetricalAbandonCart.ei.checkForIntent(e.clientX,e.clientY)}):_MetricalUserEvents.subscribe("scrollup",function(e){_MetricalAbandonCart.ei.incrementExitIntents()})),that.logger.info("Initializing appliers"),_MetricalAppliers.init({mb:mBrowser,logger:that.logger.child({module:"appliers"}),storage:that.storage}),Array.isArray(_MetricalAbandonCart.Config.eventEmitters)&&_MetricalAbandonCart.Config.eventEmitters.length>0&&(that.eventEmitter=new _MetricalEventEmitter({bus:that.EventBus,browser:mBrowser,logger:that.logger.child({module:"eventemitter"}),emitters:_MetricalAbandonCart.Config.eventEmitters})),_MetricalAbandonCart.Config.topicresponse){var topicResponse=new _MetricalTopicResponse({bus:_MetricalAbandonCart.EventBus,cart:_MetricalAbandonCart.cart,interactions:_MetricalAbandonCart.metricalInteractions,usermeta:_MetricalAbandonCart.usermeta,logger:that.logger.child({module:"topicresponse"})}),topicSubscriptions=topicResponse.subscribe(_MetricalAbandonCart.Config.topicresponse);that.logger.debug("Topic subscriptions",{topicSubscriptions:topicSubscriptions})}var loadTopicRules=_MetricalUtils.get(_MetricalAbandonCart.Config,"Config.topicpublish.load",[]);if(loadTopicRules.length>0){var topicPublish=new _MetricalTopicPublish({bus:_MetricalAbandonCart.EventBus,logger:that.logger.child({module:"topicpublish"})}),topicPublishOperations=topicPublish.evaluatePublishRules(loadTopicRules);that.logger.debug("Load Topics Published",{topicPublishOperations:topicPublishOperations})}"init.post"in _MetricalAbandonCart.Config.run&&_MetricalUtils.run(_MetricalAbandonCart.Config.run["init.post"]),_MetricalAbandonCart.AbandonHandler.bootstrap(abandonCartAction),that._notifyObservers("postInit"),that.logger.traceEnd("loadConfig callback")}).catch(function(e){that.logger.error({error:e})})}),that.logger.traceEnd("loadConfig")},initializeTimestamps:function(){now=new Date;var e=_MetricalUtils.getFullDateUTC(now);_MetricalAbandonCart.initTimestamp=now,_MetricalAbandonCart.initUtcTimestamp=e,this.logger.info("Initialization Timestamp",_MetricalAbandonCart.initTimestamp),this.logger.info("Initialization UTC Timestamp",_MetricalAbandonCart.initUtcTimestamp)},getInteractionData:function(){_MetricalAbandonCart.initTimestamp?timeOnPage=Date.now()-_MetricalAbandonCart.initTimestamp:timeOnPage=0,interactionData={uuid:_MetricalIdentity.getDeviceId(),survey_id:_MetricalAbandonCart.Config.surveyid,url:window.location.href,device:_MetricalUtils.determineDevice(),instance_id:_MetricalIdentity.getInstanceId(),session_id:_MetricalIdentity.getSessionId(),timestamp:_MetricalUtils.getFullDateUTC(new Date),widget_init_timestamp:_MetricalAbandonCart.initUtcTimestamp,survey_revision:_MetricalAbandonCart.Config.revision,interaction_guid:_MetricalUtils.makeUUID(),timeonpage:timeOnPage},_MetricalAbandonCart.Config.uselegacyusermeta?interactionData.usermeta=_MetricalAbandonCart.passedInProperties.usermeta||{}:interactionData.usermeta=_MetricalAbandonCart.usermeta.all(),promoID=this.mBrowser.getElement("#_Metrical_promoid_triggered"),null!=promoID&&promoID.value&&(interactionData.promoid=promoID.value,null!=_Metrical.app?interactionData.metricalinstanceid=_Metrical.app.instanceId:interactionData.metricalinstanceid="N/A");var e=null!=_MetricalAbandonCart.Config.eligibleexperiment?JSON.stringify(_MetricalAbandonCart.Config.eligibleexperiment):null;interactionData.experiment=e;var t=(new Date).getTimezoneOffset();interactionData.timezone_offset=t;var r=_MetricalUtils.getParameterByName("utm_source");null!=r&&""!=r&&(interactionData.usermeta.utmsource=r);var i=_MetricalUtils.getParameterByName("utm_medium");null!=i&&""!=i&&(interactionData.usermeta.utmmedium=i);var o=_MetricalUtils.getParameterByName("utm_campaign");null!=o&&""!=o&&(interactionData.usermeta.utmcampaign=o);var n=_MetricalUtils.getParameterByName("utm_term");null!=n&&""!=n&&(interactionData.usermeta.utmterm=n);var a=_MetricalUtils.getParameterByName("utm_content");null!=a&&""!=a&&(interactionData.usermeta.utmcontent=a);var s="referrer"in document?document.referrer:"";interactionData.referrer=s,_MetricalDebug.isEnabled()&&(interactionData.debug=JSON.stringify(_MetricalDebug.debugInformation()));var c=_MetricalAbandonCart.Config.interactionUsermetaOverrides||{};if(Object.keys(c).length>0)for(var l in c){if("object"==typeof(u=c[l]))!("behavior"in u&&"replaceIfEmpty"==u.behavior&&null!==interactionData.usermeta[l]&&""!==interactionData.usermeta[l])&&(interactionData.usermeta[l]=_MetricalUtils.evaluate(c[l].eval));else interactionData.usermeta[l]=_MetricalUtils.evaluate(c[l])}c=_MetricalAbandonCart.Config.interactionOverrides||{};if(Object.keys(c).length>0)for(var l in c){var u;if("object"==typeof(u=c[l]))!("behavior"in u&&"replaceIfEmpty"==u.behavior&&null!==interactionData.usermeta[l]&&""!==interactionData.usermeta[l])&&(interactionData[l]=_MetricalUtils.evaluate(c[l].eval));else interactionData[l]=_MetricalUtils.evaluate(c[l])}return interactionData},setupInteractions:function(){captureinteractions=null==_MetricalAbandonCart.Config.captureinteractions||_MetricalAbandonCart.Config.captureinteractions,gacaptureinteraction=null==_MetricalAbandonCart.Config.gacaptureinteraction||_MetricalAbandonCart.Config.gacaptureinteraction,captureallinteractions=null!=_MetricalAbandonCart.Config.captureallinteractions&&_MetricalAbandonCart.Config.captureallinteractions,capturescrollinteractions=null!=_MetricalAbandonCart.Config.capturescrollinteractions&&_MetricalAbandonCart.Config.capturescrollinteractions,capturescrollinteractionsthreshold=null!=_MetricalAbandonCart.Config.capturescrollinteractionsthreshold?_MetricalAbandonCart.Config.capturescrollinteractionsthreshold:0,norecordonsubmitifempty=null!=_MetricalAbandonCart.Config.norecordonsubmitifempty&&_MetricalAbandonCart.Config.norecordonsubmitifempty;var e=null!=_MetricalAbandonCart.Config.interactionModificationCallback?_MetricalAbandonCart.Config.interactionModificationCallback:void 0;properties={apiendpoint:_MetricalHosts.endpoints.interaction,captureinteractions:captureinteractions,gacaptureinteraction:gacaptureinteraction,captureallinteractions:captureallinteractions,capturescrollinteractions:capturescrollinteractions,capturescrollinteractionsthreshold:capturescrollinteractionsthreshold,norecordonsubmitifempty:norecordonsubmitifempty,interactionModificationCallback:e,interactions:[],heartbeatisactive:void 0===_MetricalAbandonCart.Config.heartbeatisactive||_MetricalAbandonCart.Config.heartbeatisactive,heartbeatinterval:_MetricalAbandonCart.Config.heartbeatinterval||10,type:_MetricalAbandonCart.Config.interactions.type||"ecommerce"},null!=_MetricalAbandonCart.Config.custominteractions&&(properties.interactions=properties.interactions.concat(_MetricalAbandonCart.Config.custominteractions)),_MetricalACInteractions.init(mBrowser,properties,this.getInteractionData,this.setTransitionalCookie),this.interactionsReady=!0,this.runCachedInteractions()},interactionsReady:!1,cachedInteractions:[],recordInteraction:function(e,t,r,i){0==this.interactionsReady?this.cachedInteractions.push(arguments):_MetricalACInteractions.recordInteraction.apply(_MetricalACInteractions,arguments)},runCachedInteractions:function(){if(1==this.interactionsReady&&this.cachedInteractions.length>0)for(;this.cachedInteractions.length>0;){var e=this.cachedInteractions.shift();_MetricalACInteractions.recordInteraction.apply(_MetricalACInteractions,e)}},record:function({action:e,usermeta:t}){e=e||"",t=t||{},this.updateUserMeta(t),this.recordInteraction(e)},recordInteractionState:function(e,t,r){if(null!=_MetricalAbandonCart.metricalInteractions){var i="";_MetricalTestMode.isInTestMode()&&(i="(testmode) ");var o=e+" "+t+" - "+i+r;_MetricalAbandonCart.metricalInteractions.recordInteraction(o,null,!0),this.logger.info(o)}else this.logger.warning("Interactions are disabled, can't record state "+e)},replaceEventHandlers:function(){this.logger.info("calling replaceEventHanlders"),_MetricalACInteractions.relinkBasicInteractions()},isMetricalActive:function(){var e=this.mBrowser.getElement(".MetricalContainer"),t=this.mBrowser.getElement(".Metrical_lightbox"),r=this.mBrowser.hasClass(e,"is-popped"),i=this.mBrowser.getStyle(t,"display");return r||"block"==i},AbandonHandler:{handlerConfigObjects:[],evaluatingConditions:{},triggeringPromo:!1,abandonCartAction:null,promoTimesOpenedCookieBaseName:"_Metrical_promoopened_",conditionsObserverEnabled:!1,alwaysEvaluateConditions:!1,processedMaxTimesReached:!1,eligibleExperiment:null,cxflow:null,evaluatingCxFlow:!1,bootstrap:function(e){this.handlerConfigObjects=[],this.evaluatingConditions=!1,this.triggeringPromo=!1,this.promoTimesOpenedCookieBaseName="_Metrical_promoopened_",this.conditionsObserverEnabled=!1,this.abandonCartAction=e,this.alwaysEvaluateConditions=!1;_MetricalUtils.getParameterByName("metrical_disable_offers")&&"1"==_MetricalUtils.getParameterByName("metrical_disable_offers")&&_MetricalAbandonCart.disableOffers(),_MetricalAbandonCart.offersActive()||(_MetricalAbandonCart.Config.offerflowisactive=!1);var t=function(e,t,r){var i=new _MetricalEngagementFactory({acConfig:_MetricalAbandonCart.Config,bus:_MetricalAbandonCart.EventBus,immediatelyPerformBenefit:1!=_MetricalOfferFlow.manuallyTriggerPostCoupon,logger:_MetricalAbandonCart.logger.child({module:"engagement"}),localOfferFlow:e,cart:_MetricalAbandonCart.cart,browser:mBrowser,utils:_MetricalUtils}).create(t);1==_MetricalOfferFlow.manuallyTriggerPostCoupon&&(_MetricalOfferFlow.manualPostFunction=i.performBenefit.bind(i)),i.execute().then(function(e){r()}).catch(function(e){_MetricalAbandonCart.logger.error({error:e})})},r={};if(_MetricalAbandonCart.Config.offerflows)for(var i in _MetricalAbandonCart.Config.offerflows){var o=_MetricalAbandonCart.Config.offerflows[i],n="default"==i?o.experiments[0].name||"default":i+"_"+o.experiments[0].name||i+"_default";_MetricalAbandonCart.logger.debug("offer flow namespace value for data access",{namespaceValue:n});var a={id:i,conditions:_MetricalAbandonCart.conditions,engagements:o.engagements||o.offers||[],tags:o.tags||{},globalofferlimit:o.globalofferlimit||null,globalofferlimittimeout:o.globalofferlimittimeout||null,offerflowtag:o.offerflowtag||null,eligibilityrules:o.eligibilityrules||"",offerflowisactive:o.offerflowisactive||!0,namespace:n,da:new _MetricalOfferFlowDataAccess({namespace:n,storageDriver:_MetricalAbandonCart.Config.storagedriver},mBrowser,_MetricalAbandonCart,_MetricalIdentity,_MetricalHosts.endpoints.offerFlow),engagementFunction:t,testMode:_MetricalTestMode,revision:_MetricalAbandonCart.Config.revision,abandonprobable:_MetricalAbandonCart.abandonprobable,logger:_MetricalAbandonCart.logger.child({module:"offerflow"}),browser:mBrowser,identity:_MetricalIdentity,defaultOfferFlowType:o.offerflowtype||null};o.experiments&&(a.experiments=o.experiments),o.offerlimitchecks&&o.offerlimitchecks.length>0&&(a.limitChecks=o.offerlimitchecks),r[i]=a}else{a={id:"default",conditions:_MetricalAbandonCart.conditions,engagements:_MetricalAbandonCart.Config.engagements||_MetricalAbandonCart.Config.offers||[],tags:_MetricalAbandonCart.Config.tags||{},globalofferlimit:_MetricalAbandonCart.Config.globalofferlimit||null,globalofferlimittimeout:_MetricalAbandonCart.Config.globalofferlimittimeout||null,offerflowtag:_MetricalAbandonCart.Config.offerflowtag||null,eligibilityrules:_MetricalAbandonCart.Config.eligibilityrules||"",offerflowisactive:_MetricalAbandonCart.Config.offerflowisactive||!0,namespace:n,da:new _MetricalOfferFlowDataAccess({namespace:_MetricalAbandonCart.Config.experiments[0].name||"default",storageDriver:_MetricalAbandonCart.Config.storagedriver},mBrowser,_MetricalAbandonCart,_MetricalIdentity,_MetricalHosts.endpoints.offerFlow),engagementFunction:t,testMode:_MetricalTestMode,revision:_MetricalAbandonCart.Config.revision,abandonprobable:_MetricalAbandonCart.abandonprobable,logger:_MetricalAbandonCart.logger.child({module:"offerflow"}),browser:mBrowser,identity:_MetricalIdentity,defaultOfferFlowType:_MetricalAbandonCart.Config.offerflowtype||null};_MetricalAbandonCart.Config.experiments&&(a.experiments=_MetricalAbandonCart.Config.experiments),_MetricalAbandonCart.Config.offerlimitchecks&&_MetricalAbandonCart.Config.offerlimitchecks.length>0&&(a.limitChecks=_MetricalAbandonCart.Config.offerlimitchecks),r.default=a}for(var i in r){var s=r[i];_MetricalAbandonCart.logger.debug("OF Properties",{ofProperties:s}),_MetricalAbandonCart.offerFlows[i]=new _MetricalOfferFlowClass(s)}if(_MetricalAbandonCart.Config.gacapturepresented){var c=function(e){_MetricalAbandonCart.logger.debug("processing GA presented event"),new _MetricalGA({logger:_MetricalAbandonCart.logger.child({module:"ga"}),isactive:_MetricalAbandonCart.Config.gaisactive}).record("presented",{session_id:e.session_id,testgroup:e.testgroup})};_MetricalAbandonCart.logger.debug("registering offer-presented and offer-not-presented callbacks for GA"),_MetricalOfferFlow.pubsub.subscribe("offer-presented",c),_MetricalOfferFlow.pubsub.subscribe("offer-not-presented",c)}_MetricalAbandonCart.Config.useprobabilityengine&&_MetricalPE.subscribe("post/pe",function(e){for(var t in _MetricalAbandonCart.offerFlows)_MetricalAbandonCart.offerFlows[t].properties.abandonprobable=e}),_MetricalAbandonCart.logger.info("Finalized the bootstrap of the AbandonHandler object",this),1==!!_MetricalAbandonCart.Config.cxflows&&_MetricalAbandonCart.Config.cxflowsisactive&&1==_MetricalAbandonCart.Config.cxflowsisactive&&(this.cxflow=new _MetricalCxFlow({conditions:_MetricalAbandonCart.conditions,cxflows:_MetricalAbandonCart.Config.cxflows||[],utils:_MetricalUtils,logger:_MetricalAbandonCart.logger.child({module:"cxflows"})}));var l=_MetricalAbandonCart.storage.getItem(_MetricalAbandonCart.suppressionKey)||_MetricalAbandonCart.isSuppressed;_MetricalUserEvents.subscribe("interact",function(e){_MetricalAbandonCart.dataPoints.evaluate(),0==(_MetricalAbandonCart.storage.getItem(_MetricalAbandonCart.suppressionKey)||_MetricalAbandonCart.isSuppressed)?_MetricalAbandonCart.AbandonHandler.evaluate(e):_MetricalAbandonCart.logger.debug("Metrical is suppressed, skipping evaluate")}),window.onbeforeunload=function(e){_MetricalIdentity.setLastTimestamp()},_MetricalAbandonCart.dataPoints.evaluate(),0==l?_MetricalAbandonCart.AbandonHandler.evaluate(new Event("abandonHandlerBootstrap")):_MetricalAbandonCart.logger.debug("Metrical is suppressed, skipping evaluate")},evaluate:function(e){var t=this;if(0==mBrowser.document().hidden){for(var r in _MetricalAbandonCart.offerFlows){var i=_MetricalAbandonCart.offerFlows[r],o=i.isVisible&&0==i.isClosed();this.evaluatingConditions[r]||o||(this.evaluatingConditions[r]=!0,i.executeEngagementLoop().then(function(e){t.evaluatingConditions[r]=!1}).catch(function(e){throw e}))}null===t.cxflow||t.evaluatingCxFlow||(t.evaluatingCxFlow=!0,t.cxflow.executeEngagementLoop().then(function(e){t.evaluatingCxFlow=!1}).catch(function(e){throw e}))}}},Config:{abandoncartid:null,proto:"https:"==window.location.protocol?"https://":"http://",apiendpointhost:_MetricalHosts.legacy.apiendpointhost,staticendpointhost:_MetricalHosts.legacy.staticendpointhost,probabilityenginehost:_MetricalHosts.legacy.probabilityenginehost,probabilityenginetesthost:_MetricalHosts.legacy.probabilityenginetesthost,configlocation:"survey_files",triggersinglepromofor:"user",useprobabilityengine:!1,onlyshowsingleoffer:!1,usecookieoverlocal:!1,debugisactive:!1,heartbeatisactive:!0,heartbeatinterval:10,idleisactive:!0,idleinterval:30,experimental:!1,offerflowisactive:!0,interactionModificationCallback:void 0,revisitsisactive:!1,revisitsnamespace:"default",endpointoverrides:null,interactionobservers:[],interactions:{type:"ecommerce",capture_clicks_is_active:!1,capture_clicks_filters:void 0,capture_clicks_targets:void 0,capture_forms_is_active:!1,capture_forms_filters:void 0,capture_forms_whitelist:void 0,capture_forms_blacklist:void 0},savelocalinteractions:!1,interactionOverrides:{},interactionUsermetaOverrides:{},datapointsisactive:!1,datapoints:[],monitor:{styles:null},storagesyncisactive:!1,offerflows:null,storage:{},pageIdleMinutes:30,capturecopytextinteraction:!1,captureselectedtextinteraction:!1,run:{},usermeta:null,topicresponse:{},topicpublish:{local:[]},pagetype:{isactive:!0,types:{Home:[],CLP:[],PLP:[],PDP:[],Landing:[],Search:[],Content:[],Other:[],Account:[],Cart:[],Checkout:[],OrderConfirmation:[]}},usemcartusermeta:!1,uselegacyusermeta:!1,gaisactive:!1,gacapturepresented:!1,gacaptureinteraction:!1,heartbeat:{isactive:!1},loadConfigData:function(e,t,r){var i=this;if(void 0!==t.proto&&(this.proto=t.proto),void 0!==t.staticendpointhost&&(this.staticendpointhost=t.staticendpointhost),void 0!==t.apiendpointhost&&(this.apiendpointhost=t.apiendpointhost),void 0!==t.probabilityenginehost&&(this.probabilityenginehost=t.probabilityenginehost),void 0!==t.probabilityenginetesthost&&(this.probabilityenginetesthost=t.probabilityenginetesthost),void 0!==t.configlocation&&(this.configlocation=t.configlocation),void 0!==t.interactionModificationCallback&&(this.interactionModificationCallback=t.interactionModificationCallback),void 0!==e){this.abandoncartid=e;var o=this.proto+this.staticendpointhost+"/";o=""!=this.configlocation?o+this.configlocation+"/"+e+".json":o+e+".json",_MetricalAbandonCart.logger.debug("config url",{url:o}),mBrowser.get(o).then(function(e){if(_MetricalAbandonCart.logger.trace("config fetch promise handler"),_MetricalAbandonCart.logger.debug("fetched data",{data:e}),mBrowser.each(e,function(e,t){i.addProperty(e,t)}),_MetricalAbandonCart.logger.info("Configuration loaded",i),i.importProperties(),null==i.isactive||0!=i.isactive){if(null!==i.endpointoverrides)for(var t in i.endpointoverrides)t in _MetricalHosts.endpoints&&(_MetricalAbandonCart.logger.info("Replacing endpoint "+t+" value "+_MetricalHosts.endpoints[t]+" with "+i.endpointoverrides[t]),_MetricalHosts.endpoints[t]=i.endpointoverrides[t]);assetsToLoad=[],null!=e.assets&&mBrowser.each(e.assets,function(e,t){assetsToLoad.push(t)}),_MetricalSamplingDataAccess.init({namespace:"default",useCookieOverLocal:_MetricalAbandonCart.Config.usecookieoverlocal},_MetricalAbandonCart),_MetricalSampling.init(_MetricalAbandonCart.Config,_MetricalSamplingDataAccess),_MetricalTrafficControl.init(_MetricalAbandonCart.Config,_MetricalSampling,_MetricalAbandonCart.Log),_MetricalAbandonCart.logger.info("Checking traffic control"),_MetricalTrafficControl.isExecutionGranted()?(_MetricalAbandonCart.logger.info("The traffic control policies allowed the execution, keep loading..."),mBrowser.each(_MetricalAbandonCart.Config,function(e,t){"cx"==e&&(asset={type:"json",url:_MetricalAbandonCart.Config.proto+_MetricalAbandonCart.Config.staticendpointhost+"/"+_MetricalAbandonCart.Config.configlocation+"/"+t.surveyid+".json"},assetsToLoad.push(asset)),"promos"==e&&mBrowser.each(t,function(e,t){void 0!==t.isactive&&1!=t.isactive||(asset={type:"json",url:_MetricalAbandonCart.Config.proto+_MetricalAbandonCart.Config.staticendpointhost+"/"+_MetricalAbandonCart.Config.configlocation+"/"+t.survey+".json"},assetsToLoad.push(asset))})}),_MetricalAssetLoader.logger=_MetricalAbandonCart.logger.child({module:"assetloader"}),_MetricalAssetLoader.init(mBrowser,{assets:assetsToLoad},function(){assetsFromJSON=[],mBrowser.each(_MetricalAssetLoader.assetsJSON,function(e,t){jsonData=_MetricalAbandonCart.Config.getAssetsDataFromJSON(t),assetsFromJSON.push.apply(assetsFromJSON,jsonData)}),_MetricalAssetLoader.init(mBrowser,{assets:assetsFromJSON},function(){r&&r()}),_MetricalAssetLoader.exec()}),_MetricalAssetLoader.exec()):(msg="The AC library will not be loaded due to traffic control policies",_MetricalAbandonCart.logger.warning(msg))}}).catch(function(e){_MetricalAbandonCart.logger.error({error:e})})}else _MetricalAbandonCart.logger.error("There are missing required parameters in the loadConfigData call")},addProperty:function(e,t){this[e]=t},importProperties:function(){mBrowser.each(_MetricalAbandonCart.passedInProperties,function(e,t){void 0!==_MetricalAbandonCart.Config[e]&&"cx"!=e&&"usermeta"!=e&&(_MetricalAbandonCart.Config[e]=t),"cx"==e&&(null!=_MetricalAbandonCart.Config.cx?mBrowser.each(t,function(e,t){_MetricalAbandonCart.Config.cx[e]=t}):_MetricalAbandonCart.Config.cx=t)})},getAssetsDataFromJSON:function(e){var t=[];return null!=e.defaultstylesheet&&(url=_MetricalAbandonCart.Config.proto+_MetricalAbandonCart.Config.staticendpointhost+e.defaultstylesheet,t.push({type:"css",url:url})),null!=e.css&&mBrowser.each(e.css,function(e,r){t.push({type:"css",url:r})}),null!=e.js&&mBrowser.each(e.js,function(e,r){t.push({type:"js",url:r})}),t}}},mBrowser=new _MetricalBrowser;_MetricalAssets=function(e){var t={browser:new _MetricalBrowser,logger:new _MetricalLogger({extra:{module:"assets"}})};t.document=t.browser.document(),this.properties=Object.assign({},t,e||{}),this.logger=this.properties.logger,this.document=this.properties.document},_MetricalAssets.prototype.load=function(e){var t=this;assets=Array.isArray(e)?e:[e];var r=assets.map(function(e){return t.loadAsset(e)});return Promise.all(r)},_MetricalAssets.prototype.loadAsset=function(e){var t=this;return new Promise(function(r,i){if(0==!!e.url)throw new Error("loadAsset() expects an asset object with a url property");if(0==!!e.type)throw new Error("loadAsset() expects an asset object with a type property");var o={css:function(e){var r=t.document.createElement("link");return r.rel="stylesheet",r.href=e.url,{element:r,parent:t.document.head}},js:function(e){var r=t.document.createElement("script");return r.type="text/javascript",r.src=e.url,{element:r,parent:t.document.body}},default:function(e){i(new Error("Could not process unknown type "+e.type))}},{element:n,parent:a}=(o[e.type]||o.default)(e);n.onload=function(){t.logger.debug("loading asset success",{asset:e}),r(!0)},n.onerror=function(){t.logger.error("loading asset failure",{asset:e}),i(new Error("Failed to load asset "+e.url))},t.logger.debug("appending asset",{asset:e}),a.append(n)})},_MetricalUserEvents={events:{},interacted:{},handles:{},init:function(e){var t={interactIntervals:[],document:document,window:window,throttle:_MetricalUtils.throttle,debounce:_MetricalUtils.debounce,logger:new _MetricalLogger({extra:{module:"userevents"}})};if(this.properties=Object.assign({},t,e||{}),this.logger=this.properties.logger,this.events={},this.interacted={},this.handles={},this.lastPageYOffset=0,this.lastPercentChange=0,this.interactTimer=null,this.properties.interactIntervals.length>0){var r=this;this.properties.interactIntervals.forEach(function(e){r.interacted[e.interval]=!1})}this._initializeEvents()},hasIntervals:function(){return this.properties.interactIntervals.length>0},addInterval:function(e,t){0==this.properties.interactIntervals.map(function(e){return e.topic}).includes(t)&&(this.properties.interactIntervals.push({interval:e,topic:t}),this.interacted[e]=!1)},_setInteracted:function(){if(this.properties.interactIntervals.length>0){var e=this;this.properties.interactIntervals.forEach(function(t){e.interacted[t.interval]=!0})}},startIntervals:function(){var e=this;this.properties.interactIntervals.length>0&&this.properties.interactIntervals.forEach(function(t){var r=t.interval,i=t.topic,o=1e3*r;e.handles[r]=setInterval(function(){e.publish(i,{hasInteracted:e.interacted[r]}),e.interacted[r]=!1},o)})},scrollPercent:function(){var e=document.documentElement,t=document.body,r="scrollTop",i="scrollHeight";return(e[r]||t[r])/((e[i]||t[i])-e.clientHeight)*100},initializeForms:function(e,t,r){var i=this;i.logger.traceStart("initializeForms"),void 0===t&&(t=[]),void 0===r&&(r=[]),i.checkFilters(e)?(i.logger.debug("Filter check passed for initializeForms"),i.properties.document.addEventListener("change",function(e){var o=((e=e||i.properties.window.event).target||e.srcElement).closest("form");if(o){var n=o.id,a=r.includes(n),s=t.includes(n);if(i.logger.debug("Whitelist and Blacklist results",{inBlacklist:a,inWhitelist:s}),0==a&&(0==t.length||1==s)){var c=i.formData(o);i.logger.debug("Form data",{data:c}),i.publish("capture-form",c)}}})):i.logger.debug("Filter check failed for initializeForms"),i.logger.traceEnd("initializeForms")},formData:function(e){var t=new FormData(e),r={};for(var i of t.entries()){var o=i[0],n=i[1];if(o in r&&0==Array.isArray(r[o])){var a=r[o];r[o]=[],r[o].push(a),r[o].push(n)}else 1==Array.isArray(r[o])?r[o].push(n):r[o]=n}return{formId:e.id||e.name||"unknown",fromData:r}},checkFilters:function(e){var t=this;return void 0===e&&(e={}),(e=Array.isArray(e)?e:[e]).reduce(function(e,r){var i="url"in r?r.url:".*",o="eval"in r?r.eval:"true",n=_MetricalUtils.testRegex(i,t.properties.window.location.href),a=_MetricalUtils.evaluate(o);return n&&a&&(e=!0),e},!1)},initializeClicks:function(e,t){var r=this;r.logger.traceStart("initializeClicks"),void 0===t&&(t=[{tag:"input"},{tag:"button"},{tag:"select"},{tag:"textarea"},{tag:"a"},{tag:"area"}]),t=Array.isArray(t)?t:[t],r.checkFilters(e)?(r.logger.debug("Filter check passed for initializeClicks"),r.properties.document.addEventListener("click",function(e){var i=(e=e||window.event).target||e.srcElement;t.forEach(function(e){var t=i.closest(e.tag);if(t){var o=!0;if("class"in e){var n=Array.isArray(e.class)?e.class:[e.class],a=t.classList;o=1!=n.map(function(e){return a.contains(e)}).includes(!1)}else o=!0;o&&r.publish("capture-click",t)}})},!1)):r.logger.debug("Filter check failed for initializeClicks"),r.logger.traceEnd("initializeClicks")},initializePageLeave:function(){var e=this;e.logger.traceStart("initializePageLeave"),e.properties.document.addEventListener("visibilitychange",function(t){"hidden"===e.properties.document.visibilityState&&e.publish("unload",t)}),e.logger.traceEnd("initializePageLeave")},_initializeEvents:function(){var e=this,t=e.properties.throttle(function(t){e.publish("interact",t)},750);e.properties.window.addEventListener("mousemove",e.properties.debounce(function(r){e._setInteracted(),e.publish("mousemove",r),t(r)},250)),e.properties.window.addEventListener("scroll",e.properties.debounce(function(r){e._setInteracted(),e.publish("scroll",r),t(r);var i=Math.max(e.properties.window.pageYOffset||0,e.properties.window.scrollY||0),o=e.scrollPercent();if(i>e.lastPageYOffset){var n=o-e.lastPercentChange;e.publish("scrolldown",r,{percent:o,percentDelta:n})}if(i<e.lastPageYOffset){n=e.lastPercentChange-o;e.publish("scrollup",r,{percent:o,percentDelta:n})}e.lastPageYOffset=i,e.lastPercentChange=o},250)),e.properties.window.addEventListener("keydown",function(r){e._setInteracted(),e.publish("keydown",r),t(r)}),e.properties.window.addEventListener("click",function(r){e._setInteracted(),e.publish("click",r),t(r)}),e.properties.window.addEventListener("touchstart",function(r){e._setInteracted(),t(r)}),e.properties.window.addEventListener("touchmove",e.properties.debounce(function(r){e._setInteracted(),t(r)},250)),e.properties.document.addEventListener("mouseout",function(t){var r=void 0;"toElement"in t&&(r=t.toElement),"relatedTarget"in t&&(r=t.relatedTarget),null===r&&e.publish("documentout",t)}),e.properties.window.addEventListener("resize",e.properties.debounce(function(t){e.publish("resize",t)},250)),e.properties.document.addEventListener("mouseup",function(t){var r="";window.getSelection?r=window.getSelection().toString():document.selection&&(r=document.selection.createRange().text),r&&e.publish("textSelect",r)}),e.properties.document.addEventListener("copy",function(t){var r=e.properties.document.getSelection();r&&(r=r.toString())&&e.publish("copy",r)}),this.interactTimer=setInterval(t,2e3)},initializeOnSubscribe:function(e){var t=this.events[e]||!1;if(Array.isArray(t)&&0===t.length)switch(e){case"unload":this.initializePageLeave()}},subscribe:function(e,t){var r=this.events[e];!1==!!r&&(r=this.events[e]=[]),"function"==typeof t&&(this.initializeOnSubscribe(e),r.push(t))},unsubscribe:function(e,t){var r=this.events[e];if(!1!=!!r){var i=r.indexOf(t);r.splice(i)}},publish:function(e,t,r){var i=this.events[e];!1!=!!i&&i.forEach(function(e){"function"==typeof e&&e.call(this,t,r)})}},_MetricalLocalTime=function(e){this.defaultParams={storage:_MetricalAbandonCart.storage||null},this.params=Object.assign({},this.defaultParams,e||{}),this.overrideKeyName="ltor"},_MetricalLocalTime.prototype.localTime=function(){var e=this.getOverrideValue();return e||(new Date).getTime()},_MetricalLocalTime.prototype.getOverrideValue=function(){return this.params.storage.getItem(this.overrideKeyName)},_MetricalLocalTime.prototype.setOverrideValue=function(e){var t=new Date(e).getTime();return this.params.storage.setItem(this.overrideKeyName,t)},_MetricalLocalTime.prototype.removeOverrideValue=function(){return this.params.storage.removeItem(this.overrideKeyName)},_MetricalRevisits=function(e){if(this.defaultParams={storage:null,namespace:null,resetPoints:[]},this.params=Object.assign({},this.defaultParams,e||{}),this.overrideKeyName="ltor",0==!!this.params.storage)throw new Error("A valid storage engine needs to be passed to revisits.");if(0==!!this.params.namespace)throw new Error("A valid namespace needs to be passed to revisits.");this.key="revisits_"+this.params.namespace,this.storage=this.params.storage,this.resetPoints=this.params.resetPoints},_MetricalRevisits.prototype.resetPoint=function(){var e=new _MetricalLocalTime({storage:this.storage}).localTime(),t=this.resetPoints.map(function(e){return new Date(e).getTime()});return t.sort(function(e,t){return t-e}),t.reduce(function(t,r){return null===t&&r<=e&&(t=r),t},null)},_MetricalRevisits.prototype.record=function(e){var t=this.storage.getItem(this.key)||{},r=this.resetPoint();if(null!==r&&(t=Object.keys(t).reduce(function(e,i){var o=t[i];return o>r&&(e[i]=o),e},{}),this.storage.setItem(this.key,t)),!(e in t)){var i=new _MetricalLocalTime({storage:this.storage}).localTime();t[e]=i,this.storage.setItem(this.key,t)}},_MetricalRevisits.prototype.recordCount=function(){var e=this.storage.getItem(this.key)||{};return Object.keys(e).length||0},_MetricalGroups=function(e){if(this.params=Object.assign({},{storageKey:"groups"},e),0==!!this.params.storage)throw new Error("A storage object needs to be supplied to the _MetricalGroups class");if(0==!!this.params.groups)throw new Error("A groups object needs to be supplied to the _MetricalGroups class")},_MetricalGroups.prototype.reset=function(){this.params.storage.removeItem(this.params.storageKey)},_MetricalGroups.prototype.randomNumber=function(e){return Math.floor(Math.random()*e+1)},_MetricalGroups.prototype.groupItem=function(e){var t=this.params.storage.getItem(this.params.storageKey),r={};if(null!==t&&"ttl"in t){var i=t.ttl;(new Date).getTime()>i&&(t=null)}return t?r=t.obj||{}:(r=this.assignGroupItems(),t={ttl:(new Date).getTime()+18e5,obj:r},this.params.storage.setItem(this.params.storageKey,t)),e in r?r[e]:null},_MetricalGroups.prototype.assignGroupItems=function(){var e=this;return Object.keys(this.params.groups).reduce(function(t,r){var i=e.params.groups[r],o=i.upper,n=e.randomNumber(o);return t[r]=e.findItem(i.items,n),t},{})},_MetricalGroups.prototype.findItem=function(e,t){return Object.keys(e).reduce(function(r,i){return(Array.isArray(e[i])?e[i]:[e[i]]).includes(t)&&(r=i),r},null)},_MetricalLocalInteractions=function(e){this.defaultProperties={storage:_MetricalStorage.SessionStorage||null,utils:_MetricalUtils||null,uuid:null,sessionId:null,keyName:"lint"},this.properties=Object.assign({},this.defaultProperties,e||{}),this.storage=this.properties.storage,this.utils=this.properties.utils},_MetricalLocalInteractions.prototype.record=function(e){var t=this,r=this.all().filter(function(e){return t.properties.sessionId==e.session_id&&t.properties.uuid==e.uuid});return r.push(e),this.storage.setItem(this.properties.keyName,r)},_MetricalLocalInteractions.prototype.all=function(){return this.storage.getItem(this.properties.keyName)||[]},_MetricalLocalInteractions.prototype.values=function(e){if("string"!=typeof e)throw new Error("LocalInteractions.value() expects to receive a string denoting an object path");e=void 0===e?"":e;var t=this;return t.all().map(function(r){return t.utils.get(r,e)})},_MetricalDataPoints=function(e){this.defaultProperties={storage:null,utils:_MetricalUtils||null,keyName:"dp",config:[]},this.properties=Object.assign({},this.defaultProperties,e||{}),this.storage=this.properties.storage,this.utils=this.properties.utils},_MetricalDataPoints.prototype.evaluate=function(){var e=this.all();this.properties.config.forEach(function(t){var r=_MetricalUtils.evaluate(t.eval);"target"in t&&t.key in e?e[t.key]!==t.target&&(e[t.key]=r):e[t.key]=r}),this.record(e)},_MetricalDataPoints.prototype.record=function(e){var t=this.all();return this.storage.setItem(this.properties.keyName,Object.assign({},t,e))},_MetricalDataPoints.prototype.all=function(){return this.storage.getItem(this.properties.keyName)||{}},_MetricalDataPoints.prototype.get=function(e){var t=this.all();return e in t?t[e]:null},_MetricalConditions=function(e){this.params=Object.assign({},{conditions:{}},e),this.conditionsList=[],this.prepareConditions()},_MetricalConditions.prototype.prepareConditions=function(){var e=this;this.conditionsList=Object.keys(this.params.conditions).map(function(t){var r=e.params.conditions[t],i="object"==typeof r&&"conditiontype"in r?r.conditiontype:"default";return new(e.conditionClass(i))(t,r)})},_MetricalConditions.prototype.conditionClass=function(e){var t={couponcheckcondition:function(){return _MetricalCouponCheckCondition},hascategorycondition:function(){return _MetricalHasCategoryCondition},urlcondition:function(){return _MetricalUrlCondition},devicetypecondition:function(){return _MetricalDeviceTypeCondition},randomsamplecondition:function(){return _MetricalRandomSampleCondition},cartcontainscondition:function(){return _MetricalCartContainsCondition},basiccondition:function(){return _MetricalBasicCondition},default:function(){return _MetricalDefaultCondition}};return(t[e]||t.default)()},_MetricalConditions.prototype.overrides=function(){var e={};return _MetricalAbandonCart.storage.hasItem("oc")&&(e=_MetricalAbandonCart.storage.getItem("oc")),e},_MetricalConditions.prototype.evaluateConditions=function(e){var t=this;return new Promise(function(r,i){try{var o={},n=t.overrides()||{};void 0===e&&(e=[]),e=Array.isArray(e)?e:[e];var a=t.conditionsList.reduce(function(t,r){return(0==e.length||e.includes(r.id))&&t.push(r.evaluate(o)),t},[]);Promise.all(a).then(function(e){const t=e.reduce(function(e,t){return e[t.id]=t.val,e},{});r(Object.assign({},t,n))}).catch(function(e){i(e)})}catch(e){i(e)}})},_MetricalDefaultCondition=function(e,t){this.id=e,this.params=t},_MetricalDefaultCondition.prototype.evaluate=function(){var evalString=this.params;try{return{id:this.id,val:eval(evalString)}}catch(e){var newMessage=e.toString()+": "+evalString;throw new Error(newMessage)}},_MetricalBasicCondition=function(e,t){this.id=e,this.params=t,this.firstOperand=t.properties.firstoperand,this.operator=t.properties.operator,this.secondOperand=t.properties.secondoperand},_MetricalBasicCondition.prototype.getValueFromOperand=function(operand){var value=null;if("html"==operand.type){var el=_MetricalUtils.querySelector(operand.selector);value=el?this.getDataFromElement(el,operand.selectortype):null}else"constant"==operand.type?value=operand.value:"eval"==operand.type&&(value=eval(operand.value));return 1==operand.numeric&&null!=value&&null!=value&&"string"==typeof value&&(value=value.replace(/[^\d.-]/g,"")),value},_MetricalBasicCondition.prototype.getDataFromElement=function(e,t){var r=null;return e.length>0&&(e=e[0]),null!=e&&("image"==t?r=e.src:"tag"==t?r=e.textContent:"input"==t?r=e.value:"input-id"==t?r.push(e.id):"a"==t?r.push(e.href):"select"==t&&(r=e.options[e.selectedIndex].value)),r},_MetricalBasicCondition.prototype.evaluate=function(){try{var that=this,firstValue=this.getValueFromOperand(this.firstOperand),secondValue=this.getValueFromOperand(this.secondOperand);if(firstValue instanceof Array){var evalParts=[];firstValue.forEach(function(val,key){"string"==typeof val&&0==val.length||"string"==typeof secondValue&&0==secondValue.length?res=val==secondValue:res=eval(val+" "+that.operator+" "+secondValue),evalString+=res+" || ",evalParts.push(res)});var evalString=evalParts.join(" || ");result=eval(evalString)}else if(secondValue instanceof Array){var evalParts=[];secondValue.forEach(function(val,key){"string"==typeof val&&0==val.length||"string"==typeof firstValue&&0==firstValue.length?res=val==firstValue:res=eval(firstValue+" "+that.operator+" "+val),evalParts.push(res)});var evalString=evalParts.join(" || ");result=eval(evalString)}else result=null!=firstValue&&null!=secondValue?eval(firstValue+" "+this.operator+" "+secondValue):void 0;return{id:that.id,val:result}}catch(e){throw new Error("BasicCondition Error - "+e.message+" - "+JSON.stringify(that.params))}},_MetricalRandomSampleCondition=function(e,t){if(this.id=e,this.params=t,this.upper="upper"in t.properties&&t.properties.upper>1?t.properties.upper:2,this.groupid="groupid"in t.properties?t.properties.groupid:"default",!("equal"in t.properties))throw new Error("Condition ramdomsamplecondition requires an equal property to be set");this.equal=Array.isArray(t.properties.equal)?t.properties.equal:[t.properties.equal]},_MetricalRandomSampleCondition.prototype.randomNumber=function(){return Math.floor(Math.random()*this.upper+1)},_MetricalRandomSampleCondition.prototype.evaluate=function(e){if("rand"in e||(e.rand={}),!(this.groupid in e.rand)){var t=this.randomNumber();e.rand[this.groupid]=t}var r=e.rand[this.groupid];return{id:this.id,val:this.equal.includes(r)}},_MetricalUrlCondition=function(e,t){if(this.id=e,this.params=t,!("urlvalue"in this.params.properties))throw new Error("Condition urlcondition requires a urlvalue property to be set");this.urlPatterns=Array.isArray(this.params.properties.urlvalue)?this.params.properties.urlvalue:[this.params.properties.urlvalue],this.href="href"in this.params.properties?this.params.properties.href:window.location.href},_MetricalUrlCondition.prototype.evaluate=function(e){var t=this,r=1==this.urlPatterns.map(function(e){return new RegExp(e).test(t.href)}).includes(!0);return{id:this.id,val:r}},_MetricalDeviceTypeCondition=function(e,t){if(this.id=e,this.params=t,!("devicesallowed"in this.params.properties))throw new Error("Condition devicetype requires a devicesallowed property to be set");this.devicesAllowed=Array.isArray(this.params.properties.devicesallowed)?this.params.properties.devicesallowed:[this.params.properties.devicesallowed]},_MetricalDeviceTypeCondition.prototype.evaluate=function(e){var t=_MetricalUtils.determineDevice(),r=1==this.devicesAllowed.includes(t);return{id:this.id,val:r}},_MetricalPECondition=function(e,t){if(this.id=e,this.params=t,!("model"in this.params.properties))throw new Error("Condition PE requires a model property to be set");this.model=this.params.properties.model,this.field=this.params.properties.field?this.params.properties.field:"abandonmentProbable",this.source=_MetricalAbandonCart},_MetricalPECondition.prototype.evaluate=function(e){var t="abandonProbable."+this.model+"."+this.field,r=!!_MetricalUtils.get(this.source,t,!1);return{id:this.id,val:r}},_MetricalCartContainsCondition=function(e,t){if(this.id=e,this.params=t,!("comparisons"in this.params.properties))throw new Error("CartContains requires a comparisons property to be set");this.comparisons=this.params.properties.comparisons,this.logicalOperator=this.params.properties.logicaloperator?this.params.properties.logicaloperator:"AND";var r=_MetricalUtils.get(_MetricalAbandonCart,"passedInProperties.usermeta.cartidlist","");this.source=r?String(r):"",this.items=_MetricalCart.items||{}},_MetricalCartContainsCondition.prototype._checkComparisons=function(e){var t=this.comparisons.map(function(t){var r=t.key,i=t.value,o=e[r]||"";return Array.isArray(i)?i.includes(o):o==i});return"OR"==this.logicalOperator?!!t.includes(!0):!t.includes(!1)},_MetricalCartContainsCondition.prototype.evaluate=function(e){var t=this,r=_MetricalUtils.get(_MetricalAbandonCart,"passedInProperties.usermeta.cartidlist","");t.source=r?String(r):"",t.items=_MetricalCart.items||{};var i=!!_MetricalUtils.plusDelimitedParts(t.source).reduce(function(e,r){var i=t.items[r]||{};return t._checkComparisons(i)&&(e=!0),e},!1);return{id:this.id,val:i}},_MetricalHasCategoryCondition=function _MetricalHasCategoryCondition(id,params){if(this.id=id,this.params=params,!("source"in this.params.properties))throw new Error("Condition HasCategory requires a source property to be set");if(!("comparison"in this.params.properties))throw new Error("Condition HasCategory requires a comparison property to be set");var comparisonValue=eval(this.params.properties.comparison),sourceValue=eval(this.params.properties.source);this.comparison=Array.isArray(comparisonValue)?comparisonValue:[comparisonValue],this.source=Array.isArray(sourceValue)?sourceValue:[sourceValue]},_MetricalHasCategoryCondition.prototype.evaluate=function(context){var that=this,comparisonValue=eval(this.params.properties.comparison),sourceValue=eval(this.params.properties.source);this.comparison=Array.isArray(comparisonValue)?comparisonValue:[comparisonValue],this.source=Array.isArray(sourceValue)?sourceValue:[sourceValue];var intersectionList=_MetricalUtils.intersection(this.source,this.comparison),val=intersectionList.length>0;return{id:this.id,val:val}},_MetricalCouponCheckCondition=function(e,t){if(this.id=e,this.params=t,!("sourceurl"in this.params.properties))throw new Error("Condition CouponCheck requires a sourceurl property to be set");if(!("code"in this.params.properties))throw new Error("Condition CouponCheck requires a code property to be set");if(!("cutoff"in this.params.properties))throw new Error("Condition CouponCheck requires a cutoff property to be set");this.sourceUrl=this.params.properties.sourceurl,this.code=this.params.properties.code,this.cutoff=this.params.properties.cutoff,this.sessionKey="couponcheck"},_MetricalCouponCheckCondition.prototype.evaluate=function(e){var t=this;return new Promise(function(e,r){var i=_MetricalStorage.SessionStorage.getItem(t.sessionKey);Promise.resolve(i);(i?Promise.resolve(i):mBrowser.get(t.sourceUrl)).then(function(r){(_MetricalStorage.SessionStorage.setItem(t.sessionKey,r),t.code in r)?r[t.code]>t.cutoff?e({id:t.id,val:!0}):e({id:t.id,val:!1}):e({id:t.id,val:!1})}).catch(function(e){r(e)})})},_MetricalEngagementLimits=function(e,t){if("object"!=typeof e)throw new Error("EngagementLimits expects an engagement object");if(0==Array.isArray(t))throw new Error("EngagementLimits expects an engagementsShown array");this.engagement=e,this.engagementsShown=t.slice(),this.engagementsShown.sort(function(e,t){return e.ts-t.ts})},_MetricalEngagementLimits.prototype.campaignLimit=function(e,t){var r=this;if(t&&Object.keys(t).map(function(e){var i=t[e];return e in r.engagement&&r.engagement[e]==i}).includes(!1))return!1;var i=r.engagement.campaign||void 0;return this.engagementsShown.filter(function(e){return e.campaign==i}).length>=e},_MetricalEngagementLimits.prototype.servedInLast24Hours=function(e,t){var r=this;if(t&&Object.keys(t).map(function(e){var i=t[e];return e in r.engagement&&r.engagement[e]==i}).includes(!1))return!1;var i=(new Date).getTime()-864e5;return this.engagementsShown.filter(function(e){return e.ts>=i}).length>=e},_MetricalDimensions=function(e){const t={document:document||null,window:window||null};this.properties=Object.assign({},t,e||{})},_MetricalDimensions.prototype.documentWidth=function(){return Math.max(this.properties.document.body.clientWidth||0,this.properties.document.documentElement.clientWidth||0,this.properties.window.innerWidth||0)},_MetricalDimensions.prototype.documentHeight=function(){return Math.max(this.properties.document.body.clientHeight||0,this.properties.document.documentElement.clientHeight||0,this.properties.window.innerHeight||0)},_MetricalDimensions.prototype.viewPortWidth=function(){return Math.max(this.properties.document.documentElement.clientWidth||0,this.properties.window.innerWidth||0)},_MetricalDimensions.prototype.viewPortHeight=function(){return Math.max(this.properties.document.documentElement.clientHeight||0,this.properties.window.innerHeight||0)},_MetricalDimensions.prototype.browserWidth=function(){return this.properties.window.outerWidth||0},_MetricalDimensions.prototype.browserHeight=function(){return this.properties.window.outerHeight||0},_MetricalDimensions.prototype.screenWidth=function(){return this.properties.window.screen.width||0},_MetricalDimensions.prototype.screenHeight=function(){return this.properties.window.screen.height||0},_MetricalExitIntent=function(e){if(this.properties=Object.assign({},{yStart:0,yThickness:10,leftZoneSize:200,rightZoneSize:200,dimensions:null},e||{}),!1==!!this.properties.dimensions)throw new Error("Exit intent requires the dimensions module be passed");this.x=null,this.y=null,this.zones=[],this.exitIntents=0,this.lastExitIntentTimestamp=null},_MetricalExitIntent.prototype.hasExitIntent=function(){return this.exitIntents>0},_MetricalExitIntent.prototype.checkForIntent=function(e,t){return this.x=e,this.y=t,1==this.isInZone(this.x,this.y)&&(this.incrementExitIntents(),!0)},_MetricalExitIntent.prototype.incrementExitIntents=function(){this.exitIntents++,this.lastExitIntentTimestamp=(new Date).getTime()},_MetricalExitIntent.prototype.isInZone=function(e,t){return t<=this.properties.yStart+this.properties.yThickness},_MetricalCxLauncher=function(e){var t={config:void 0,acconfig:"object"==typeof _MetricalAbandonCart&&_MetricalAbandonCart.Config||void 0,metricalObj:"object"==typeof _Metrical?_Metrical:void 0,document:mBrowser.document()||void 0,jQuery:mBrowser.window().jQuery||void 0,pollRate:100,logger:new _MetricalLogger({extra:{module:"cxflows"}})};if(this.properties=Object.assign({},t,e||{}),this.metricalObj=this.properties.metricalObj,this.document=this.properties.document,this.logger=this.properties.logger,0==!!this.properties.jQuery)throw new Error("_MetricalCxLauncher requires the jQuery parameter");if(0==!!this.properties.config)throw new Error("_MetricalCxLauncher requires a config parameter");if(0==!!this.properties.acconfig)throw new Error("_MetricalCxLauncher requires an acconfig parameter");if(0==!!this.properties.metricalObj)throw new Error("_MetricalCxLauncher requires a metricalObj parameter");if(0==!!this.properties.document)throw new Error("_MetricalCxLauncher requires a document parameter")},_MetricalCxLauncher.prototype.execute=function(){var e=this;return new Promise(function(t,r){try{e.logger.traceStart("cxlauncher.execute"),e.metricalObj&&e.metricalObj.app&&e.metricalObj.app.tabCloserTimer&&clearInterval(e.metricalObj.app.tabCloserTimer);var i=e.document.querySelector(".Metrical_lightbox");i&&i.remove();var o=e.document.querySelector(".MetricalContainer");o&&o.remove();var n=Object.assign({},e.properties.config);null==n.apiendpointhost&&(n.apiendpointhost=e.properties.acconfig.apiendpointhost),null==n.staticendpointhost&&(n.staticendpointhost=e.properties.acconfig.staticendpointhost),e.metricalObj.init(e.properties.jQuery,n);var a=0,s=function(){1==e.metricalObj.shouldDisplay&&0==e.metricalObj.waitAdditionalJS?(e.logger.info("cxlauncher is making metrical visible"),e.metricalObj.makeVisible(),clearTimeout(s),t(!0)):a<50?(e.logger.debug("setting up another polling run",{pollRate:e.properties.pollRate}),a++,setTimeout(s,e.properties.pollRate)):(e.logger.debug("stopping polling runs due to limit reached",{pollRate:e.properties.pollRate}),t(!1))};e.logger.debug("starting polling",{pollRate:e.properties.pollRate}),setTimeout(s,e.properties.pollRate),e.logger.traceEnd("cxlauncher.execute")}catch(e){r(e)}})},_MetricalCxFlow=function(e){var t={conditions:void 0,cxflows:[],utils:_MetricalUtils,logger:new _MetricalLogger({extra:{module:"cxflows"}})};if(this.properties=Object.assign({},t,e||{}),0==!!this.properties.conditions)throw new Error("_MetricalCxFlow requires a conditions parameter");this.conditions=this.properties.conditions,this.cxflows=this.properties.cxflows,this.logger=this.properties.logger,this.selectionLog=[],this.isPresenting=!1,this.isClosed=!1},_MetricalCxFlow.prototype.executeEngagementLoop=function(){var e=this;return new Promise(function(t,r){try{e.logger.traceStart("executedEngagementLoop",{module:"cxflowspoll"}),e.isClosed&&t(!1),e.conditions.evaluateConditions().then(function(i){e.logger.debug("cxflows computed conditions",{conditionResults:i,module:"cxflowspoll"});var{selectedFlow:o,selectionLog:n}=e.selectCxSurvey(i);e.logger.debug("cxflows selected flow and log",{selectedFlow:o,selectionLog:n,module:"cxflowspoll"}),e.selectionLog=n,null!==o&&0==e.isPresenting?(e.logger.info("cxflows is presenting a flow"),e.isPresenting=!0,console.log(o),e.launchFlow(o).then(function(r){e.logger.debug("cxflows successfully launched"),e.closeFlow(),t(!0)}).catch(function(t){e.logger.error("cxflows error",{error:t}),e.closeFlow(),r(t)})):t(!0)}).catch(function(t){e.logger.error("cxflows error",{error:t}),r(t)})}catch(t){e.logger.error("cxflows error",{error:t}),r(t)}e.logger.traceEnd("executedEngagementLoop",{module:"cxflowspoll"})})},_MetricalCxFlow.prototype.closeFlow=function(){this.isClosed=!0},_MetricalCxFlow.prototype.selectCxSurvey=function(e){var t=this,r=[],i=[];return this.cxflows.forEach(function(o){var n=o.rule||void 0;if(n){var a=t.properties.utils.evaluateRule(n,e,{}),s=t.properties.utils.ruleCriteriaString(n,e,{});r.push("CxFlow: "+o.id+" - "+s),a&&i.push(o)}}),r.push("Considered CxFlows length after remaining is "+i.length),i.length>0?{selectedFlow:i[0],selectionLog:r}:{selectedFlow:null,selectionLog:r}},_MetricalCxFlow.prototype.launchFlow=function(e){return new _MetricalCxLauncher({logger:this.logger,config:e.cxconfig}).execute()},_MetricalEngagementFactory=function(e){var t={acConfig:null,localOfferFlow:null,bus:null,logger:new _MetricalLogger({extra:{module:"engagement"}})};if(this.params=Object.assign({},t,e),this.logger=this.params.logger,0==!!this.params.acConfig)throw new Error("A valid AC config object needs to be passed to the engagement factory");if(0==!!this.params.localOfferFlow)throw new Error("A valid local offer flow object needs to be passed to the engagement factory")},_MetricalEngagementFactory.prototype.create=function(e){var t=this,r=this.determineType(e);t.logger.debug("engagementType",{engagementType:r});var i=Object.assign({},t.params,{engagement:e});t.logger.debug("inputProperties",{inputProperties:i});var o={autoeval:function(e){return new _MetricalAutoEval(i)},dsgrecommendations:function(e){return new _MetricalEngagementDsgRecommendations(i)},bounceback:function(e){return new _MetricalBounceBack(i)},datacapture:function(e){return new _MetricalEngagementDataCapture(Object.assign({},t.params,{engagement:e}))},offerv4:function(e){return new _MetricalEngagementOfferV4(i)},callbridge:function(e){return new _MetricalCallBridge(i)},offerv2:function(e){return new _MetricalOfferV2(i)},offerv1:function(e){return new _MetricalOfferV1(i)},default:function(e){throw new Error("A default engagement creation behanvior is not defined")}};return o[r](e)||o.default(e)},_MetricalEngagementFactory.prototype.determineType=function(e){if("engagementtype"in e&&"callbridge"==e.engagementtype)return"callbridge";if("engagementtype"in e&&"dsgrecommendations"==e.engagementtype)return"dsgrecommendations";if("engagementtype"in e&&"autoeval"==e.engagementtype)return"autoeval";if("engagementtype"in e&&"datacapture"==e.engagementtype)return"datacapture";if("engagementtype"in e&&"offerv4"==e.engagementtype)return"offerv4";if("couponconfig"in e)return"offerv2";if("survey"in e&&1==!!e.survey&&"none"!=e.survey)return"offerv1";throw new Error("Not able to determine the engagement type")},_MetricalCallBridge=function(e){var t={acConfig:null,engagement:null,localOfferFlow:null,immediatelyPerformBenefit:!0,logger:new _MetricalLogger({extra:{module:"engagement"}})};if(this.params=Object.assign({},t,e),this.logger=this.params.logger,this.performBenefitFunction=function(){},0==!!this.params.engagement)throw new Error("A valid engagement configuration object needs to be passed to callbridge");if(0==!!this.params.acConfig)throw new Error("A valid AC config object needs to be passed to callbridge");if(0==!!this.params.localOfferFlow)throw new Error("A valid offer flow object needs to be passed to callbridge")},_MetricalCallBridge.prototype.performBenefit=function(){this.logger.traceStart("performBenefit"),this.performBenefitFunction(),this.logger.traceEnd("performBenefit")},_MetricalCallBridge.prototype.execute=function(){var e=this;return new Promise(function(t,r){try{e.logger.traceStart("execute");var i=e.params.engagement,o="closestatus"in i?i.closestatus:"dismissed",n="submitstatus"in i?i.submitstatus:"submitted",a=new _MetricalOfferViewV3({view:i.viewconfig,config:e.params.acConfig}),s=Object.assign({},i.couponconfig,{callbackEndpoint:_MetricalHosts.endpoints.callBridge}),c=new _MetricalCoupon({couponConfig:s,logger:e.logger.child({module:"coupon"})}).driver();e.performBenefitFunction=function(){e.logger.debug("running coupon.postCoupon() operation");var t=a.data.index.callBridgeForm.Metrical_phonenumber||null;e.logger.debug("phone number",{phone:t}),c.execute({phoneNumber:t}).then(function(t){e.logger.debug("execute promise",{data:t})}).catch(function(t){e.logger.debug("execute promise rejection",{data:t})})},a.subscribe("click/submit",function(){e.logger.debug("click/submit was called"),e.logger.debug("offerview data",{data:a.data}),1==e.params.immediatelyPerformBenefit&&(e.logger.debug("handler perfoming benefit"),e.performBenefit()),e.params.localOfferFlow.response(n),a.navigate("thankyou")}),a.subscribe("click/close",function(){e.params.localOfferFlow.response(o)}),e.logger.debug("rendering out callbrdige offer"),a.render("index"),e.logger.traceEnd("execute"),t(!0)}catch(e){r(e)}})},_MetricalAutoEval=function(e){var t={acConfig:null,engagement:null,localOfferFlow:null,immediatelyPerformBenefit:!0,logger:new _MetricalLogger({extra:{module:"engagement"}})};if(this.properties=Object.assign({},t,e),this.logger=this.properties.logger,this.performBenefitFunction=function(){},0==!!this.properties.engagement)throw new Error("A valid engagement configuration object needs to be passed to auto eval");if(0==!!this.properties.acConfig)throw new Error("A valid AC config object needs to be passed to auto eval");if(0==!!this.properties.localOfferFlow)throw new Error("A valid offer flow object needs to be passed to auto eval")},_MetricalAutoEval.prototype.performBenefit=function(){this.logger.traceStart("performBenefit"),this.performBenefitFunction(),this.logger.traceEnd("performBenefit")},_MetricalAutoEval.prototype.execute=function(){var that=this;return new Promise(function(resolve,reject){try{that.logger.traceStart("execute"),"autoeval"in that.properties.engagement?(that.logger.debug({autoeval:that.properties.engagement.autoeval}),eval(that.properties.engagement.autoeval),that.properties.localOfferFlow.submitted()):that.logger.warning("autoeval engagement found, but no statement was configured"),that.logger.traceEnd("execute"),resolve(!0)}catch(e){reject(e)}})},_MetricalEngagementDataCapture=function(e){var t={acConfig:null,engagement:null,localOfferFlow:null,immediatelyPerformBenefit:!0,bus:null,logger:new _MetricalLogger({extra:{module:"engagement"}})};if(this.properties=Object.assign({},t,e),this.logger=this.properties.logger,this.performBenefitFunction=function(){},0==!!this.properties.engagement)throw new Error("A valid engagement configuration object needs to be passed to data capture");if(0==!!this.properties.acConfig)throw new Error("A valid AC config object needs to be passed to data capture");if(0==!!this.properties.localOfferFlow)throw new Error("A valid offer flow object needs to be passed to data capture");if(0==!!this.properties.bus)throw new Error("A valid bus object needs to be passed to offerv4")},_MetricalEngagementDataCapture.prototype.performBenefit=function(){this.logger.traceStart("performBenefit"),this.performBenefitFunction(),this.logger.traceEnd("performBenefit")},_MetricalEngagementDataCapture.prototype.execute=function(){var e=this;return new Promise(function(t,r){try{e.logger.traceStart("execute");var i=e.properties.engagement,o="closestatus"in i?i.closestatus:"dismissed",n="submitstatus"in i?i.submitstatus:"submitted",a=new _MetricalOfferViewV3({view:i.viewconfig,config:e.properties.acConfig});e.performBenefitFunction=function(){e.logger.debug("submission data",{data:a.data});var t=Object.assign({},i),r=t.actions||{};delete t.viewconfig,delete t.actions;var o=Object.assign({},{data:a.data,engagement:t},_MetricalUtils.sessionIdentifiers()),n=Object.assign({},r.values||{},o);r.values=n,new _MetricalActions(Object.assign({},{bus:e.properties.bus,offerflow:e.properties.localOfferFlow},r)).execute().then(function(t){return e.logger.debug("action results",{actionResults:t}),a.navigate("thankyou"),t}).catch(function(t){throw console.error(t),e.logger.error("actions error",{error:t}),a.navigate("error"),t})},a.subscribe("click/submit",function(){e.logger.debug("click/submit offerview data",{data:a.data}),1==e.properties.immediatelyPerformBenefit&&(e.logger.debug("handler perfoming benefit"),e.performBenefit()),e.properties.localOfferFlow.response(n)}),a.subscribe("click/close",function(){e.properties.localOfferFlow.response(o)}),e.logger.debug("rendering out datacapture offer"),a.render("index"),e.logger.traceEnd("execute"),t(!0)}catch(e){r(e)}})},_MetricalEngagementDsgRecommendations=function(e){var t={acConfig:null,engagement:null,localOfferFlow:null,immediatelyPerformBenefit:!0,bus:null,logger:new _MetricalLogger({extra:{module:"engagement"}})};if(this.properties=Object.assign({},t,e),this.logger=this.properties.logger,this.performBenefitFunction=function(){},0==!!this.properties.engagement)throw new Error("A valid engagement configuration object needs to be passed to data capture");if(0==!!this.properties.acConfig)throw new Error("A valid AC config object needs to be passed to data capture");if(0==!!this.properties.localOfferFlow)throw new Error("A valid offer flow object needs to be passed to data capture");if(0==!!this.properties.bus)throw new Error("A valid bus object needs to be passed to offerv4")},_MetricalEngagementDsgRecommendations.prototype.performBenefit=function(){this.logger.traceStart("performBenefit"),this.performBenefitFunction(),this.logger.traceEnd("performBenefit")},_MetricalEngagementDsgRecommendations.prototype.execute=function(){var e=this;return new Promise(function(t,r){try{e.logger.traceStart("execute");var i=e.properties.engagement,o="closestatus"in i?i.closestatus:"dismissed",n=("submitstatus"in i&&i.submitstatus,e.properties.engagement.config),a=n.scheme,s=n.useItemId||!1,c=n.useCartIds||!1;window.MetricalCertona=function(n){var s=n.resonance.schemes.filter(function(e){return e.scheme==a});if(console.log("target schemes"),console.log(s),0==s.length)r("No valid schemes found for recommendations");else{var c=s[0],l=function(e){if(0==e.ReviewCount)return"";for(var t=Math.floor(e.CustomerRating),r=[],i=1;i<=5;i++)t>=i?r.push("<i class='material-icons star ng-start-inserted'>star</i>"):r.push("<i class='material-icons star ng-start-inserted'>star_border</i>");return r.join("")+" ("+e.ReviewCount+")"};if(console.log(c.items.length),0==c.items.length)r("No items found in the scheme");else{var u=c.items.length>0,p=c.items.length>1,d=c.items.length>2,f=[];if(u){var h=c.items[0],g=h.Name,m=h.ImageURL,v=(h.URL,l(h)),b=h.maxofferprice==h.minofferprice?"$"+h.minofferprice:"$"+h.minofferprice+" to $"+h.maxofferprice;console.log(m);var y="<div class='Metrical_recommendation_card'>";y+="<a data-event='"+"click/submit1"+"'>",y+='<img src="'+m+'" />',y+="<div class='Metrical_card_rating'>"+v+"</div>",y+="<div class='Metrical_card_title'>"+g+"</div>",y+="<div class='Metrical_card_price'>"+b+"</div></a></div>",console.log(y),f.push(y)}if(p){var _=c.items[1];g=_.Name,m=_.ImageURL,_.URL,y="<div class='Metrical_recommendation_card'>";y+="<a data-event='"+"click/submit2"+"'>",y+='<img src="'+m+'" />',y+="<div class='Metrical_card_rating'>"+(v=l(_))+"</div>",y+="<div class='Metrical_card_title'>"+g+"</div>",y+="<div class='Metrical_card_price'>"+(b=_.maxofferprice==_.minofferprice?"$"+_.minofferprice:"$"+_.minofferprice+" to $"+_.maxofferprice)+"</div></a></div>",f.push(y)}if(d){var w=c.items[2];g=w.Name,m=w.ImageURL,w.URL,y="<div class='Metrical_recommendation_card'>";y+="<a data-event='"+"click/submit3"+"'>",y+='<img src="'+m+'" />',y+="<div class='Metrical_card_rating'>"+(v=l(w))+"</div>",y+="<div class='Metrical_card_title'>"+g+"</div>",y+="<div class='Metrical_card_price'>"+(b=w.maxofferprice==w.minofferprice?"$"+w.minofferprice:"$"+w.minofferprice+" to $"+w.maxofferprice)+"</div></a></div>",f.push(y)}e.logger.debug("text replacements",{textReplacements:M});var M={cards:f.join(""),count:f.length},C=new _MetricalOfferViewV3({view:i.viewconfig,config:e.properties.acConfig,textReplacements:M});e.performBenefitFunction=function(t){var r=Object.assign({},i),o=r.actions||{};delete r.viewconfig,delete r.actions;var n=Object.assign({},{data:C.data,engagement:r},_MetricalUtils.sessionIdentifiers()),a=Object.assign({},o.values||{},n,t||{});o.values=a,e.logger.debug("benefit values",{values:a}),new _MetricalActions(Object.assign({},{bus:e.properties.bus,offerflow:e.properties.localOfferFlow},o)).execute().then(function(t){return e.logger.debug("action results",{actionResults:t}),t}).catch(function(t){throw console.error(t),e.logger.error("actions error",{error:t}),t})},console.log("settings up subscriptions"),u&&C.subscribe("click/submit1",function(){e.logger.debug("submit1 clicked"),console.log("submit1"),e.performBenefitFunction({PRODUCTURL:h.URL})}),p&&C.subscribe("click/submit2",function(){e.logger.debug("submit2 clicked"),e.performBenefitFunction({PRODUCTURL:_.URL})}),d&&C.subscribe("click/submit3",function(){e.logger.debug("submit3 clicked"),e.performBenefitFunction({PRODUCTURL:w.URL})}),C.subscribe("click/close",function(){e.properties.localOfferFlow.response(o)}),e.logger.debug("rendering out recommendations offer"),C.render("index"),e.logger.traceEnd("execute"),t(!0)}}},window.resx={},window.resx.host="www.res-x.com",window.resx.appid="dickssportinggoods04",window.resx.top1=1e5,window.resx.top2=1e5,window.resx.rrelem=a,window.resx.rrnum=20,window.resx.rrec=!0,window.resx.rrcall="MetricalCertona";var l=_MetricalUtils.get(_MetricalAbandonCart,"passedInProperties.usermeta.itemid",null);s&&l&&(window.resx.itemid=l);var u=_MetricalAbandonCart.cart.cart.map(function(e){return e.id});c&&u.length>0&&(window.resx.itemid=u.join(";")),window.certonaResx.run()}catch(e){r(e)}})},_MetricalEngagementOfferV4=function(e){var t={acConfig:null,engagement:null,localOfferFlow:null,bus:null,immediatelyPerformBenefit:!0,logger:new _MetricalLogger({extra:{module:"engagement"}})};if(this.properties=Object.assign({},t,e),this.logger=this.properties.logger,this.performBenefitFunction=function(){},0==!!this.properties.engagement)throw new Error("A valid engagement configuration object needs to be passed to offerv4");if(0==!!this.properties.acConfig)throw new Error("A valid AC config object needs to be passed to offerv4");if(0==!!this.properties.localOfferFlow)throw new Error("A valid offer flow object needs to be passed to offerv4");if(0==!!this.properties.bus)throw new Error("A valid bus object needs to be passed to offerv4")},_MetricalEngagementOfferV4.prototype.performBenefit=function(){this.logger.traceStart("performBenefit"),this.performBenefitFunction(),this.logger.traceEnd("performBenefit")},_MetricalEngagementOfferV4.prototype.replaceCartValue=function(e){let t=this.properties.cart.cartValue(),r=e.cartTreshold-t;e.replace[0].content=[`<p>You are only $${r.toFixed(2)} away from free shipping</p>`],r<=0&&(e.replace[0].content=[""]);var i=this.properties.browser.document();let o=e.replace[0].content,n=e.replace[0].selector;i.querySelector(n).innerHTML=o},_MetricalEngagementOfferV4.prototype.getCartValue=function(e){let t=this;t.properties.bus.subscribe(t.properties.bus.constants.topics.MCART_ADD,()=>t.replaceCartValue(e)),t.properties.bus.subscribe(t.properties.bus.constants.topics.MCART_UPDATE,()=>t.replaceCartValue(e)),t.properties.bus.subscribe(t.properties.bus.constants.topics.MCART_DELETE,()=>t.replaceCartValue(e)),t.properties.bus.subscribe(t.properties.bus.constants.topics.MCART_CLEAR,()=>t.replaceCartValue(e));let r=t.properties.cart.cartValue(),i=e.cartTreshold-r;return e.replace[0].content=[`<p>You are only $${i.toFixed(2)} away from free shipping</p>`],i<=0&&(e.replace[0].content=[""]),e},_MetricalEngagementOfferV4.prototype.execute=function(){var e=this;return new Promise(function(t,r){try{e.logger.traceStart("execute");var i=e.properties.engagement,o=i.view||i.viewconfig||void 0,n=i.actions||{};o.cartTreshold&&(o=e.getCartValue(o));var a=new _MetricalViewFactory({bus:e.properties.bus,view:o}).create(o),s=i.viewmodules||{},c=(new _MetricalViewModules(Object.assign({},e.properties,{viewModules:s})),i.topicSubscriptions||{});Object.keys(c).forEach(function(t){var i=c[t]||void 0;void 0===i&&r("topic "+t+" does not have an action assigned to it"),e.properties.bus.subscribe(t,function(t,r){e.logger.debug("action subscription call",{payload:t,publishOptions:r});var o=n[i]||(e.properties.acConfig.actions||{})[i]||void 0;(e.logger.debug("action object",{actionObj:o}),o)?(o.showbusy&&a.showLoader(),new _MetricalActions(Object.assign({},{bus:e.properties.bus,offerflow:e.properties.localOfferFlow,logger:e.logger.child({module:"actions"})},o)).execute().then(function(t){return e.logger.debug("action results",{actionResults:t}),a.removeLoader(),t}).catch(function(t){throw e.logger.error("actions error",{error:t}),a.removeLoader(),t})):e.logger.warning("Could not find an action object for the defined action "+i,{actionObj:o})})}),a.render().then(function(e){t(e)}).catch(function(e){r(e)}),e.logger.traceEnd("execute")}catch(e){r(e)}})},_MetricalOfferV2=function(e){var t={acConfig:null,engagement:null,localOfferFlow:null,immediatelyPerformBenefit:!0,logger:new _MetricalLogger({extra:{module:"engagement"}})};if(this.params=Object.assign({},t,e),this.logger=this.params.logger,this.performBenefitFunction=function(){},0==!!this.params.engagement)throw new Error("A valid engagement configuration object needs to be passed to offer v2");if(0==!!this.params.acConfig)throw new Error("A valid AC config object needs to be passed to offer v2");if(0==!!this.params.localOfferFlow)throw new Error("A valid offer flow object needs to be passed to offer v2")},_MetricalOfferV2.prototype.performBenefit=function(){this.logger.traceStart("performBenefit"),this.performBenefitFunction(),this.logger.traceEnd("performBenefit")},_MetricalOfferV2.prototype.execute=function(){var e=this;return new Promise(function(t,r){try{e.logger.traceStart("execute offer V2");var i=e.params.engagement,o=new _MetricalCoupon({couponConfig:i.couponconfig,logger:e.logger.child({module:"coupon"})}).driver();e.performBenefitFunction=function(){e.logger.debug("performBenefitFunction() called"),o.execute().then(function(t){e.logger.debug("couponDriver execute results",{results:t})}).catch(function(e){throw e})};var n="closestatus"in i?i.closestatus:"dismissed",a="submitstatus"in i?i.submitstatus:"submitted",s=new _MetricalOfferViewV2({view:i,config:e.params.acConfig});s.subscribe("render/post",function(){e.logger.debug("render/post called")}),s.subscribe("submit/post",function(){e.params.localOfferFlow.response(a),e.logger.debug("submit/post called"),1==e.params.immediatelyPerformBenefit&&e.performBenefit()}),s.subscribe("close/post",function(){e.logger.debug("close/post called"),e.params.localOfferFlow.response(n)}),s.render(),e.logger.debug("rendered offer view"),e.logger.traceEnd("execute offer V2"),t(!0)}catch(e){r(e)}})},_MetricalOfferV1=function(e){var t={acConfig:null,engagement:null,localOfferFlow:null,immediatelyPerformBenefit:!0,logger:new _MetricalLogger({extra:{module:"engagement"}})};if(this.params=Object.assign({},t,e),this.logger=this.params.logger,this.performBenefitFunction=function(){},0==!!this.params.engagement)throw new Error("A valid engagement configuration object needs to be passed to offer v1");if(0==!!this.params.acConfig)throw new Error("A valid AC config object needs to be passed to offer v1");if(0==!!this.params.localOfferFlow)throw new Error("A valid offer flow object needs to be passed to offer v1")},_MetricalOfferV1.prototype.performBenefit=function(){this.logger.traceStart("performBenefit"),this.performBenefitFunction(),this.logger.traceEnd("performBenefit")},_MetricalOfferV1.prototype.execute=function(){var e=this;return new Promise(function(t,r){try{e.logger.traceStart("execute");var i=jQuery||null;if(0==!!i)throw new Error("Could not find an instance of jQuery to use in offer v1 engagements");({abandonCartAction:null,bootstrap:function(e,t,r){this.abandonCartAction=t;var i=this;this.clearMetrical(),this.initMetrical(e,function(){if(i.configureOfferEventHandlers(e),"function"==typeof r){var t={couponConfig:_MetricalCoupon.couponConfig()};r(t)}})},initMetrical:function(t,r){var o=Object.assign({},t);null==o.apiendpointhost&&(o.apiendpointhost=_MetricalAbandonCart.Config.apiendpointhost),null==o.staticendpointhost&&(o.staticendpointhost=_MetricalAbandonCart.Config.staticendpointhost),o.postWidgetRender=r,_Metrical.init(i,o),e.logger.info("finalized the bootstrap of Metrical")},displayMetrical:function(){},clearMetrical:function(){_Metrical&&_Metrical.app&&_Metrical.app.tabCloserTimer&&clearInterval(_Metrical.app.tabCloserTimer),i(".Metrical_lightbox").remove(),i(".MetricalContainer").remove()},configureOfferEventHandlers:function(t){e.performBenefitFunction=function(){_MetricalCoupon.postCoupon()};var r="closestatus"in t?t.closestatus:"dismissed",o="submitstatus"in t?t.submitstatus:"submitted",n="autocloseafterxseconds"in t?t.autocloseafterxseconds:void 0,a="autosubmitafterxseconds"in t?t.autosubmitafterxseconds:void 0;setTimeout(function(){var t=void 0,s=void 0;n&&(t=setTimeout(function(){i(".MetricalContainer #close-widget").click()},1e3*n));a&&(s=setTimeout(function(){i(".MetricalContainer #submit-widget").click()},1e3*a));i(".MetricalTab a.mobile-link").click(function(i){e.params.localOfferFlow.response(r),void 0!==t&&clearTimeout(t)});for(var c=document.querySelectorAll(".MetricalTab.elTab-left, .MetricalTab.elTab-right, .MetricalTab.elTab-top"),l=0;l<c.length;l++)c[l].addEventListener("click",function(o){i(this).parent().hasClass("is-popped")&&void 0!==o.originalEvent&&(e.params.localOfferFlow.response(r),void 0!==t&&clearTimeout(t))});i(".MetricalContainer #close-widget").click(function(i){e.params.localOfferFlow.response(r),void 0!==t&&clearTimeout(t)}),i(".MetricalContainer #submit-widget").click(function(t){1==e.params.immediatelyPerformBenefit&&e.performBenefit(),e.params.localOfferFlow.response(o),void 0!==s&&clearTimeout(s),i("body").css("overflow-y",""),t.stopPropagation()})},500)}}).bootstrap(e.params.engagement,null,t),e.logger.traceEnd("execute")}catch(e){r(e)}})},_MetricalEventEmitterBase=function(e){var t={id:void 0,type:void 0,bus:void 0,emitterType:"point-in-time",settings:{},channels:void 0,channel:void 0,on:void 0,off:void 0,action:void 0,browser:new _MetricalBrowser,logger:new _MetricalLogger({extra:{module:"eventemitter"}})};if(this.properties=Object.assign({},t,e||{}),this.browser=this.properties.browser,this.logger=this.properties.logger,0==!!this.properties.id)throw new Error("_MetricalEventEmitterBase expects an id parameter to be set.");if(0==!!this.properties.type)throw new Error("_MetricalEventEmitterBase expects a type parameter to be set.");if(0==!!this.properties.bus)throw new Error("_MetricalEventEmitterBase expects a bus parameter to be set.");if(this.onChannels=[],this.onAction=void 0,this.offChannels=[],this.offAction=void 0,this.bus=this.properties.bus,this.properties.on&&this.setupOn(this.properties.on),this.properties.off&&this.setupOff(this.properties.off),this.properties.channels&&this.setupChannels(this.properties.channels),this.properties.channel&&this.setupChannels(this.properties.channel),0==!!this.properties.on&&(this.properties.action?this.onAction=this.properties.action:this.onAction=this.properties.id),0==this.onChannels.length)throw new Error("_MetricalEventEmitterBase expects to have at least one onChannel defined.");if(0==!!this.onAction)throw new Error("_MetricalEventEmitterBase expects to have onAction defined.")},_MetricalEventEmitterBase.prototype.setupChannels=function(e){var t=this;e&&(Array.isArray(e)?e.forEach(function(e){t.onChannels.push(e)}):t.onChannels.push(e))},_MetricalEventEmitterBase.prototype.setupOn=function(e){var t=this,r=e.channel||e.channels||[];Array.isArray(r)?r.forEach(function(e){t.onChannels.push(e)}):this.onChannels.push(r),this.onAction=e.action||void 0},_MetricalEventEmitterBase.prototype.setupOff=function(e){var t=this,r=e.channel||e.channels||[];Array.isArray(r)?r.forEach(function(e){t.offChannels.push(e)}):this.offChannels.push(r),this.offAction=e.action||void 0},_MetricalEventEmitterBase.prototype.start=function(){throw new Error("_MetricalEventEmitterBase.start() needs to be overridden")},_MetricalEventEmitterElementOnScreen=function(e){if(_MetricalEventEmitterBase.call(this,Object.assign({},{emitterType:"on-off"},e)),0==!!this.properties.settings.selector)throw new Error("_MetricalEventEmitterElementOnScreen expects a selector parameter in settings");this.selector=this.properties.settings.selector,this.threshold=this.properties.settings.threshol||.2},_MetricalEventEmitterElementOnScreen.prototype=Object.create(_MetricalEventEmitterBase.prototype),_MetricalEventEmitterElementOnScreen.prototype.constructor=_MetricalEventEmitterElementOnScreen,_MetricalEventEmitterElementOnScreen.prototype.start=function(){var e,t=this,r=this.browser.document(),i=new(this.browser.IntersectionObserver())((e=!1,function(r){r.forEach(function(r){!0===r.isIntersecting?(e=!0,t.onChannels.forEach(function(e){t.bus.publish(e,{action:t.onAction,target:t.browser.nodeToString(r.target)})})):1==e&&!1===r.isIntersecting&&(e=!1,t.offChannels.forEach(function(e){t.bus.publish(e,{action:t.offAction,target:t.browser.nodeToString(r.target)})}))})}),{threshold:this.threshold});r.querySelectorAll(this.selector).forEach(function(e){i.observe(e)})},_MetricalEventEmitterClick=function(e){_MetricalEventEmitterBase.call(this,Object.assign({},{emitterType:"on-off"},e));var t=this.properties.settings.selectors||this.properties.settings.selector||void 0;if(!1==!!t)throw new Error("_MetricalEventEmitterClick expects a selectors parameter in settings");this.selectors=Array.isArray(t)?t:[t],this.jsEventName="click"},_MetricalEventEmitterClick.prototype=Object.create(_MetricalEventEmitterBase.prototype),_MetricalEventEmitterClick.prototype.constructor=_MetricalEventEmitterClick,_MetricalEventEmitterClick.prototype.start=function(){var e=this,t=this.browser.document(),r=this.browser.window();t.addEventListener(e.jsEventName,function(t){var i=(t=t||r.event).target||t.srcElement;e.selectors.map(function(e){return i.matches(e)}).includes(!0)&&e.onChannels.forEach(function(t){e.bus.publish(t,{action:e.onAction,target:e.browser.nodeToString(i)})})})},_MetricalEventEmitter=function(e){var t={bus:void 0,browser:new _MetricalBrowser,logger:new _MetricalLogger({extra:{module:"eventemitter"}}),emitters:[],runStartEmitters:!0};if(this.properties=Object.assign({},t,e||{}),0==!!this.properties.bus)throw new Error("_MetricalEventEmitter expects a bus parameter to be set.");if(0==Array.isArray(this.properties.emitters))throw new Error("_MetricalEventEmitter expects an emitters configuration to be an array");this.properties.runStartEmitters&&this.startEmitters()},_MetricalEventEmitter.prototype.startEmitters=function(e){var t=this;this.properties.emitters.forEach(function(r){new(t.determineEmitter(r.type))(Object.assign({},{bus:t.properties.bus,browser:t.properties.browser,logger:t.properties.logger},r,e||{})).start()})},_MetricalEventEmitter.prototype.determineEmitter=function(e){switch(e){case"element-on-screen":return _MetricalEventEmitterElementOnScreen;case"click":return _MetricalEventEmitterClick;default:throw new Error("Could not determine the emitter class using type "+e)}},_MetricalOfferRecord={keyMap:{offer_flow_guid:"ofg",is_invalid:"ii",is_closed:"ic",experiment_name:"en",experiment_settings:"es",eligibility:"el",eligibility_timestamp:"elt",eligibility_criteria:"elc",testgroup:"tg",testgroup_timestamp:"tgt",engagement_selected:"ens",engagement_selected_timestamp:"enst",engagement_rule_name_matched:"enrn",engagement_rule_matched:"enrm",engagement_rule_metadata:"enrmd",engagement_selection_log:"ensl",engagement_selected_couponcode:"ensc",presentation:"prs",presentation_timestamp:"prst",offer_is_visible:"oisv",response:"rsp",response_timestamp:"rspt",feature_id:"fid",campaign:"cam",acconfig_settings:"acs",tags:"tags",offer_flow_type:"oft",session_id:"sid"},new:function(){return{offer_flow_guid:null,is_invalid:!1,is_closed:!1,experiment_name:null,experiment_settings:{},eligibility:null,eligibility_timestamp:null,eligibility_criteria:null,testgroup:null,testgroup_timestamp:null,engagement_selected:null,engagement_selected_timestamp:null,engagement_rule_name_matched:null,engagement_rule_matched:null,engagement_rule_metadata:null,engagement_selection_log:null,engagement_selected_couponcode:null,presentation:null,presentation_timestamp:null,offer_is_visible:!1,response:null,response_timestamp:null,feature_id:null,campaign:null,acconfig_settings:null,tags:{},offer_flow_type:null,session_id:null}},dehydrate:function(e){var t={};for(var r in e){var i=e[r],o=r in _MetricalOfferRecord.keyMap?_MetricalOfferRecord.keyMap[r]:r;"experiment_settings"==r&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),i={}),"engagement_selected"==r&&null!==i&&(delete(i=JSON.parse(JSON.stringify(i))).isactive,delete i.name,delete i.offerrules,delete i.survey),"engagement_selection_log"==r&&null!==i&&(i=JSON.parse(JSON.stringify(i)),i=[]),t[o]=i}return t},hydrate:function(e){var t={},r={};for(var i in _MetricalOfferRecord.keyMap)r[_MetricalOfferRecord.keyMap[i]]=i;for(var i in e){var o=e[i];t[i in r?r[i]:i]=o}return t}},_MetricalDebug={init:function(e){this.defaultConfig={isActive:!1,ac:{Log:{logs:[]}}},this.config=Object.assign({},this.defaultConfig,e||{})},isEnabled:function(){return!!this.config.isActive},debugInformation:function(){var e={};return e.localStorage=_MetricalStorage.Storage.metricalObject(),e.log=this._createLogRows(),e.offerflowda=_MetricalStorage.SessionStorage.metricalObject(),e},_createLogRows:function(){for(var e=this.config.ac.Log.logs,t=[],r=0;r<e.length;r++){var i=e[r];i.data.forEach(function(e){var r=i.type+" - "+i.timestamp+":";e instanceof Error?(r=r+" "+e.name+" - "+e.message+": ",e.stack):r="object"==typeof e?r+" "+JSON.stringify(e):r+" "+e,t.push(r)})}return t}},_MetricalPhase=function(e){this.defaultParams={config:_MetricalAbandonCart.Config||null},this.params=Object.assign({},this.defaultParams,e||{}),this.phases=this.params.config.phases||[]},_MetricalPhase.prototype.currentPhase=function(){var e=(new _MetricalLocalTime).localTime();return this.selectPhase(e)||null},_MetricalPhase.prototype.selectPhase=function(e){var t=this.phases.filter(function(t){var r=new Date(t.start).getTime(),i=new Date(t.end).getTime();return e>=r&&e<i});return 1==t.length?t[0]:null},_MetricalPhase.prototype.constrainOfferToPhaseTimeframe=function(e,t){if(void 0===t&&(t=this.currentPhase()),null===t)return e;var r=e.startdate?new Date(e.startdate).getTime():null,i=e.enddate?new Date(e.enddate).getTime():null,o=new Date(t.start).getTime(),n=new Date(t.end).getTime();return"phase"in e&&e.phase==t.id&&((null===r||r<o||r>n)&&(e.startdate=t.start),(null===i||i>n||i<o)&&(e.enddate=t.end)),e},_MetricalOfferFlowDataAccess=function(e,t,r,i,o){switch(this.defaultConfig={namespace:"default",storageDriver:"localStorage"},this.config=Object.assign({},this.defaultConfig,e||{}),this.namespace=this.config.namespace||"default",this.mbOff=t,this.ac=r,this.identity=i,this.postEndpoint=o,this.offerRecordKey="offerRecord",this.offerRecordGuidKey="offerRecordGuid",this.testGroupKey="testgroup",this.treatmentTagKey="treatmenttag",this.controlExpired="controlexpired",this.offerLimitsKey="offerlimits",this.limitKey="limit",this.timestampKey="localtime_override",this.offersSelectedKey="offers_selected",this.getOfferRecordMutator=void 0,this.saveOfferRecordMutator=void 0,this.cookieObject=this.ac.storage,this.storageObject=this.ac.storage,this.recordStore=null,this.limitStore=null,this.post=function(e){},this.config.storageDriver){case"serverstore":this.recordStore=_MetricalStorage.ServerStore,this.limitStore=_MetricalStorage.Cookie,this.post=_MetricalStorage.ServerStore._post;var n=this.namespace+"_"+this.offerRecordGuidKey,a=this.cookieObject.getItem(n),s=this.namespace+"_"+this.offerRecordKey;this.recordStore.init(a,s);break;case"cookie":this.recordStore=_MetricalStorage.Cookie,this.limitStore=_MetricalStorage.Cookie,this.getOfferRecordMutator=_MetricalOfferRecord.hydrate,this.saveOfferRecordMutator=_MetricalOfferRecord.dehydrate;break;case"localStorage":default:this.recordStore=_MetricalStorage.Storage,this.limitStore=_MetricalStorage.Storage}this.debug=[]},_MetricalOfferFlowDataAccess.prototype.setNamespace=function(e){this.namespace=e},_MetricalOfferFlowDataAccess.prototype.recordKey=function(){return this.namespace+"_"+this.offerRecordKey},_MetricalOfferFlowDataAccess.prototype.guidKey=function(){return this.namespace+"_"+this.offerRecordGuidKey},_MetricalOfferFlowDataAccess.prototype.getOfferRecord=function(){var e=this.recordKey();return this.recordStore.getItem(e)},_MetricalOfferFlowDataAccess.prototype.saveOfferRecord=function(e){var t=this.namespace+"_"+this.offerRecordKey,r=this.namespace+"_"+this.offerRecordGuidKey,i=e;this.recordStore.setItem(t,i);return this.cookieObject.setItem(r,e.offer_flow_guid,{expiresAfter:1800}),!0},_MetricalOfferFlowDataAccess.prototype.postOfferRecord=function(e,t){try{if(null!=t){if(this._limitKeyUsed(t))return;this._addLimitKey(t)}var r=Object.assign({},e,{ts:(new Date).getTime(),limit_key:t||null});this.post(r);var i={surveyId:this.ac.Config.surveyid,uuid:this.identity.getDeviceId(),sessionId:this.identity.getSessionId(),offerflow:r};this.mbOff.sendBeacon(this.postEndpoint,i)}catch(e){console.error(e),this.debug.push({err:e}),_MetricalStorage.SessionStorage.setItem("offerflowda_debug",this.debug)}},_MetricalOfferFlowDataAccess.prototype.getTestGroup=function(){var e=this.namespace+"_"+this.testGroupKey,t=null;switch(this.storageObject.hasItem(e)&&(t=this.storageObject.getItem(e)),t){case"treatment":return"treatment";case"control":return"control";default:return null}},_MetricalOfferFlowDataAccess.prototype.saveTestGroup=function(e,t){var r=this.namespace+"_"+this.testGroupKey,i={};t>0&&(t=new Date(t),i.expires=t);this.cookieObject.setItem(r,e,i);return!0},_MetricalOfferFlowDataAccess.prototype.getTreatmentTag=function(){var e=this.namespace+"_"+this.treatmentTagKey;return this.cookieObject.getItem(e)},_MetricalOfferFlowDataAccess.prototype.saveTreatmentTag=function(e){var t=this.namespace+"_"+this.treatmentTagKey;this.cookieObject.setItem(t,e);return!0},_MetricalOfferFlowDataAccess.prototype.getIsControlExpired=function(){var e=this.namespace+"_"+this.controlExpired;return!!this.cookieObject.hasItem(e)&&"1"==this.cookieObject.getItem(e)},_MetricalOfferFlowDataAccess.prototype.setIsControlExpired=function(e,t){var r=this.namespace+"_"+this.controlExpired,i=(e=e?"1":"0",{});return t>0&&(t=new Date(t),i.expires=t),this.cookieObject.setItem(r,e,i)},_MetricalOfferFlowDataAccess.prototype.getOfferLimits=function(){var e=this.namespace+"_"+this.offerLimitsKey;return this.limitStore.getItem(e)},_MetricalOfferFlowDataAccess.prototype.saveOfferLimits=function(e){var t=this.namespace+"_"+this.offerLimitsKey;this.limitStore.setItem(t,e,1/0);return!0},_MetricalOfferFlowDataAccess.prototype._getLimitKey=function(){var e=this.namespace+"_"+this.limitKey,t=this.cookieObject.getItem(e);return t||[]},_MetricalOfferFlowDataAccess.prototype._saveLimitKey=function(e){var t=this.namespace+"_"+this.limitKey;this.cookieObject.setItem(t,e,{expiresAfter:1800})},_MetricalOfferFlowDataAccess.prototype._limitKeyUsed=function(e){return this._getLimitKey().includes(e)},_MetricalOfferFlowDataAccess.prototype._addLimitKey=function(e){var t=this._getLimitKey();t.push(e),this._saveLimitKey(t)},_MetricalOfferFlowDataAccess.prototype._resetLimitKey=function(){this._saveLimitKey([])},_MetricalOfferFlowDataAccess.prototype.getCurrentTimestamp=function(){var e=this.namespace+"_"+this.timestampKey;return this.cookieObject.getItem(e)},_MetricalOfferFlowDataAccess.prototype.setCurrentTimestamp=function(e){var t=this.namespace+"_"+this.timestampKey;this.cookieObject.setItem(t,e);return!0},_MetricalOfferFlowDataAccess.prototype.savePresentedOffer=function(e){var t=this.namespace+"_"+this.offersSelectedKey;if(0==!!e.engagement_selected)return!1;var r=e.engagement_selected,i={};i.id=r.id,i.campaign=r.campaign||null,i.ts=(new Date).getTime();var o=this.storageObject.getItem(t);(o=Array.isArray(o)?o:[]).push(i);var n=(new Date).getTime()-5184e6,a=o.filter(function(e){return e.ts>=n});return this.storageObject.setItem(t,a),!0},_MetricalOfferFlowDataAccess.prototype.getPresentedOffers=function(){var e=this.namespace+"_"+this.offersSelectedKey,t=this.storageObject.getItem(e);return Array.isArray(t)?t:[]},_MetricalOfferFlow={pubsub:new _MetricalUtils.PubSub,pubsubTopics:{tg:"eligible-test-group-defined",na:"not-actionable","OFFER-SELECTED":"offer-selected","OFFER-PRESENTED":"offer-presented","OFFER-NOT-PRESENTED":"offer-not-presented",np:"waiting-to-match-business-rules","CUSTOMER-RESPONDED":"customer-responded",CLOSE:"close"},manuallyTriggerPostCoupon:!1,manualPostFunction:null,manualPostCoupon:function(){1==this.manuallyTriggerPostCoupon&&"function"==typeof this.manualPostFunction&&this.manualPostFunction()}},_MetricalOfferFlowClass=function(e){var t={id:"default",conditions:null,engagements:[],tags:{},globalofferlimit:null,globalofferlimittimeout:null,offerflowtag:null,namespace:"default",experiments:[{name:"default",treatmentweight:1,controlweight:0}],eligibilityrules:"",offerflowisactive:!0,da:null,engagementFunction:function(){},testMode:null,isInvalid:!1,revision:null,abandonprobable:{},limitChecks:[],logger:new _MetricalLogger({extra:{module:"offerflow"}}),identity:null,browser:null,defaultOfferFlowType:null};if(this.properties=Object.assign({},t,e||{}),this.logger=this.properties.logger,this.id=this.properties.id,this.logger.traceStart("init",{id:this.id}),0==!!this.properties.conditions)throw new Error("A conditions object needs to be set and passed as an input to offer flows");if(0==!!this.properties.da)throw new Error("A data access object needs to be set and passed as an input to offer flows");if(0==!!this.properties.identity)throw new Error("_MetricalOfferFlows expects an identity parameter");this.engagementFunction=this.properties.engagementFunction,this.testMode=this.properties.testMode,this.activeExperiment=this.properties.experiments[0],this.conditions=this.properties.conditions,this.da=this.properties.da,this.eligibilityRules=this.properties.eligibilityrules,this.engagements=this.properties.engagements,this.isVisible=!1,this.offerRecord={},this.queuedTags={},this.validResponses=["submitted","dismissed","offer expired","timer expired","acknowledged","continued","checked out"],this.delayStarted=!1,this.isPresenting=!1,this.previousTags=null,this.definedTags={},this.logger.traceEnd("init")},_MetricalOfferFlowClass.prototype.reset=function(){this.logger.debug("resetting offer flow"),this.isVisible=!1,this.isPresenting=!1,this.offerRecord={};var e=this.newOfferRecord();return this.da._resetLimitKey(),this.da.saveOfferRecord(e),e},_MetricalOfferFlowClass.prototype.newOfferRecord=function(){var e=this,t=Object.assign({},_MetricalOfferRecord.new());return t.offer_flow_guid=_MetricalUtils.makeUUID(),t.experiment_name=this.activeExperiment.name,t.experiment_settings=this.activeExperiment,t.is_invalid=this._isInTestMode()||this.properties.isInvalid,t.offer_flow_type=this.properties.defaultOfferFlowType,t.acconfig_settings={traffic_control_number:_MetricalSampling.getTrafficControlNumber()||null,offerflowtag:this.properties.offerflowtag,revision:this.properties.revision},t.session_id=e.properties.identity.getSessionId(),Object.keys(this.queuedTags).length>0&&Object.keys(this.queuedTags).forEach(function(r){t.tags[r]=e.queuedTags[r]}),t},_MetricalOfferFlowClass.prototype._loadOfferRecord=function(){var e=this.da.getOfferRecord();null!==e&&this.properties.identity.getSessionId()===e.session_id||(e=this.reset()),this.offerRecord=e},_MetricalOfferFlowClass.prototype._isInTestMode=function(){return null!==this.testMode&&this.testMode.isInTestMode()},_MetricalOfferFlowClass.prototype.executeEngagementLoop=function(){var e=this;return e.logger.traceStart("executeEngagementLoop",{module:"offerflowpoll"}),new Promise(function(t,r){e._loadOfferRecord(),e.isClosed()||0==e.properties.offerflowisactive&&0==e._isInTestMode()?(e.inLoopExecution=!1,e.logger.traceEnd("executeEngagementLoop",{module:"offerflowpoll"}),t(!0)):e.conditions.evaluateConditions().then(function(r){if(e.logger.debug("Computed conditions",{computeResults:r,module:"offerflowpoll"}),e.evaluateEligibility(r)){e.logger.info("Session has become eligible for "+e.id,{terminal:!0});var i=e.evaluateTestGroup();e.saveStateAndSync("tg"),e.logger.info("Determined test group "+i+" for "+e.id+" in the session",{terminal:!0,testGroup:i});var o=e.evaluateTags(r);e.logger.info("Evaluating tags for "+e.id+" in the session",{terminal:!0});var{selectedEngagement:n,selectedRule:a,selectionLog:s}=e.selectEngagement(r,o);e.logger.info("Engagement Selection Results",{selectedEngagement:n,selectedRule:a,selectionLog:s}),n?0==e.isPresenting&&(e.logger.info("The engagement "+n.name+" for "+e.id+" was selected for the session",{terminal:!0,selectedEngagement:n}),e.isPresenting=!0,e.updateRecordSelectionLogAndTags(s,o),e.updateRecordWithEngagement(n,a),e.publish("OFFER-SELECTED"),e.logger.debug("Offer Record",{offerRecord:e.offerRecord}),e.saveStateAndSync("ofs"),e.recordPresentedOffer(),"treatment"==i?(e.logger.info("Presenting the engagement for "+e.id+" to the session",{terminal:!0,selectedEngagement:n}),e.presentEngagement()):(e.logger.info("Not presenting the engagement for "+e.id+" to the session due to being control",{terminal:!0,selectedEngagement:n}),e.doNotPresentEngagement(),e.closeOffer(),e.publish("OFFER-NOT-PRESENTED"))):(e.updateRecordSelectionLogAndTags(s,o),e.didTagsChange(o)?(e.previousTags=Object.assign({},o),e.saveStateAndSync("sl")):e.saveState())}e.logger.traceEnd("executeEngagementLoop",{module:"offerflowpoll"}),t(!0)}).catch(function(t){e.logger.traceEnd("executeEngagementLoop",{module:"offerflowpoll"}),r(t)})})},_MetricalOfferFlowClass.prototype.recordPresentedOffer=function(){this.da.savePresentedOffer(this.offerRecord)},_MetricalOfferFlowClass.prototype.isClosed=function(){return this.offerRecord.is_closed},_MetricalOfferFlowClass.prototype.publish=function(e){if(e in _MetricalOfferFlow.pubsubTopics){var t={offer_presented:this.offerRecord.engagement_selected||{couponcode:null}};_MetricalOfferFlow.pubsub.publish(_MetricalOfferFlow.pubsubTopics[e],Object.assign({},this.offerRecord,t),1)}},_MetricalOfferFlowClass.prototype.closeOffer=function(){this.offerRecord.is_closed=!0,this.saveStateAndSync(),this.logger.info("Closing offer flow",{terminal:!0}),this.publish("CLOSE")},_MetricalOfferFlowClass.prototype.saveState=function(){this.da.saveOfferRecord(this.offerRecord)},_MetricalOfferFlowClass.prototype.saveStateAndSync=function(e){this.da.saveOfferRecord(this.offerRecord),0==this.da._limitKeyUsed(e)&&this.publish(e),this.da.postOfferRecord(this.offerRecord,e)},_MetricalOfferFlowClass.prototype.evaluateEligibility=function(e){var t=!1;if("eligible"==this.offerRecord.eligibility)t=!0;else{t=_MetricalUtils.evaluateRule(this.eligibilityRules,e);var r=_MetricalUtils.ruleCriteriaString(this.eligibilityRules,e);r!=this.offerRecord.eligibility_criteria&&(this.offerRecord.eligibility_criteria=r),this.offerRecord.eligibility_timestamp=(new Date).toISOString(),this.offerRecord.eligibility=1==t?"eligible":"not eligible"}return t},_MetricalOfferFlowClass.prototype.evaluateTestGroup=function(e){var t=this.da.getTestGroup(),r=this.da.getIsControlExpired(),i=this._determineControlExpiration();if(null===t){var o="posttreatmentweight"in this.activeExperiment&&"isatthreshold"in this.activeExperiment&&1==this.activeExperiment.isatthreshold?this.activeExperiment.posttreatmentweight:this.activeExperiment.treatmentweight,n="postcontrolweight"in this.activeExperiment&&"isatthreshold"in this.activeExperiment&&1==this.activeExperiment.isatthreshold?this.activeExperiment.postcontrolweight:this.activeExperiment.controlweight;if("string"==typeof o&&"string"==typeof n){var a=this._testGroupRule(o);this._testGroupRule(n)&&(t="control"),a&&(t="treatment")}else{var s=[{item:"treatment",weight:o},{item:"control",weight:n}];t=_MetricalUtils.chooseRandomItem(s)}"control"==t&&!1!==i?(this.da.saveTestGroup(t,i),this.da.setIsControlExpired(!0,i),r=!0):this.da.saveTestGroup(t)}return null==this.offerRecord.testgroup_timestamp&&(this.offerRecord.testgroup_timestamp=(new Date).toISOString()),this.offerRecord.testgroup=t,"control"===t&&0==r&&!1!==i&&(this.da.saveTestGroup(t,i),this.da.setIsControlExpired(!0,i)),t},_MetricalOfferFlowClass.prototype._testGroupRule=function(rule){var result=!1;try{var evalResult=eval(rule);result=!!evalResult}catch(e){this.logger.error({error:e})}return result},_MetricalOfferFlowClass.prototype._determineControlExpiration=function(){if("object"==typeof this.activeExperiment&&"controlreleasedays"in this.activeExperiment){var e=this.activeExperiment.controlreleasedays,t=(new Date).getTime();return t+=86400*e*1e3}return!1},_MetricalOfferFlowClass.prototype.evaluateTags=function(e){var t=this,r=Object.keys(this.properties.tags||{}).reduce(function(r,i){r[i]=null;var o=t.properties.tags[i],n=_MetricalUtils.evaluateRule(o,e,r);return r[i]=n,r},{});return Object.assign({},r,this.definedTags||{})},_MetricalOfferFlowClass.prototype.didTagsChange=function(e){return 0==_MetricalUtils.isEqual(e,this.previousTags)},_MetricalOfferFlowClass.prototype.updateRecordSelectionLogAndTags=function(e,t){this.offerRecord.engagement_selection_log=e,this.offerRecord.tags=t},_MetricalOfferFlowClass.prototype.updateRecordWithEngagement=function(e,t){this.offerRecord.engagement_selected=e,this.offerRecord.engagement_selected_timestamp=(new Date).toISOString(),null!==t&&(this.offerRecord.engagement_rule_name_matched=t.name||"Not Found",this.offerRecord.engagement_rule_metadata=t.metadata||{},this.offerRecord.engagement_rule_matched=t),this.offerRecord.engagement_selected_couponcode=e.couponcode||null,this.offerRecord.campaign=e.campaign||null,"object"==typeof this.properties.abandonprobable&&"fid"in this.properties.abandonprobable&&(this.offerRecord.feature_id=this.properties.abandonprobable.fid||null)},_MetricalOfferFlowClass.prototype.currentOfferLimits=function(){var e=this.da.getOfferLimits();if(e){var t=(new Date).getTime();if("resetOn"in e&&(e.resetOn>0&&t>e.resetOn||null===e.resetOn)&&(e.total=0,e.resetOn=null),"offers"in e)for(var r in e.offers){let i=e.offers[r];"resetOn"in i&&(i.resetOn>0&&t>i.resetOn||null===i.resetOn)&&(i.total=0,i.resetOn=null)}}return e||{total:0,resetOn:null,offers:{}}},_MetricalOfferFlowClass.prototype.selectEngagement=function(e,t){var r=this,i=[],o=[],n=function(e){return!!r._engagementRules(e)},a=function(e){return e.map(function(e){return e.id}).join(", ")};o.push("Initial engagement count is "+this.engagements.length);var s=this.engagements.reduce(function(e,t){return"isactive"in t&&1==t.isactive?e.push(t):o.push("Eliminated "+t.id+" for not being active"),e},[]).reduce(function(e,t){if("startdate"in t||"enddate"in t){var i=_MetricalDateUtils.getLocalUtcTimestamp(),n=_MetricalDateUtils.getTimestamp(r.da.getCurrentTimestamp());n&&(i=n);var a=_MetricalDateUtils.getTimestamp(t.startdate),s=_MetricalDateUtils.getTimestamp(t.enddate);_MetricalDateUtils.isTimestampBetweenDates(i,a,s)?e.push(t):o.push("Eliminated "+t.id+" for not not being in the timestamp range")}else e.push(t);return e},[]).reduce(function(e,t){if(r.properties.limitChecks.length>0){var i=[],n=new _MetricalEngagementLimits(t,r.da.getPresentedOffers());r.properties.limitChecks.forEach(function(e){if(!(e.function in n))throw new Error(e.function+" is not a valid limit check function reference");i.push(n[e.function](e.value,e.offerselectionfilter||void 0))}),0==i.includes(!0)?e.push(t):o.push("Eliminated "+t.id+" for having a match against a limit check")}else e.push(t);return e},[]),c=r.currentOfferLimits(),l=s.reduce(function(e,t){var i=r._offerIsUnderLimit(t,c);return r._isUnderGlobalLimit(c)?i?e.push(t):o.push("Eliminated "+t.id+" because of engagement limit reached"):o.push("Eliminated "+t.id+" because of global limit reached"),e},[]);o.push("Avaialble engagements for consideration are: "+a(l));var u=l.filter(function(e){return 1==n(e)}),p=l.filter(function(e){return 0==n(e)});return u.forEach(function(n){var a=r._engagementCheckRules(n,e,t,o);a&&i.push({engagement:n,rule:a})}),p.forEach(function(e){o.push("Engagement: "+e.id+" - always available"),i.push({engagement:e,rule:null})}),o.push("Considered engagements length after remaining is "+i.length),i.length>0?(o.push("Considered engagements are: "+a(i.map(function(e){return e.engagement}))),{selectedEngagement:i[0].engagement,selectedRule:i[0].rule,selectionLog:o}):{selectedEngagement:null,selectedRule:null,selectionLog:o}},_MetricalOfferFlowClass.prototype._engagementRules=function(e){return"offerrule"in e&&("string"==typeof e.offerrule&&e.offerrule.length>0||Array.isArray(e.offerrule))?e.offerrule:"engagementrule"in e&&("string"==typeof e.engagementrule&&e.engagementrule.length>0||Array.isArray(e.engagementrule))?e.engagementrule:null},_MetricalOfferFlowClass.prototype._engagementCheckRules=function(e,t,r,i){var o=this._engagementRules(e);return(o=Array.isArray(o)?o:[{name:e.id+"-rule1",metadata:{},rule:o}]).reduce(function(o,n){var a=_MetricalUtils.evaluateRule(n.rule,t,r);return i.push("Engagement: "+e.id+" - "+_MetricalUtils.ruleCriteriaString(n.rule,t,r)),null===o&&1==a&&(o=n),o},null)},_MetricalOfferFlowClass.prototype._isUnderGlobalLimit=function(e){var t=this.properties.globalofferlimit;return!("total"in e&&null!==t&&e.total>=t)},_MetricalOfferFlowClass.prototype._offerIsUnderLimit=function(e,t){var r=!0;"offers"in t&&e.id in t.offers&&"offerlimit"in e&&((t.offers[e.id].total||0)>=e.offerlimit&&(r=!1));return r},_MetricalOfferFlowClass.prototype.doNotPresentEngagement=function(){this.offerRecord.presentation="not presented",this.offerRecord.presentation_timestamp=(new Date).toISOString()},_MetricalOfferFlowClass.prototype.presentEngagement=function(){var e=this,t=e._engagementDelay(),r=function(){var t=e._updateOfferLimits(e.currentOfferLimits());e.da.saveOfferLimits(t),e.isVisible=!0,e.offerRecord.offer_is_visible=!0,e.offerRecord.presentation="presented",e.offerRecord.presentation_timestamp=(new Date).toISOString(),e.offerRecord.offer_is_visible=!0,e.saveStateAndSync("po"),e.publish("OFFER-PRESENTED")};return setTimeout(function(){if("function"!=typeof e.engagementFunction)throw new Error("The engagementFunction was not set to be a valid function");e.engagementFunction(e,e.offerRecord.engagement_selected,r)},1e3*t),!0},_MetricalOfferFlowClass.prototype._engagementDelay=function(){var e=0;return this.offerRecord.engagement_selected&&"delay"in this.offerRecord.engagement_selected&&(e=this.offerRecord.engagement_selected.delay||0),e},_MetricalOfferFlowClass.prototype._updateOfferLimits=function(e){if(e.total++,this.properties.globalofferlimittimeout>0&&null===e.resetOn){var t=(new Date).getTime();t+=1e3*this.properties.globalofferlimittimeout,e.resetOn=t}if(null!==this.offerRecord.engagement_selected){var r=this.offerRecord.engagement_selected.id,i="offerlimittimeout"in this.offerRecord.engagement_selected?this.offerRecord.engagement_selected.offerlimittimeout:null;if(r in e.offers||(e.offers[r]={total:0,resetOn:null}),e.offers[r].total++,i>0&&null===e.offers[r].resetOn){t=(new Date).getTime();t+=1e3*i,e.offers[r].resetOn=t}}return e},_MetricalOfferFlowClass.prototype.dismissed=function(e){this.response("dismissed")},_MetricalOfferFlowClass.prototype.submitted=function(e){this.response("submitted")},_MetricalOfferFlowClass.prototype.expired=function(){this.response("timer expired")},_MetricalOfferFlowClass.prototype.response=function(e){return this.logger.traceStart("response"),this.logger.debug({status:e}),-1===this.validResponses.indexOf(e)?(this.logger.warning(e+" is an invalid offer flow status",{status:e}),!1):null===this.offerRecord.response||"dismissed"==this.offerRecord.response&&"dismissed"!==e||"timer expired"==this.offerRecord.response&&"submitted"===e?(this.logger.info("Session responded with status "+e,{terminal:!0,status:e}),this.offerRecord.response_timestamp=(new Date).toISOString(),this.offerRecord.response=e,this.publish("CUSTOMER-RESPONDED"),this.closeOffer(),!0):(this.logger.warning("Skipping for status "+e,{status:e}),void this.logger.traceEnd("response"))},_MetricalOfferFlowClass.prototype.addTag=function(e){this.queuedTags=Object.assign({},this.queuedTags,e||{})},_MetricalGA=function(e){var t={logger:new _MetricalLogger({extra:{module:"ga"}}),isactive:!1,dataLayerKey:"dataLayer"};this.properties=Object.assign({},t,e||{}),this.dataLayerPresent=!!window[this.properties.dataLayerKey],this.logger=this.properties.logger},_MetricalGA.prototype.event=function(e,t){var r={presented:function(){return _MetricalPresented(e,t)},interaction:function(){return _MetricalInteraction(e,t)},default:function(){return _MetricalDefault(e,t)}};return(r[e]||r.default)()},_MetricalGA.prototype.record=function(e,t){if(this.properties.isactive&&this.dataLayerPresent){var r=this.event(e,t);window[this.properties.dataLayerKey].push(r),this.logger.debug("pushed to GA",{obj:r})}else this.logger.debug("GA record() is disabled",{isactive:this.properties.isactive,dataLayerPresent:this.dataLayerPresent})},_MetricalDefault=function(e,t){var r=Object.assign({},{event:"",data:{}});return r.event="metrical_default",r.data=t,r},_MetricalInteraction=function(e,t){if(!e)throw new Error("An event is required to pass");if(!t)throw new Error("Interaction Object is required");var r=Object.assign({},{event:"",interaction:{}});return r.event=e+"_"+t.action,r.interaction=t,r},_MetricalPresented=function(e,t){if(!e)throw new Error("An event is required to pass");if(!t)throw new Error("Data Object is required");return Object.assign({},{event:"metrical_presented"},t)};var _MetricalACInteractions={apiendpoint:_MetricalHosts.endpoints.interaction,interactionsSourceID:"InteractionsModule",captureinteractions:!1,captureallinteractions:!1,capturescrollinteractions:!1,norecordonsubmitifempty:!1,capturescrollinteractionsthreshold:0,interactions:[],interactionsHandlers:[],interactionsObserver:null,interactionsIframeHandlers:[],interactionsIframeObservers:{},postRecordAction:null,scrollThresholdReachedTimes:0,scrollInteractionsRecordingLimit:2,originalDocumentHeight:0,intProcessedTimestamps:{},limitInteractionsProcessingRate:!0,type:"ecommerce",recordInteractionCallback:null,recordInteractionObservers:[],observersCalled:[],interactionModificationCallback:void 0,customEventsList:["element closed","element opened","text changed","attribute changed","elements added","elements removed"],getBasicInteractionData:function(){return uuid=this.Util.makeUUID(),{uuid:uuid,survey_id:this.interactionsSourceID}},getInteractionData:function(){return{}},init:function(e,t,r,i,o){if(mbInt=e,this.mBrowser=e,_MetricalACInteractions.Log.info("Initializing the _MetricalACInteractions module"),null!=t.apiendpoint&&(this.apiendpoint=t.apiendpoint),null!=t.captureinteractions&&(this.captureinteractions=t.captureinteractions),null!=t.captureallinteractions&&(this.captureallinteractions=t.captureallinteractions),null!=t.capturescrollinteractions&&(this.capturescrollinteractions=t.capturescrollinteractions),null!=t.limitinteractionsprocessingrate&&(this.limitInteractionsProcessingRate=t.limitinteractionsprocessingrate),null!=t.norecordonsubmitifempty&&(this.norecordonsubmitifempty=t.norecordonsubmitifempty),null!=t.interactionModificationCallback&&(this.interactionModificationCallback=t.interactionModificationCallback),null!=t.capturescrollinteractionsthreshold&&(this.capturescrollinteractionsthreshold=t.capturescrollinteractionsthreshold,Array.isArray(this.capturescrollinteractionsthreshold))){this.scrollThresholdReachedTimes={};for(var n=0;n<this.capturescrollinteractionsthreshold.length;n++)this.scrollThresholdReachedTimes[100*this.capturescrollinteractionsthreshold[n]+"%"]=0}if(t.type&&(this.type=t.type),null!=t.interactions&&(this.interactions=this.interactions.concat(t.interactions)),r&&"function"==typeof r&&(this.getInteractionData=r),i&&"function"==typeof i&&(this.postRecordAction=i),1==_MetricalACInteractions.captureinteractions&&1==_MetricalACInteractions.captureallinteractions){null!=o&&"function"==typeof o&&(this.recordInteractionCallback=o);try{this.setupInteractions(),this.setupLoadUnloadInteractions(),this.processURLInteractions()}catch(e){console.log("Skipping custom interactions, due to error %s",e)}}else _MetricalACInteractions.Log.info("Did not set up the interactions capture, since captureinteractions or captureallinteractions is/are set to false");_MetricalACInteractions.Log.info("Finished the initialization of the _MetricalACInteractions module",this)},setupLoadUnloadInteractions:function(){this.recordInteraction("",null,!0,!1)},relinkBasicInteractions:function(){mbInt.each(_MetricalACInteractions.interactions,function(e,t){var r=mbInt.getElement(t.selector);if(r&&!_MetricalACInteractions.isCustomEvent(t.event)){var i=t.event+".Metrical";this.mbInt.removeEvent(r,i),this.mbInt.addEvent(r,i,function(e){void 0!==e.originalEvent&&_MetricalACInteractions.processInteraction(t,e)})}})},setupInteractions:function(){mbInt.each(_MetricalACInteractions.interactions,function(key,interaction){if(!_MetricalACInteractions.isInteractionAlreadyRegistered(interaction)){var interactionEventHandler=function(e){void 0!==e.originalEvent&&_MetricalACInteractions.processInteraction(interaction,e)},customEventInteractionEventHandler=function(event){switch(interaction.event){case"element closed":recordInteraction=_MetricalACInteractions.isElementClosedInteraction(event),fieldKey=interaction.fieldkey,fieldVal=eval(interaction.fieldeval);break;case"element opened":recordInteraction=_MetricalACInteractions.isElementOpenedInteraction(event),fieldKey=interaction.fieldkey,fieldVal=eval(interaction.fieldeval);break;case"text changed":recordInteraction=!0,fieldKey=interaction.fieldkey?interaction.fieldkey:"text_changed",fieldValString=interaction.fieldeval?interaction.fieldeval:"event[0].target.textContent",fieldVal=eval(fieldValString);break;case"attribute changed":recordInteraction=_MetricalACInteractions.isAttributeChangedInteraction(event,interaction.observedattributes),fieldKey=interaction.fieldkey?interaction.fieldkey:"attribute_changed",fieldValString=interaction.fieldeval?interaction.fieldeval:"event[0].attributeName",fieldVal=eval(fieldValString);break;case"elements added":recordInteraction=_MetricalACInteractions.isElementsAddedInteraction(event),fieldKey=interaction.fieldkey?interaction.fieldkey:"elements_added",fieldValString=interaction.fieldeval?interaction.fieldeval:"JSON.stringify(event[0].addedNodes)",fieldVal=eval(fieldValString);break;case"elements removed":recordInteraction=_MetricalACInteractions.isElementsRemovedInteraction(event),fieldKey=interaction.fieldkey?interaction.fieldkey:"elements_removed",fieldValString=interaction.fieldeval?interaction.fieldeval:"JSON.stringify(event[0].removedNodes)",fieldVal=eval(fieldValString);break;default:recordInteraction=!1,fieldKey=interaction.fieldkey,fieldVal=eval(interaction.fieldeval)}recordInteraction&&_MetricalACInteractions.processInteraction(interaction,event,fieldKey,fieldVal)},selectorInt=mbInt.getElement(interaction.selector);if(selectorInt)if(_MetricalACInteractions.Log.info("Registering the event handler for the custom interaction",interaction),_MetricalACInteractions.isCustomEvent(interaction.event)){var selectors=mbInt.getAllElements(interaction.selector);mbInt.each(selectors,function(e,t){_MetricalACInteractions.Log.info("Registering an observer for '"+interaction.event+"' interactions on the element",t),elementObserver=new MutationObserver(customEventInteractionEventHandler),elementObserver.observe(t,_MetricalACInteractions.getObserverConfigForCustomEvent(interaction.event))}),_MetricalACInteractions.interactionsHandlers.push({selector:interaction.selector,event:interaction.event,handlerFunction:customEventInteractionEventHandler})}else{var eventNamespace=interaction.event+".Metrical",sInt=mbInt.getElement(interaction.selector);this.mbInt.removeEvent(sInt,eventNamespace,interactionEventHandler),this.mbInt.addEvent(sInt,eventNamespace,interactionEventHandler),_MetricalACInteractions.interactionsHandlers.push({selector:interaction.selector,event:interaction.event,handlerFunction:interactionEventHandler})}}}),null==_MetricalACInteractions.interactionsObserver&&(_MetricalACInteractions.Log.info("Setting up an observer for the elements with interactions"),_MetricalACInteractions.interactionsObserver=new MutationObserver(_MetricalACInteractions.setupInteractions),_MetricalACInteractions.interactionsObserver.observe(document.documentElement,{childList:!0,subtree:!0}))},checkInteractionProcessingLimit:function(e){var t=!1;if(this.limitInteractionsProcessingRate){var r=e.selector.replace(/ /g,"_")+"_"+e.event.replace(/ /g,"_"),i=+new Date;null==_MetricalACInteractions.intProcessedTimestamps[r]&&(_MetricalACInteractions.intProcessedTimestamps[r]=i);var o=i-_MetricalACInteractions.intProcessedTimestamps[r],n=!0;if("element opened"==e.event||"element closed"==e.event){var a="element opened"==e.event?"element_closed":"element_opened",s=e.selector.replace(/ /g,"_")+"_"+a;if(null!=_MetricalACInteractions.intProcessedTimestamps[s])i-_MetricalACInteractions.intProcessedTimestamps[s]<1e3&&(n=!1);else _MetricalACInteractions.intProcessedTimestamps[s]=i;_MetricalACInteractions.intProcessedTimestamps[r]>_MetricalACInteractions.intProcessedTimestamps[s]&&(n=!1)}(0==o||o>=1e3)&&n&&(_MetricalACInteractions.intProcessedTimestamps[r]=+new Date,t=!0)}else t=!0;return t},processInteraction:function(interaction,event,fieldKey,fieldVal){if(_MetricalACInteractions.checkInteractionProcessingLimit(interaction)){targetToRecord=null,null!=interaction.recordtarget&&1==interaction.recordtarget&&(null==fieldKey&&(fieldKey=interaction.fieldkey),null==fieldVal&&(fieldVal=eval(interaction.fieldeval)),targetToRecord={field_key:fieldKey,target:fieldVal}),null!=interaction.chainedinteraction&&"before"==interaction.chainedinteraction.chainorder&&_MetricalACInteractions.processInteraction(_MetricalACInteractions.interactions[interaction.chainedinteraction.interactionindex],event);var isAsync="isasync"in interaction?interaction.isasync:void 0;_MetricalACInteractions.recordInteraction(interaction.action,targetToRecord,isAsync),null!=interaction.chainedinteraction&&"after"==interaction.chainedinteraction.chainorder&&_MetricalACInteractions.processInteraction(_MetricalACInteractions.interactions[interaction.chainedinteraction.interactionindex],event)}},indicatorNotPresent:function(e){return 1!=this.mBrowser.getElement(e).data("_MetricalInteractionIsSet")},isCustomEvent:function(e){return this.customEventsList.indexOf(e)>-1},getObserverConfigForCustomEvent:function(e){switch(e){case"element closed":case"element opened":config={attributes:!0,subtree:!1,childList:!1,characterData:!1};break;case"text changed":config={attributes:!1,subtree:!0,childList:!1,characterData:!0};break;case"attribute changed":config={attributes:!0,subtree:!1,childList:!1,characterData:!1};break;case"elements added":case"elements removed":config={attributes:!1,subtree:!1,childList:!0,characterData:!1};break;default:config={subtree:!0,childList:!0}}return config},isElementClosedInteraction:function(e){return elementClosedInteractionPerformed=!1,element=e[0].target,"none"!=element.style.display&&"0px"!=element.style.width&&"hidden"!=element.style.visibility||(elementClosedInteractionPerformed=!0),elementClosedInteractionPerformed},isElementOpenedInteraction:function(e){return elementOpenedInteractionPerformed=!1,element=e[0].target,"none"!=element.style.display&&"0px"!=element.style.width&&"hidden"!=element.style.visibility&&(elementOpenedInteractionPerformed=!0),elementOpenedInteractionPerformed},isAttributeChangedInteraction:function(e,t){return attributeChangedInteractionPerformed=!1,t.indexOf(e[0].attributeName)>-1&&(attributeChangedInteractionPerformed=!0),attributeChangedInteractionPerformed},isElementsAddedInteraction:function(e){elementsAddedInteractionPerformed=!1;for(var t=0;t<e.length;t++)if(e[t].addedNodes.length>0){elementsAddedInteractionPerformed=!0;break}return elementsAddedInteractionPerformed},isElementsRemovedInteraction:function(e){elementsRemovedInteractionPerformed=!1;for(var t=0;t<e.length;t++)if(e[t].removedNodes.length>0){elementsRemovedInteractionPerformed=!0;break}return elementsRemovedInteractionPerformed},processURLInteractions:function(){mbInt.each(_MetricalACInteractions.interactions,function(e,t){"url"==t.event&&(patt=new RegExp(t.urlmatch),urlMatches=patt.test(window.location.href),urlMatches&&_MetricalACInteractions.processInteraction(t,null,null!=t.fieldkey?t.fieldkey:"",_MetricalACInteractions.Util.getURLParameterByName(t.urlparameter,window.location.href)))})},isInteractionAlreadyRegistered:function(e){for(var t=0;t<_MetricalACInteractions.interactionsHandlers.length;t++)if(rInteraction=_MetricalACInteractions.interactionsHandlers[t],e.selector==rInteraction.selector&&e.event==rInteraction.event)return!0;return!1},setupIframeInteractions:function(){null!=this.mBrowser.getElement("iframe")&&this.mBrowser.addEvent(this.mBrowser.getElement("iframe"),"load",function(){_MetricalACInteractions.Log.info("Iframe loaded. Configuring the custom interactions...",this);var e=this.src;if(_MetricalACInteractions.isSameOrigin(e)){var t=this.contentWindow.document,r=this.contentWindow;null!=_MetricalACInteractions.interactionsIframeObservers[e]&&_MetricalACInteractions.interactionsIframeObservers[e].disconnect(),observer=new MutationObserver(function(){mbInt.each(_MetricalACInteractions.interactions,function(i,o){var n=function(e){void 0!==e.originalEvent&&_MetricalACInteractions.processInteraction(o,e,o.fieldkey,r.eval(o.fieldeval))},a=function(e){switch(o.event){case"element closed":recordInteraction=_MetricalACInteractions.isElementClosedInteraction(e),fieldKey=o.fieldkey,fieldVal=r.eval(o.fieldeval);break;case"element opened":recordInteraction=_MetricalACInteractions.isElementOpenedInteraction(e),fieldKey=o.fieldkey,fieldVal=r.eval(o.fieldeval);break;case"text changed":recordInteraction=!0,fieldKey=o.fieldkey?o.fieldkey:"text_changed",fieldValString=o.fieldeval?o.fieldeval:"event[0].target.textContent",fieldVal=r.eval(fieldValString);break;case"attribute changed":recordInteraction=_MetricalACInteractions.isAttributeChangedInteraction(e,o.observedattributes),fieldKey=o.fieldkey?o.fieldkey:"attribute_changed",fieldValString=o.fieldeval?o.fieldeval:"event[0].attributeName",fieldVal=r.eval(fieldValString);break;case"elements added":recordInteraction=_MetricalACInteractions.isElementsAddedInteraction(e),fieldKey=o.fieldkey?o.fieldkey:"elements_added",fieldValString=o.fieldeval?o.fieldeval:"JSON.stringify(event[0].addedNodes)",fieldVal=r.eval(fieldValString);break;case"elements removed":recordInteraction=_MetricalACInteractions.isElementsRemovedInteraction(e),fieldKey=o.fieldkey?o.fieldkey:"elements_removed",fieldValString=o.fieldeval?o.fieldeval:"JSON.stringify(event[0].removedNodes)",fieldVal=r.eval(fieldValString);break;default:recordInteraction=!1,fieldKeyValue=o.fieldkey,fieldVal=r.eval(o.fieldeval)}recordInteraction&&_MetricalACInteractions.processInteraction(o,e,fieldKey,fieldVal)};_MetricalACInteractions.isCustomInteractionIframeAlreadyRegistered(e,o)&&jqInt(o.selector,t).unbind(o.event),jqInt(o.selector,t).length>0&&(_MetricalACInteractions.Log.info("Registering the event handler for the custom interaction on the iframe",o),_MetricalACInteractions.isCustomEvent(o.event)?(mbInt.each(mbInt.getElement(o.selector),function(e,t){_MetricalACInteractions.Log.info("Registering an observer for '"+o.event+"' interactions on the iframe on the element",t),elementObserver=new MutationObserver(a),elementObserver.observe(t,_MetricalACInteractions.getObserverConfigForCustomEvent(o.event))}),_MetricalACInteractions.interactionsIframeHandlers.push({ifrSrc:e,selector:o.selector,event:o.event,handlerFunction:a})):(mbInt.removeEvent(o.selector,o.event,n),customHandler=jqInt(o.selector,t).on(o.event,null,null,n),_MetricalACInteractions.interactionsIframeHandlers.push({ifrSrc:e,selector:o.selector,event:o.event,handlerFunction:n})))}),_MetricalACInteractions.Log.info("Ending custom interactions iframe setup")}),observer.observe(t.documentElement,{childList:!0,subtree:!0}),_MetricalACInteractions.interactionsIframeObservers[e]=observer}})},isCustomInteractionIframeAlreadyRegistered:function(e,t){for(var r=0;r<_MetricalACInteractions.interactionsIframeHandlers.length;r++)if(rInteraction=_MetricalACInteractions.interactionsIframeHandlers[r],t.selector==rInteraction.selector&&t.event==rInteraction.event&&e==rInteraction.ifrSrc)return!0;return!1},setupScrollInteractions:function(){var e=new _MetricalDimensions;this.originalDocumentHeight=e.documentHeight();var t,r=window,i=(r.scrollTop(),this);1==this.capturescrollinteractions?(scrollHandler=function(){i.originalDocumentHeight==r.height()&&(i.originalDocumentHeight=e.documentHeight());var o=100*r.scrollTop()/(i.originalDocumentHeight-r.height());if(!isNaN(o)&&isFinite(o)&&(scrollThresholdData=i.getScrollThresholdReached(o),(null==scrollThresholdData.thresholdReached||scrollThresholdData.thresholdReached)&&scrollThresholdData.recordInteraction)){o=o.toFixed()+"%";var n=r.scrollTop();t&&clearTimeout(t),t=setTimeout(function(){i.shouldScrollInteractionBeRecorded(scrollThresholdData)&&(percent=null!=scrollThresholdData.thresholdReached?scrollThresholdData.thresholdReached:o,_MetricalACInteractions.recordInteraction("scroll to "+percent,null,!0))},1e3),n}},r.off("scroll",scrollHandler),r.on("scroll",scrollHandler)):_MetricalACInteractions.Log.info("Did not set up the scroll interactions capture, since capturescrollinteractions is set to false")},getScrollThresholdReached:function(e){if(thresholdData={recordInteraction:!1,thresholdReached:null},Array.isArray(this.capturescrollinteractionsthreshold))for(var t=0;t<this.capturescrollinteractionsthreshold.length;t++){if(null!=this.capturescrollinteractionsthreshold[t+1]&&e>100*this.capturescrollinteractionsthreshold[t]&&e<=100*this.capturescrollinteractionsthreshold[t+1]){thresholdData.thresholdReached=100*this.capturescrollinteractionsthreshold[t]+"%",thresholdData.recordInteraction=!0;break}if(null==this.capturescrollinteractionsthreshold[t+1]&&e>100*this.capturescrollinteractionsthreshold[t]){thresholdData.thresholdReached=100*this.capturescrollinteractionsthreshold[t]+"%",thresholdData.recordInteraction=!0;break}}else 0==this.capturescrollinteractionsthreshold?thresholdData.recordInteraction=!0:e>=100*this.capturescrollinteractionsthreshold&&(thresholdData.thresholdReached=100*this.capturescrollinteractionsthreshold+"%",thresholdData.recordInteraction=!0);return thresholdData},shouldScrollInteractionBeRecorded:function(e){return shouldBeRecorded=!1,e.recordInteraction&&(thresholdReached=e.thresholdReached,null==thresholdReached&&(shouldBeRecorded=!0),null!=thresholdReached&&Number.isInteger(this.scrollThresholdReachedTimes)&&this.scrollThresholdReachedTimes<this.scrollInteractionsRecordingLimit&&(shouldBeRecorded=!0,this.scrollThresholdReachedTimes++),null!=thresholdReached&&"object"==typeof this.scrollThresholdReachedTimes&&this.scrollThresholdReachedTimes[thresholdReached]<this.scrollInteractionsRecordingLimit&&(shouldBeRecorded=!0,this.scrollThresholdReachedTimes[thresholdReached]++)),shouldBeRecorded},isIframeOnSameDomain:function(e){return ifrDomain=this.extractHostname(e),currentDomain=this.extractHostname(window.location.href),ifrDomain==currentDomain},isSameOrigin:function(e){var t=window.location.protocol+"//"+window.location.hostname;return 0==e.split("?")[0].indexOf(t)},extractHostname:function(e){return(e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0]).split(":")[0].split("?")[0]},extractRootDomain:function(e){var t=this.extractHostname(e),r=t.split("."),i=r.length;return i>2&&(t=r[i-2]+"."+r[i-1],2==r[i-1].length&&2==r[i-1].length&&(t=r[i-3]+"."+t)),t},registerRecordInteractionObserver:function(e,t){0==this.recordInteractionObservers.map(function(e){return e.key}).includes(e)&&this.recordInteractionObservers.push({key:e,callback:t})},handleInteractionEvent:function(e,t){var r=e.action||t.topic||"event",i=e.target?{field_key:"event",target:e.target}:null;this.recordInteraction(r,i)},recordInteraction:function(e,t,r,i){if(this.captureinteractions){var o=this;o.observersCalled=[],r=void 0===r||r,i=void 0===i||i;var n=function(t){for(var r in t.usermeta)void 0===t.usermeta[r]&&(t.usermeta[r]=null);_MetricalStorage.SessionStorage.setItem("lastUserMeta",t.usermeta),mbInt.sendBeacon(o.apiendpoint,t);for(var n=0;n<o.recordInteractionObservers.length;n++){var a=o.recordInteractionObservers[n];"function"==typeof a.callback&&a.callback(t)}null!=o.postRecordAction&&i&&o.postRecordAction(e),"function"==typeof o.recordInteractionCallback&&o.recordInteractionCallback(t)};if("assign"in Object==0?interactionData=mbInt.extend(this.getBasicInteractionData(),this.getInteractionData()):interactionData=Object.assign(this.getBasicInteractionData(),this.getInteractionData()),interactionData.action=e,interactionData.type=this.type||"ecommerce",null!=t&&(interactionData[t.field_key]=t.target),"function"==typeof this.interactionModificationCallback)this.interactionModificationCallback(window.jQuery||void 0,interactionData,n,r);else n(interactionData);if(_MetricalAbandonCart.Config.gacaptureinteraction)_MetricalAbandonCart.logger.debug("processing GA interaction event"),new _MetricalGA({logger:_MetricalAbandonCart.logger.child({module:"ga"}),isactive:_MetricalAbandonCart.Config.gaisactive}).record("interaction",interactionData)}else _MetricalACInteractions.Log.info("Interactions capture disabled")},Log:{logs:new Array,buffer:!0,info:function(){var e=Array.prototype.slice.call(arguments);mbInt.each(e,function(e,t){});var t={type:"info",timestamp:this.timeStamp(),echoed:!1,data:e};this.logs.push(t),this.buffer||this.echo()},error:function(){var e=Array.prototype.slice.call(arguments);mbInt.each(e,function(e,t){});var t={type:"error",timestamp:this.timeStamp(),echoed:!1,data:e};this.logs.push(t),this.buffer||this.echo()},echo:function(){var e=this;return window.console&&mbInt.each(this.logs,function(t,r){r.echoed||(e.printOutData(r),r.echoed=!0)}),"End of logs"},echoAll:function(){var e=this;return window.console&&mbInt.each(this.logs,function(t,r){e.printOutData(r)}),"End of logs"},printOutData:function(e){"info"==e.type?console.info(e.timestamp+": ",e.data):"error"==e.type&&mbInt.each(e.data,function(t,r){r instanceof Error?console.error(e.timestamp+" - "+r.name+" - "+r.message+": ",r.stack):console.error(e.timestamp+": ",r)})},timeStamp:function(){var e=new Date,t=[e.getMonth()+1,e.getDate(),e.getFullYear()],r=[e.getHours(),e.getMinutes(),e.getSeconds()],i=r[0]<12?"AM":"PM";r[0]=r[0]<12?r[0]:r[0]-12,r[0]=r[0]||12;for(var o=1;o<3;o++)r[o]<10&&(r[o]="0"+r[o]);return t.join("/")+" "+r.join(":")+" "+i}},Util:{makeUUID:function(){var e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?r:7&r|8).toString(16)})},identifierIsIOS:function(){return!!/iPhone|iPad|iPod/i.test(navigator.userAgent)},getURLParameterByName:function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var r=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null}}},mbInt=null;_MetricalHeartBeat=function(e){if(this.properties=Object.assign({},{interaction_action:"heartbeat",interactions:null,sequenceConfiguration:null,logger:null},e||{}),this.interactions=this.properties.interactions,this.sequenceConfiguration=this.properties.sequenceConfiguration,this.logger=this.properties.logger,this.interval=null,this.timeOuts=[],null===this.interactions)throw new Error("Interactions needs to be supplied to the _MetricalHeartBeat class");if(null===this.sequenceConfiguration)throw new Error("Sequence Configuration needs to be supplied to the _MetricalHeartBeat class")},_MetricalHeartBeat.prototype.start=function(){var e=this;e.logger.debug("Starting heatbeats"),this.sequenceConfiguration.forEach(function(t){var r=void 0,i=void 0,o=void 0;"intervalSeconds"in t&&(r="intervalSeconds",o=1e3*(i=t.intervalSeconds)),"intervalMilliseconds"in t&&(r="intervalMilliseconds",o=i=t.intervalMilliseconds),"interval"==t.type&&o?e.publishAndRecordIntervalInteraction(t,r,o,i):"tick"==t.type&&o?e.publishAndRecordTickInteraction(r,o,i):"backoffInterval"==t.type&&o&&e.recordBackOffInterval(t,o)})},_MetricalHeartBeat.prototype.publishAndRecordIntervalInteraction=function(e,t,r,i){var o=this;this.interval=setInterval(function(){var e="intervalSeconds"==t?`Interval HeartBeat runs every ${i} seconds`:`Interval HeartBeat runs every ${r} Millisconds`;o.logger.debug(e),o.interactions.recordInteraction(o.properties.interaction_action)},r)},_MetricalHeartBeat.prototype.publishAndRecordTickInteraction=function(e,t,r){var i=this;i.timeOuts.push(setTimeout(function(){var o="intervalSeconds"==e?`Tick HeartBeat runs at ${r} seconds`:`Tick HeartBeat runs at ${t} Millisconds`;i.logger.debug(o),i.interactions.recordInteraction(i.properties.interaction_action)},t))},_MetricalHeartBeat.prototype.recordBackOffInterval=function(e,t){var r=this,i=function(e){r.timeOuts.push(setTimeout(function(){r.logger.debug(`backoffInterval HeartBeat runs after every ${e} Millisconds`),r.interactions.recordInteraction(r.properties.interaction_action);var t,o=(t=e,Math.round(Math.min(1.2*t)));i(o)},e))};i(t)},_MetricalHeartBeat.prototype.stop=function(){this.logger.info("Stopping heartbeats"),null!=this.interval&&clearInterval(this.interval),this.timeOuts.length>0&&this.timeOuts.forEach(function(e){clearTimeout(e)})},_MetricalIdle={init:function(e){if(this.properties=Object.assign({},{actionLabel:"idle",interactions:null},e||{}),this.interactions=this.properties.interactions,null===this.interactions)throw new Error("interactions needs to be defined for heartbeat");this.noInteractionFirstCheck=!1,this.noInteractionSecondCheck=!1},beat:function(e){e?(this.noInteractionFirstCheck=!1,this.noInteractionSecondCheck=!1):0==this.noInteractionFirstCheck&&0==this.noInteractionSecondCheck?this.noInteractionFirstCheck=!0:1==this.noInteractionFirstCheck&&0==this.noInteractionSecondCheck&&(this.noInteractionSecondCheck=!0,this.interactions.recordInteraction(this.properties.actionLabel))},isIdle:function(){return this.noInteractionFirstCheck&&this.noInteractionSecondCheck}},_MetricalIdentity={pubsub:new _MetricalUtils.PubSub,pubsubTopics:{"reset-session-id":"reset-session-id"},topic:"event/reset-session-id",keyUuid:"uuid",keySessionId:"session_id",properties:{},instanceId:null,timerToken:null,resetInterval:18e5,init:function(e){this.properties=Object.assign({},{storage:null,bus:null,utils:null},e||{}),this.storage=this.properties.storage,this.utils=this.properties.utils,this.bus=this.properties.bus,this.initializeInstanceId(),this.initializeDeviceId(),this.initializeSessionId()},initializeInstanceId:function(){this.instanceId=this.utils.makeUUID()},initializeDeviceId:function(){this.storage.hasItem(this.keyUuid)||this.storage.setItem(this.keyUuid,this.utils.makeUUID())},initializeSessionId:function(){this.storage.hasItem(this.keySessionId)||this.resetSessionId()},resetSessionId:function(){var e=this.utils.makeUUID();this.storage.setItem(this.keySessionId,e,{expiresAfter:1800}),this.bus.publish(this.topic,{sessionId:e})},getSessionId:function(){var e=this.storage.getItem(this.keySessionId);return null===e&&(this.resetSessionId(),e=this.storage.getItem(this.keySessionId)),e},getDeviceId:function(){return this.storage.getItem(this.keyUuid)},getInstanceId:function(){return this.instanceId},getLastTimestamp:function(){return this.storage.getItem("_Metrical_lastTimestamp")},setLastTimestamp:function(){this.storage.setItem("_Metrical_lastTimestamp",Date.now())}};var _MetricalAssetLoader={assets:[],assetItems:[],assetsJSON:[],assetsFailed:[],logger:null,loadSuccessCallback:function(){console.log("Default success callback")},loadFailedCallback:function(){console.log("The loading of one or more assets failed",_MetricalAssetLoader.assetsFailed)},init:function(mBrowser,properties,successCallback,failCallback){mbAss=mBrowser,assetItems=[],assetJSON=[],assetFailed=[],null!=successCallback&&(this.loadSuccessCallback=successCallback),null!=failCallback&&(this.loadFailedCallback=failCallback),mbAss.each(properties.assets,function(key,asset){addAsset=!0,null!=asset.filter&&""!=asset.filter&&(res=eval(asset.filter),res||(addAsset=!1)),addAsset&&_MetricalAssetLoader.addAssetItem(asset)})},addAssetItem:function(e){var t=this;this.assetItems.push(function(e){var r=e;return new Promise(function(e,i){t.loadAsset(r,null,e,i)})}(e))},exec:function(){Promise.all(this.assetItems).then(this.loadSuccessCallback,this.loadFailedCallback)},loadAsset:function(e,t,r,i){if(this.logger&&this.logger.info("loading asset",{asset:e}),"json"==e.type)mbAss.get(e.url).then(function(i){_MetricalAssetLoader.assetsJSON.push(i);var o=document.createElement("script");o.type="application/json";try{o.appendChild(document.createTextNode(JSON.stringify(i))),document.body&&document.body.appendChild(o)}catch(e){o.text=JSON.stringify(i),document.body&&document.body.appendChild(o)}null!=t?t.resolve(e.url):r(e.url)}).catch(function(r){_MetricalAssetLoader.assetsFailed.push({url:e.url,status:r.message}),null!=t?t.reject(e.url):i(e.url)});else{switch(e.type){case"js":tag="script";break;case"css":tag="link";break;case"img":tag="img";break;case"font":tag="link";break;default:tag="link"}var o=document.createElement(tag),n="body",a="src";switch(o.onload=function(){try{(e.type=document[n])&&document[n].removeChild(o),null!=t?t.resolve(e.url):r(e.url)}catch(e){console.error(e)}},o.onerror=function(){_MetricalAssetLoader.assetsFailed.push({url:e.url,status:status}),null!=t?t.reject(e.url):i(e.url)},e.type){case"js":o.async=!0;break;case"css":o.type="text/css",o.rel="stylesheet",a="href",n="head";break;case"font":o.type="font/otf",o.rel="prefetch",o.as="font",a="href",n="head",crossorigin="anonymous";break;case"img":o.alt=e.alt?e.alt:"",o.style=e.style?e.style:""}o[a]=e.url,document[n]&&document[n].appendChild(o)}},assetExists:function(e){var t=new XMLHttpRequest;return t.open("HEAD",e,!1),t.setRequestHeader("Access-Control-Allow-Origin","*"),t.withCredentials=!1,t.send(),404!=t.status}},mbAss=null,_MetricalBrowserHistory={key:"urlHistory",history:[],init:function(){var e=window.location.href;this.history=this.getHistoryFromStorage(),this.history.unshift(e),this.saveHistoryToStorage()},storageHasKey:function(){for(var e=!1,t=this.key,r=0;r<window.sessionStorage.length;r++)window.sessionStorage.key(r)==t&&(e=!0);return e},getHistoryFromStorage:function(){var e=[];return this.storageHasKey()&&(e=JSON.parse(window.sessionStorage.getItem(this.key))),e},saveHistoryToStorage:function(){window.sessionStorage.setItem(this.key,JSON.stringify(this.history))},getCurrentUrl:function(){return this.history.length>0?this.history[0]:null},getLastUrl:function(){return this.history.length>1?this.history[1]:null}};_MetricalPE={mbPE:null,ac:null,log:null,identity:null,endpoint:null,socket:null,testSocket:null,registrations:0,init:function(e){try{for(var t in this.mbPE=e.mb,this.ac=e.ac,this.log=e.log,this.identity=e.identity,this.endpoint=e.endpoint,this.conditions=e.conditions,this.utils=_MetricalUtils,this.pubsub=new _MetricalUtils.PubSub,this.pubsub)this[t]=this.pubsub[t]}catch(e){this.log.error(e)}},shouldRun:function(){var e=this;return new Promise(function(t,r){try{var i=e._getStartRule(),o=e._getEndRule();i&&o?Promise.all([e._evalRule(i),e._evalRule(o)]).then(function(e){1==e[0]&&0==e[1]?t(!0):t(!1)}).catch(function(e){throw e}):i&&!o?e._evalRule(i).then(function(e){t(1==e)}).catch(function(e){throw e}):!i&&o?e._evalRule(o).then(function(e){t(0==e)}).catch(function(e){throw e}):t(!0)}catch(e){r(e)}})},_getStartRule:function(){return"Config"in this.ac&&"probabilityengine"in this.ac.Config&&"startrule"in this.ac.Config.probabilityengine?this.ac.Config.probabilityengine.startrule:null},_getEndRule:function(){return"Config"in this.ac&&"probabilityengine"in this.ac.Config&&"endrule"in this.ac.Config.probabilityengine?this.ac.Config.probabilityengine.endrule:null},_evalRule:function(ruleObj){var that=this;return new Promise(function(resolve,reject){try{var type=ruleObj.type||"eval",rule=ruleObj.rule||"";if(""==rule&&resolve(!1),"condition"==type)that.conditions.evaluateConditions().then(function(e){var t=that.utils.evaluateRule(rule,e,{});resolve(t)}).catch(function(e){throw e});else{var value=eval(rule);resolve(value)}}catch(e){reject(e)}})},sendInteractionData:function(e){var t=this;return new Promise(function(r,i){t.log.traceStart("sendInteractionData"),t.log.debug("sendInteractionData data",{data:e}),t.publish("pre/pe",e),t.log.debug("after pe sendInteractionData publish");try{t.log.debug("pe fetch call"),t.mbPE.post(t.endpoint,{body:e}).then(function(e){t.log.debug("promise results from pe fetch call",{data:e}),t.ac.abandonprobable=Object.assign({},e),t.publish("post/pe",t.ac.abandonprobable),r(t.ac.abandonprobable)}).catch(function(e){t.log.error("error on post fetch call for pe",{error:e}),i(e)}),t.log.traceEnd("sendInteractionData")}catch(e){t.log.error("pe fetch error",{error:e,errorMessage:e.message}),i(e)}})}};var _MetricalTestMode={storage:null,key:"testMode",init:function(e){this.storage=e},enable:function(){return this.storage.setItem(this.key,1),"Test Mode is enabled"},disable:function(){return this.storage.setItem(this.key,0),"Test Mode is disabled"},isInTestMode:function(){return"1"==this.storage.getItem(this.key)}};_MetricalTrafficControl={init:function(e,t,r){null!=r&&(this.logger=r),this.properties=Object.assign({},{trafficcontrolrule:null,trafficcontrolpercent:null,trafficcontrolisactive:!1,trafficcontrolprefix:"v1"},e||{}),this.sampling=t,this.trafficcontrolpercent=this.properties.trafficcontrolpercent,this.trafficcontrolrule=this.properties.trafficcontrolrule,this.trafficcontrolisactive=this.properties.trafficcontrolisactive,this.trafficcontrolprefix=this.properties.trafficcontrolprefix},testType(){return this.trafficcontrolpercent?"percent":this.trafficcontrolrule?"rule":null},percentPasses(){var e=!1;if(null!==this.trafficcontrolpercent){var t=this.sampling.getTrafficControlNumber();this.logger&&this.logger.info("Traffic Control Number set on: "+t),t<=this.trafficcontrolpercent&&(e=!0)}return e},rulePasses(){var result=!1;if(null!==this.trafficcontrolrule)try{var evalResult=eval(this.trafficcontrolrule);result=!!evalResult}catch(e){console.error(e)}return result},isExecutionGranted:function(){var e=!0,t=this;this.trafficcontrolisactive&&(e=function(e){var r={percent:function(){return t.percentPasses()},rule:function(){return t.rulePasses()},default:function(){return!0}};return(r[e]||r.default)()}(this.testType()));return e}},_MetricalSampling={init:function(e,t){this.properties=Object.assign({},{groupnumberprefix:"default"},e||{}),this.da=t,this.groupnumberprefix=this.properties.groupnumberprefix,this.da.setNamespace(this.groupnumberprefix),this._getSampleRecord(),null===this.sampleRecord.group_number&&this.setGroupNumber(),null===this.sampleRecord.traffic_control_number&&this.setTrafficControlNumber()},_getSampleRecord:function(){this.sampleRecord=this.da.getSampleRecord()},_setSampleRecord:function(){return this.da.saveSampleRecord(this.sampleRecord)},_makeRandomNumber:function(){return Math.floor(100*Math.random()+1)},setGroupNumber:function(e){return this.sampleRecord.group_number=void 0!==e?e:this._makeRandomNumber(),this._setSampleRecord()},getGroupNumber:function(){return this.sampleRecord.group_number},getTrafficControlNumber:function(){return this.sampleRecord.traffic_control_number},setTrafficControlNumber:function(e){return this.sampleRecord.traffic_control_number=void 0!==e?e:this._makeRandomNumber(),this._setSampleRecord()},randomSessionNumber:function(){var e=this.da.getRandomSample();return null===e&&(e=this._makeRandomNumber(),this.da.setRandomSample(e)),e}},_MetricalSamplingDataAccess={init:function(e,t){this.defaultConfig={namespace:"default",useCookieOverLocal:!1},this.config=Object.assign({},this.defaultConfig,e||{}),this.namespace=this.config.namespace||"default",this.ac=t,this.groupNumberKey="sampleRecord",this.randomSampleKey="randomSample",this.config.useCookieOverLocal?this.storageObject=_MetricalStorage.Cookie:this.storageObject=_MetricalStorage.Storage},setNamespace:function(e){this.namespace=e},getSampleRecord:function(){var e=this.namespace+"_"+this.groupNumberKey,t=this.storageObject.getItem(e);if(null===t){var r={group_number:null,traffic_control_number:null};return this.saveSampleRecord(r),r}return t},saveSampleRecord:function(e){var t=this.namespace+"_"+this.groupNumberKey;this.storageObject.setItem(t,e);return!0},getRandomSample:function(){var e=this.namespace+"_"+this.randomSampleKey;return _MetricalStorage.SessionStorage.getItem(e)},setRandomSample:function(e){var t=this.namespace+"_"+this.randomSampleKey;return _MetricalStorage.SessionStorage.setItem(t,e),!0}},_MetricalCoupon=function(e){var t={couponConfig:{},browser:new _MetricalBrowser,logger:new _MetricalLogger({extra:{module:"coupon"}})};if(this.properties=Object.assign({},t,e||{}),this.browser=this.properties.browser,this.logger=this.properties.logger,0==!!this.properties.couponConfig.coupondriver)throw this.logger.error("couponConfig requires a coupondriver property",{couponConfig:this.properties.couponConfig}),new Error("couponConfig requires a coupondriver property");this.properties.couponConfig.forceredirect=!!this.properties.couponConfig.forceredirect},_MetricalCoupon.prototype.driver=function(e,t){var r=e||this.properties.couponConfig.coupondriver;this.logger.debug("selected coupon driver",{couponDriver:r});var i=Object.assign({},{browser:this.browser,logger:this.logger},this.properties.couponConfig,t||{},{metricalCoupon:this});switch(this.logger.debug("properties for coupon driver",{properties:i}),r){case"Actions":case"ActionsDriver":return new _MetricalCouponDriverActions(i);case"Applier":case"ApplierDriver":return new _MetricalCouponDriverApplier(i);case"CallBridge":case"CallBridgeDriver":return new _MetricalCouponDriverCallBridge(i);case"Eval":case"EvalDriver":return new _MetricalCouponDriverEval(i);case"Fetch":case"FetchDriver":return new _MetricalCouponDriverFetch(i);case"JcpCoupon":case"JcpCouponDriver":return new _MetricalCouponDriverJcp(i);case"Redirect":case"RedirectDriver":return new _MetricalCouponDriverRedirect(i);case"ShopifyRecharge":case"ShopifyRechargeDriver":return new _MetricalCouponDriverShopifyRecharge(i);case"ApplyCoupon":case"ApplyCouponDriver":return new _MetricalCouponDriverApplyCoupon(i);default:throw new Error("Could not find a matching driver case for "+r)}},_MetricalCouponDataAccess={init:function(e){var t={mbCou:mBrowser,endpoint:_MetricalHosts.endpoints.singleUseCoupon};this.properties=Object.assign({},t,e),this.mbCou=this.properties.mb,this.cKey="c"},getC:function(){var e=_MetricalAbandonCart.storage.getItem(this.cKey);return e?atob(decodeURIComponent(e)):null},setC:function(e){var t=encodeURIComponent(btoa(e));_MetricalAbandonCart.storage.setItem(this.cKey,t,{expiresAfter:1800})},removeC:function(){_MetricalAbandonCart.storage.removeItem(this.cKey)},fetchSingleUseCouponCode:function(e,t,r,i,o,n){var a={surveyId:e,couponId:t,uuid:r,sessionId:i};console.log(this.mbCou),this.mbCou.post(this.properties.endpoint,{body:a}).then(function(e){o(e)}).catch(function(e){console.log(e),n&&n(e)})}},_MetricalAppliers={init:function(e){const t={logger:new _MetricalLogger({extra:{module:"appliers"}}),storage:null,skipFilterCheck:!1};if(this.properties=Object.assign({},t,e),this.mbApp=this.properties.mb,this.logger=this.properties.logger,this.storage=this.properties.storage,0==!!this.mbApp)throw new Error("Metrical Browser needs to be defined for appliers");if(0==!!this.storage)throw new Error("_MetricalApplier expects a storage parameter");var r=this.storage.getItem("payload");if(r){var i=JSON.parse(atob(decodeURIComponent(r)));this.logger.debug("applier payload data in init",{data:i}),i.applier in this?(this[i.applier](i),this.logger.debug("after applier bind call")):this.logger.error("can't find applier function")}},test:function(e){"filter"in e&&-1!==window.location.href.indexOf(e.filter)&&console.log("filter matched, doing work")},hp:function(e){"filter"in e&&-1!==window.location.href.indexOf(e.filter)&&_MetricalUtils.waitForIdToAppear("promoGift",function(){let t=document.getElementById("promoGift"),r=t.value;t.value=e.code;let i=new Event("input",{bubbles:!0}),o=t._valueTracker;o&&o.setValue(r),t.dispatchEvent(i);const n=this.mbApp.getElement('input[name="eventName.updateGiftCertDataEvent"]');this.mbApp.eventFire(n,"click")})},bbbv3:function(e){var t=this;if(t.logger.traceStart("bbbv3"),t.logger.debug("input params",e),!("confirmation_id"in e))return t.logger.error("confirmation_id needs to be provided in the applier payload",e),null;if(1==t.properties.skipFilterCheck||"urlfilter"in e&&-1!==window.location.href.indexOf(e.urlfilter)){t.logger.debug("filter check passed");var r=!(!e.singleuse||!e.singleuse);t.logger.debug("singleUse",{singleUse:r});var i={},o=function(r){t.logger.traceStart("popup"),t.logger.debug("textReplacements",r);var i=_MetricalAbandonCart.Config.offers.reduce(function(t,r){return r.id==e.confirmation_id?r:t},null);if(null===i)throw t.logger.error("Unable to find "+e.confirmation_id),new Error("Unable to find "+e.confirmation_id);var o=new _MetricalOfferViewV3({view:i.viewconfig,config:_MetricalAbandonCart.Config,textReplacements:r});o.subscribe("click/submit",function(n){t.logger.debug("click/submit was called"),t.logger.debug("offerView.data",{data:o.data}),console.log(n);n.target.innerHTML='<div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>';var a={data:o.data.form||{},coupon:r,type:"bounceback",params:e,engagement:i,surveyId:_MetricalAbandonCart.Config.surveyid,uuid:_MetricalIdentity.getDeviceId(),sessionId:_MetricalIdentity.getSessionId()};t.mbApp.post(_MetricalHosts.endpoints.message,{body:a}).then(function(e){t.logger.debug("message post response",{data:e}),o.navigate("thankyou"),t.storage.removeItem("payload")}).catch(function(e){t.logger.error("message post error",{error:e}),o.navigate("error"),t.storage.removeItem("payload")}),_MetricalOfferFlow.addTag({bounceBackPhone:!0})}),o.subscribe("click/close",function(){t.logger.debug("click/close was called"),t.storage.removeItem("payload")}),o.subscribe("click/print",function(){t.logger.debug("click/print was called"),window.print(),t.storage.removeItem("payload"),_MetricalOfferFlow.addTag({bounceBackPrint:!0})}),t.logger.debug("offerView is rendering index"),o.render("index"),_MetricalStorage.Storage.setItem("bb_view",{id:e.confirmation_id,ts:(new Date).toISOString()}),_MetricalOfferFlow.addTag({bounceBackCoupon:r.COUPON,bounceBackSerial:r.SERIAL}),t.logger.traceEnd("popup")};r?_MetricalCouponDataAccess.fetchSingleUseCouponCode(_MetricalAbandonCart.Config.surveyid,e.couponcode,_MetricalIdentity.getDeviceId(),_MetricalIdentity.getSessionId(),function(t){i.COUPON=e.couponcode,i.SERIAL=t.coupon,o(i)}):(i.COUPON=e.couponcode,o(i))}else t.logger.debug("filter check failed");t.logger.traceEnd("bbbv3")},jcpbbb:function(e){var t=this;if(!("confirmation_id"in e))return console.log("confirmation_id needs to be provided"),null;"filter"in e&&-1!==window.location.href.indexOf(e.filter)?_MetricalCouponDataAccess.fetchSingleUseCouponCode(_MetricalAbandonCart.Config.surveyid,e.couponcode,_MetricalIdentity.getDeviceId(),_MetricalIdentity.getSessionId(),function(r){var i=_MetricalAbandonCart.Config.offers.reduce(function(t,r){return r.id==e.confirmation_id?r:t},null);if(null===i)throw new Error("Unable to find "+e.confirmation_id);i.couponconfig.textblocks[0].tagreplacements.COUPON=e.couponcode,i.couponconfig.textblocks[0].tagreplacements.SERIAL=r.coupon,_MetricalOfferView.init(_MetricalAbandonCart.Config.staticendpointhost,i,function(){},function(e){},function(e){}),_MetricalOfferView.render(),t.storage.removeItem("payload")}):console.log("filter prevented applier from running")},uso:function(e){if("filter"in e&&-1!==window.location.href.indexOf(e.filter)){this.mbApp.getElement("input.saso-use-discount-code-cart-code").value=e.code;const t=this.mbApp.getElement("button.saso-use-discount-code-cart-apply");this.mbApp.eventFire(t,"click"),this.storage.removeItem("payload")}}},_MetricalCallbacks={parseObserverConfig:function(e,t){for(var r=0;r<e.length;r++){var i=e[r];i.actions.includes(t.action)&&this[i.callback](t)}},jcp:function(e){var t=void 0;if("digitalData"in window){var r=_MetricalUtils.jsonPath(digitalData,"product[0].productInfo.productBrandName");Array.isArray(r)&&(t=r[0])}_MetricalAbandonCart.storage.setItem("lastbrand",t,{expiresAfter:1800})}},_MetricalOfferView={el:null,elTab:null,container:null,postRenderAction:null,onOfferDismissAction:null,onOfferSubmitAction:null,staticendpointhost:null,init:function(e,t,r,i,o){try{this.staticendpointhost=e,this.postRenderAction=r,this.onOfferDismissAction=i,this.onOfferSubmitAction=o;this.properties=Object.assign({},{offerimage:!0,applyonpresentation:!1,avoidviewportformobile:!1},t||{}),this.clearOfferView(),this.setCSS()}catch(e){console.log(e)}},setCSS:function(){var e=this.staticendpointhost,t=document.querySelectorAll("head link[type='text/css']");if(0==t.length?(document.querySelector("head").innerHTML+="<link rel='stylesheet' href='//"+e+"/css/reset.css' type='text/css' >",t=document.querySelectorAll("head link[type='text/css']")):t[t.length-1].insertAdjacentHTML("afterend","<link rel='stylesheet' href='//"+e+"/css/reset.css' type='text/css' >"),t[t.length-1].insertAdjacentHTML("afterend","\x3c!--[if lt IE 9]><link href='//"+e+"/css/styles-ie8.css' type='text/css' ><![endif]--\x3e"),t[t.length-1].insertAdjacentHTML("afterend","\x3c!--[if gte IE 9]><link href='//"+e+"/css/styles-noie8.css' type='text/css' ><![endif]--\x3e"),t[t.length-1].insertAdjacentHTML("afterend","\x3c!--[if !IE]> --\x3e<link href='//"+e+"/css/styles-noie8.css' type='text/css' ><![endif]--\x3e"),void 0!==this.properties.css)if(Array.isArray(this.properties.css))for(let e=0;e<this.properties.css.length;e++){const t=this.properties.css[e];document.querySelectorAll("head link[rel='stylesheet']")[document.querySelectorAll("head link[rel='stylesheet']").length-1].insertAdjacentHTML("afterend","<link rel='stylesheet' href='"+t+"' type='text/css' >")}else document.querySelectorAll("head link[rel='stylesheet']")[document.querySelectorAll("head link[rel='stylesheet']").length-1].insertAdjacentHTML("afterend","<link rel='stylesheet' href='"+this.properties.css+"' type='text/css' >")},render:function(){var e=this;if(html="",void 0===this.properties.offerimage||void 0!==this.properties.offerimage&&1==this.properties.offerimage){this.configureDomMountPoint();var t=this.getImageOfferMarkup(),r=document.querySelector(".Metrical");t.imgObject.onload=function(){var i=document.documentElement.clientWidth,o=(document.documentElement.clientHeight-t.imgObject.height)/3,n=(i-t.imgObject.width)/2;document.querySelector("#metrical-widget-form img").setAttribute("style","z-index: 2001000; position: fixed; top: "+o+"px; left: "+n+"px;"),e.setupAdditionalInfoTextSection(o,n,t.imgObject.height,t.imgObject.width),r.innerHTML+=e.setupTextBlocks({top:o,left:n}),e.configureOfferEventHandlers(),setTimeout(function(){e.displayOffer()},100),e.setOfferPosition(),"function"==typeof e.postRenderAction&&e.postRenderAction()},r.innerHTML=t.htmlContent}},getImageOfferMarkup:function(){html="";var e=_MetricalUtils.determineDevice(),t=this.properties.couponconfig.closemap,r=void 0!==this.properties.couponconfig.submitmap?this.properties.couponconfig.submitmap:null,i=this.properties.couponconfig.imageurl;if("mobile"==e&&null!=i.mobile){i=i.mobile;var o=t.mobile.shape,n=t.mobile.coordinates;if(r)var a=r.mobile.shape,s=r.mobile.coordinates}else{i=i.desktop;o=t.desktop.shape,n=t.desktop.coordinates;if(r)a=r.desktop.shape,s=r.desktop.coordinates}var c=new Image;if(c.src=i,html+='<div style="background-color: transparent;" class="lb-wrapper">',html+='<div class="close-widget hidden"></div>',html+='<div id="form-container">',html+='<form id="metrical-widget-form" novalidate>',html+='<input id="metrical-surveyid" type = "hidden" value = "'+this.properties.survey+'" />',html+='<img usemap="#promomap" src="'+i+'">',void 0!==this.properties.couponconfig.additionalinfotextmap){var l=null!=this.properties.couponconfig.additionalinfotextmap.css?this.properties.couponconfig.additionalinfotextmap.css:"additionalTextBox",u=null!=this.properties.couponconfig.additionalinfotextmap.style?this.properties.couponconfig.additionalinfotextmap.style:"",p=this.properties.couponconfig.additionalinfotextmap;if("mobile"==e&&null!=p.mobile)var d=p.mobile.shape,f=p.mobile.coordinates;else d=p.desktop.shape,f=p.desktop.coordinates;html+='<div id="met_promo_additional_text" class="'+l+'" style="display: none; '+u+'" ><div><span class="metrical_chevron"></span></div>'+this.properties.couponconfig.additionalinfotextmap.text+"</div>"}return html+='<map name="promomap"><area shape="'+o+'" coords="'+n+'" id="close-widget" alt="Close" style="display: block; cursor: pointer;">',r&&(html+='<area id="submit-widget" shape="'+a+'" coords="'+s+'" alt="Submit" style="display: block; cursor: pointer;">'),html+=null!=d&&null!=f?'<area id="metrical-display-additional-text" shape="'+d+'" coords="'+f+'" alt="Show Additional Text" style="display: block; cursor: pointer;"></map>':"</map>",html+='<ul class="form-list">',html+='<li class="actions"><input type="submit" id="metrical-confirm-button" name ="" value="" class="enable hidden"></li>',html+="</ul>",html+="</form>",html+="</div>",html+="</div>",html+='<div id = "check-offset"><div>',{htmlContent:html,imgObject:c}},setupTextBlocks:function(e){var t="";if(this.properties.couponconfig.textblocks&&Array.isArray(this.properties.couponconfig.textblocks))for(var r=_MetricalUtils.determineDevice(),i=0;i<this.properties.couponconfig.textblocks.length;i++){var o=this.properties.couponconfig.textblocks[i],n=o.text,a=o.tagreplacements||null;if(a)for(var s in a)n=n.replace("{{"+s+"}}",a[s]);if("mobile"==r)var c=o.position.mobile.top||0,l=o.position.mobile.left||0;else c=o.position.desktop.top||0,l=o.position.desktop.left||0;var u=o.style||"";t+='<div style="'+("z-index: 2001100; position: fixed; top: "+(parseInt(e.top)+parseInt(c))+"px; left: "+(parseInt(e.left)+parseInt(l))+"px; "+u)+'">'+n+"</div>"}return t},setupAdditionalInfoTextSection:function(e,t,r,i){if(null!=this.properties.couponconfig&&null!=this.properties.couponconfig.additionalinfotextmap){var o=document.querySelector("#met_promo_additional_text");o.setAttribute("style",o.getAttribute("style")+"position: fixed; top: "+(parseInt(e)+parseInt(r))+"px; left: "+t+"px;"),-1===o.getAttribute("style").indexOf("width")&&(o.style.width=i+"px"),document.querySelector("#metrical-widget-form div>div").style.textAlign="center",document.querySelector("#metrical-widget-form div>div").style.width=i-20+"px"}},configureOfferEventHandlers:function(){var e=this,t="autocloseafterxseconds"in this.properties?this.properties.autocloseafterxseconds:void 0,r="autosubmitafterxseconds"in this.properties?this.properties.autosubmitafterxseconds:void 0;setTimeout(function(){var i=void 0,o=void 0;t&&(i=setTimeout(function(){e.clickOn(document.querySelector(".MetricalContainer #close-widget"))},1e3*t));r&&(o=setTimeout(function(){e.clickOn(document.querySelector(".MetricalContainer #submit-widget"))},1e3*r));null!=document.querySelector(".MetricalTab a.mobile-link")&&(document.querySelector(".MetricalTab a.mobile-link").onclick=function(t){"function"==typeof e.onOfferDismissAction&&e.onOfferDismissAction(t),void 0!==i&&clearTimeout(i)});for(var n=document.querySelectorAll(".MetricalTab.elTab-left, .MetricalTab.elTab-right, .MetricalTab.elTab-top"),a=0;a<n.length;a++)n[a].addEventListener("click",function(t){document.querySelector(this).parentNode.classList.contains("is-popped")&&void 0!==t.originalEvent&&("function"==typeof e.onOfferDismissAction&&e.onOfferDismissAction(t),void 0!==i&&clearTimeout(i))});null!=document.querySelector(".MetricalContainer #close-widget")&&(document.querySelector(".MetricalContainer #close-widget").onclick=function(t){document.querySelector(".MetricalTab").style.visibility="hidden",e.clickOn(document.querySelector(".close-widget")),document.querySelector("#metrical-widget-form img")&&(document.querySelector("#metrical-widget-form img").style.display="none"),document.querySelector("#metrical-widget-form div")&&(document.querySelector("#metrical-widget-form div").style.display="none"),"function"==typeof e.onOfferDismissAction&&e.onOfferDismissAction(t),void 0!==i&&clearTimeout(i),e.hideOffer()}),null!=document.querySelector(".MetricalContainer #submit-widget")&&(document.querySelector(".MetricalContainer #submit-widget").onclick=function(t){e.clickOn(document.querySelector("#metrical-confirm-button")),document.querySelector("#metrical-widget-form div")&&(document.querySelector("#metrical-widget-form div").style.display="none"),"function"==typeof e.onOfferSubmitAction&&e.onOfferSubmitAction(t),void 0!==o&&clearTimeout(o),e.hideOffer()}),null!=document.querySelector("#metrical-confirm-button")&&(document.querySelector("#metrical-confirm-button").onclick=function(e){e.stopImmediatePropagation(),e.preventDefault()}),null!=e.properties.couponconfig&&null!=e.properties.couponconfig.additionalinfotextmap&&(document.querySelector("#metrical-display-additional-text").onclick=function(){document.querySelector("#metrical-widget-form div").style.display="block"},document.querySelector("#met_promo_additional_text .metrical_chevron").onclick=function(){document.querySelector("#metrical-widget-form div").style.display="none"})},500)},configureDomMountPoint:function(){var e;document.querySelector("body").innerHTML+='<div class="Metrical_lightbox"><div class="Metrical_lightbox_center"><div class="Metrical_lightbox_content"></div></div></div>',(e=document.createElement("div")).classList.add("MetricalContainer"),e.style.visibility="hidden",document.querySelector("body").innerHTML+=e.outerHTML,this.container=e,(e=document.createElement("div")).classList.add("Metrical"),this.el=e,(e=document.createElement("div")).classList.add("MetricalTab"),e.classList.add("hidden"),this.elTab=e,document.querySelector(".MetricalContainer").appendChild(this.el),document.querySelector(".MetricalContainer").appendChild(this.elTab),"mobile"==_MetricalUtils.determineDevice()&&(this.properties.avoidviewportformobile||(document.querySelector("body").innerHTML+='<meta name="viewport" content="width=device-width, initial-scale=1">'))},setOfferPosition:function(){document.querySelector(".Metrical_lightbox_center").classList.remove("MetricalContainer");var e=window.innerHeight,t=document.querySelector(".MetricalContainer")?document.querySelector(".MetricalContainer").offsetTop:null,r=document.querySelector("#check-offset")?document.querySelector("#check-offset").offsetTop:null,i=null!=document.querySelector(".container-bottom");if("mobile"==_MetricalUtils.determineDevice())return document.querySelector("div.MetricalContainer").classList.contains("position-fixed")&&(document.querySelector(".MetricalContainer").style.height=window.innerHeight+"px"),document.querySelector(".Metrical_lightbox_center").classList.add("MetricalContainer"),document.querySelector(".Metrical_lightbox_center").classList.add("mobile"),1==_MetricalUtils.identifierIsIOS()&&document.querySelector(".Metrical_lightbox_center").classList.add("ios"),void document.querySelector(".Metrical_lightbox_center").classList.add("display-widget-page");r>e||i&&t<0?(document.querySelector("div.MetricalContainer").classList.contains("position-fixed")&&(document.querySelector("div.MetricalContainer").classList.remove("position-fixed"),document.querySelector("div.MetricalContainer").classList.add("position-absolute")),i&&t<0&&(document.querySelector("div.MetricalContainer").classList.remove("container-bottom"),document.querySelector("div.MetricalContainer").classList.add("container-top"))):document.querySelector("div.MetricalContainer").classList.contains("position-absolute")&&(document.querySelector("div.MetricalContainer").classList.remove("position-absolute"),document.querySelector("div.MetricalContainer").classList.add("position-fixed")),document.querySelector(".Metrical_lightbox_center").classList.add("MetricalContainer")},displayOffer:function(){var e=this,t=document.querySelector(".Metrical");document.querySelector(".MetricalTab").style.display="none",document.querySelector(".Metrical_lightbox_content").outerHTML=t.outerHTML,this.fadeIn(document.querySelector(".Metrical_lightbox")),document.querySelector(".Metrical_lightbox").style.display="block",document.querySelector("body").style.overflowY="hidden",document.querySelector(".close-widget").style.display="block","mobile"==_MetricalUtils.determineDevice()&&(document.querySelector("html, body").classList.add("ios-fix"),null!=document.querySelector("textarea")&&(document.querySelector("textarea").onblur=function(t){e.fixFocusLightboxMobile()}))},hideOffer:function(){document.querySelector(".MetricalTab").classList.contains("hidden")&&document.querySelector(".MetricalTab").classList.remove("hidden"),document.querySelector(".MetricalContainer").appendChild(document.querySelector(".Metrical_lightbox_center .Metrical")),document.querySelector(".Metrical_lightbox_center .Metrical").outerHTML='<div class="Metrical_lightbox_content">',this.fadeOut(document.querySelector(".Metrical_lightbox")),this.fadeIn(document.querySelector(".MetricalTab")),document.querySelector(".Metrical_lightbox").style.display="none",document.querySelector("body").style.overflowY="","mobile"==_MetricalUtils.determineDevice()&&document.querySelector("html, body").classList.remove("ios-fix")},clearOfferView:function(){var e=document.querySelector(".Metrical_lightbox"),t=document.querySelector(".MetricalContainer");null!=e&&null!=e.parentNode&&e.parentNode.removeChild(e),null!=t&&null!=t.parentNode&&t.parentNode.removeChild(t)},fixFocusLightboxMobile:function(){var e=this;setTimeout(function(){container=document.querySelector(".Metrical_lightbox"),oRect=document.querySelector(":focus").getBoundingClientRect(),o={top:oRect.top+document.body.scrollTop,left:oRect.left+document.body.scrollLeft},null!=o&&(cORect=container.getBoundingClientRect(),cO={top:cORect.top+document.body.scrollTop,left:cORect.left+document.body.scrollLeft},e.scrollTo(container,0,1e3)),e.clickOn(document.querySelector(":focus"))},.01)},clickOn:function(e){var t=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(t)},fadeIn:function(e){e.style.opacity=0;var t=+new Date,r=function(){e.style.opacity=+e.style.opacity+(new Date-t)/400,t=+new Date,+e.style.opacity<1&&(window.requestAnimationFrame&&requestAnimationFrame(r)||setTimeout(r,16))};r()},fadeOut:function(e){var t=setInterval(function(){e.style.opacity||(e.style.opacity=1),e.style.opacity>0?e.style.opacity-=.1:clearInterval(t)},50)},scrollTo:function(e,t,r){var i=e.scrollTop,o=t-i,n=0,a=function(){var t,s,c,l=(t=n+=20,s=i,c=o,(t/=r/2)<1?c/2*t*t+s:-c/2*(--t*(t-2)-1)+s);e.scrollTop=l,n<r&&setTimeout(a,20)};a()},slideUp:function(e,t){height=e.offsetHeight,counter=height;var r=height/10;!function(e){e.style.cssText="transition: height 500ms; -webkit-transition: height 500ms; -moz-transition: height 500ms; -o-transition: height 500ms"}(e),ease.disabled=1,e.style.overflow="hidden",interval=setInterval(function(){counter-=r,counter>0?e.style.height=counter+"px":(e.style.height=0,t.disabled=0,t.innerHTML="slideDown",clearInterval(interval))},duration)},slideDown:function(e,t){var r=height/10;interval=setInterval(function(){counter+=r,counter<height?e.style.height=counter+"px":(e.style.height=height+"px",t.disabled=0,t.innerHTML="slideUp",ease.disabled=0,clearInterval(interval))},duration)}},_MetricalOfferViewV2=function(e){if(0==!!e.config)throw new Error("OfferViewV2 requires a config parameter");if(0==!!e.view)throw new Error("OfferViewV2 requires a view parameter");var t=Object.create(new _MetricalUtils.PubSub);return t.defaultParams={staticEndpointHost:e.config.staticendpointhost,config:null,view:null,cssRelativePath:"/css/styles.lightbox.view.css"},t.params=Object.assign({},t.defaultParams,e||{}),t.viewConfig=function(){if("couponconfig"in this.params.view)return this.params.view.couponconfig;if("viewconfig"in this.params.view)return this.params.view.viewconfig;throw new Error("Either couponconfig or viewconfig needs to be specified in the current view to be shown")},t.viewPropertyValue=function(e,t){t=t||this.viewConfig();var r=_MetricalUtils.determineDevice();if(e in t){var i=Object.assign({},t[e]);return delete i.desktop,delete i.mobile,delete i.tablet,r in t[e]||(r="desktop"),r in t[e]&&(i="object"==typeof t[e][r]?Object.assign(i,t[e][r]):t[e][r]),i}return null},t.attachStylesheet=function(){var e="//"+this.params.staticEndpointHost+this.params.cssRelativePath,t=document.querySelector("head"),r=document.createElement("link");if(r.rel="stylesheet",r.href=e,r.type="text/css",t.appendChild(r),this.params.view.css){var i=this.params.view.css,o=document.createElement("link");o.rel="stylesheet",o.href=i,o.type="text/css",t.appendChild(o)}},t.isStylesheetLoaded=function(){var e=this.params.config.assets||[],t=this.params.cssRelativePath;return e.reduce(function(e,r){return!1===e&&r.url.includes(t)&&(e=!0),e},!1)},t.clearLightBox=function(){var e=document.querySelector(".Metrical_LightBox");e&&e.remove()},t.render=function(){var e=this;e.publish("render/pre");var t=document.createElement("div");t.classList.add("Metrical_LightBox");var r=document.createElement("div");r.classList.add("Metrical_LightBoxContent"),r.appendChild(e._makeImgEl());var i=e.viewPropertyValue("closemap");if(i&&"shape"in i&&"coordinates"in i){var o=e._makeDivOverlayEl(i);o.addEventListener("click",function(t){t.stopPropagation(),e.close()}),r.appendChild(o)}var n,a=e.viewPropertyValue("submitmap");if(a&&"shape"in a&&"coordinates"in a){var s=e._makeDivOverlayEl(a);s.addEventListener("click",function(t){t.stopPropagation(),e.submit()}),r.appendChild(s)}if((n=this.viewPropertyValue("additionalinfotextmap"))&&"shape"in n&&"coordinates"in n){var c=e._makeDivOverlayEl(n);c.addEventListener("click",function(t){t.stopPropagation(),e.additionalInfoSlideOut()}),r.appendChild(c)}(n=this.viewPropertyValue("additionalinfotextmap"))&&r.appendChild(e._makeAdditionalInfoEl()),(e.viewConfig().textblocks||[]).forEach(function(t){r.appendChild(e._makeTextBlockEl(t))}),t.appendChild(r),document.querySelector("body").appendChild(t),e.publish("render/post")},t._makeTextBlockEl=function(e){var t=document.createElement("div");t.classList.add("MetricalTextLayer");var r,i=e.class||"";(r=i,Array.isArray(r)?r:"string"==typeof r&&r.length>0?r.split(" "):[]).forEach(function(e){t.classList.add(e)});var o=(e.style||"").split(";").filter(function(e){return e.length>0}).map(function(e){return e.trim()+";"}),n=this.viewPropertyValue("position",e);for(var a in n){var s=a+": "+n[a]+"px;";o.push(s)}t.style=o.join(" ");var c=e.tagreplacements||null,l=e.text||"";if(c)for(var u in c){var p=new RegExp("{{"+u+"}}","g");l=l.replace(p,c[u])}return t.innerHTML=l,t},t._makeAdditionalInfoEl=function(){var e=this,t=this.viewPropertyValue("additionalinfotextmap");return infoEl=document.createElement("div"),infoEl.classList.add("Metrical_AdditionalInfo"),"style"in t&&(infoEl.style=t.style),chevronSpanEl=document.createElement("span"),chevronSpanEl.classList.add("Metrical_Chevron"),chevronSpanEl.addEventListener("click",function(t){e.additionalInfoSlideIn()}),chevronEl=document.createElement("div"),chevronEl.appendChild(chevronSpanEl),textEl=document.createElement("span"),textEl.innerHTML=t.text||"",infoEl.appendChild(chevronEl),infoEl.appendChild(textEl),infoEl},t.additionalInfoSlideOut=function(){var e=document.querySelector(".Metrical_LightBox .Metrical_AdditionalInfo");e&&(e.classList.remove("MetricalSlideIn"),e.classList.add("MetricalSlideOut"))},t.additionalInfoSlideIn=function(){var e=document.querySelector(".Metrical_LightBox .Metrical_AdditionalInfo");e&&(e.classList.remove("MetricalSlideOut"),e.classList.add("MetricalSlideIn"))},t._makeImgEl=function(){var e=this.viewPropertyValue("imageurl"),t=document.createElement("img");return t.setAttribute("usemap","#MetricalOfferMap"),t.setAttribute("src",e),t},t._makeDivOverlayEl=function(e){var t=document.createElement("div"),r=e.coordinates,i=r.split(",");if(4!=i.length)throw new Error("An invalid set of coordinates was passed to the makeDivOverlayEl function: "+r);var o=i[2]-i[0],n=i[3]-i[1],a=i[1],s=i[0];return t.style="position: absolute; width: "+o+"px; height: "+n+"px; top: "+a+"px; left: "+s+"px; display: block; cursor: pointer; user-select: none",t},t._makeMapEl=function(){var e=this,t=document.createElement("map");t.setAttribute("name","MetricalOfferMap");var r=e.viewPropertyValue("closemap");if(r&&"shape"in r&&"coordinates"in r){var i=document.createElement("area");i.setAttribute("id","MetricalCloseArea"),i.setAttribute("shape",r.shape),i.setAttribute("coords",r.coordinates),i.setAttribute("alt","Close"),i.setAttribute("style","display: block; cursor: pointer;"),i.addEventListener("click",function(t){t.stopPropagation(),e.close()}),t.appendChild(i)}var o=e.viewPropertyValue("submitmap");if(o&&"shape"in o&&"coordinates"in o){var n=document.createElement("area");n.setAttribute("id","MetricalSubmitArea"),n.setAttribute("shape",o.shape),n.setAttribute("coords",o.coordinates),n.setAttribute("alt","Submit"),n.setAttribute("style","display: block; cursor: pointer;"),n.addEventListener("click",function(t){t.stopPropagation(),e.submit()}),t.appendChild(n)}var a=this.viewPropertyValue("additionalinfotextmap");if(a&&"shape"in a&&"coordinates"in a){var s=document.createElement("area");s.setAttribute("id","MetricalInfoArea"),s.setAttribute("shape",a.shape),s.setAttribute("coords",a.coordinates),s.setAttribute("alt","Info"),s.setAttribute("style","display: block; cursor: pointer;"),s.addEventListener("click",function(t){t.stopPropagation(),e.additionalInfoSlideOut()}),t.appendChild(s)}return t},t.close=function(){this.publish("close/pre"),this.clearLightBox(),this.publish("close/post")},t.submit=function(){this.publish("submit/pre"),this.clearLightBox(),this.publish("submit/post")},t.attachStylesheet(),t.clearLightBox(),t},_MetricalOfferViewV3=function(e){var t=Object.create(new _MetricalUtils.PubSub);if(t.defaultProperties={config:null,view:null,defaultStyles:[".Metrical_LightBox { position: fixed; z-index: 999; width: 100%; height: 100%; text-align: center; top: 0; left: 0; background: rgba(0, 0, 0, 0.8); overflow: auto; padding-top: 2%; } ",".Metrical_LightBox .Metrical_LightBoxContent { position: relative; margin: auto; padding: 0; }",".Metrical_LightBox .Metrical_LightBoxClose, .Metrical_additionalinfo_toggle { position: absolute; margin: 0px; padding: 0px; cursor: pointer; }",".Metrical-lds-ellipsis { display: inline-block; position: relative; width: 40px; height: 16px; }",".Metrical-lds-ellipsis div { position: absolute; top: 6px; width: 7px; height: 7px; border-radius: 50%; background: #fff; animation-timing-function: cubic-bezier(0, 1, 1, 0); }",".Metrical-lds-ellipsis div:nth-child(1) { left: 4px; animation: Metrical-lds-ellipsis1 0.6s infinite; }",".Metrical-lds-ellipsis div:nth-child(2) { left: 4px; animation: Metrical-lds-ellipsis2 0.6s infinite; }",".Metrical-lds-ellipsis div:nth-child(3) { left: 16px; animation: Metrical-lds-ellipsis2 0.6s infinite; }",".Metrical-lds-ellipsis div:nth-child(4) { left: 28px; animation: Metrical-lds-ellipsis3 0.6s infinite; }","@keyframes Metrical-lds-ellipsis1 { 0% { transform: scale(0); } 100% { transform: scale(1); } } @keyframes Metrical-lds-ellipsis3 { 0% { transform: scale(1); } 100% { transform: scale(0); } } @keyframes Metrical-lds-ellipsis2 { 0% { transform: translate(0, 0); } 100% { transform: translate(12px, 0); } }"],document:(new _MetricalBrowser).document(),textReplacements:{},currentViewKey:void 0,useCloseOverlay:!0,ellipsisHtml:'<div class="Metrical-lds-ellipsis"><div></div><div></div><div></div><div></div></div>'},t.properties=Object.assign({},t.defaultProperties,e||{}),t.document=t.properties.document,t.formData={},t.data={},t.assetsLoaded=!1,0==!!t.properties.config)throw new Error("OfferViewV3 requires a config parameter");if(0==!!t.properties.view)throw new Error("OfferViewV3 requires a view parameter");if(0==!!t.properties.view.views)throw new Error("OfferViewV3 requires a views parameter in the view property");return t.viewKeys=Object.keys(t.properties.view.views),t.viewKeys.forEach(function(e){t.data[e]={}}),t.additionalInfoShouldOpen=!1,t.loadAssets=function(){var e=this;return new Promise(function(r,i){var o="assets"in t.properties.view;e.assetsLoaded||0==o?(e.assetsLoaded=!0,r(!0)):(console.log(t.properties.view.assets),(new _MetricalAssets).load(t.properties.view.assets).then(function(t){e.assetsLoaded=!0,r(!0)}).catch(function(e){i(e)}))})},t.render=function(e){var t=this;if(0==this.viewKeys.includes(e))throw new Error("View "+e+" is not a valid view for this engagement");this.loadAssets().then(function(){t.publish("render/pre");var r=t.document.createElement("div");t.properties.lightBoxEl=r,r.classList.add("Metrical_LightBox");var i=t.document.createElement("div");r.appendChild(i),i.classList.add("Metrical_LightBoxContent"),t.properties.contentEl=i,t.attachStyles("container",t.containerStyles()),t.navigate(e),t.document.querySelector("body").appendChild(r),t.attachEvents(),t.publish("render/post")}).catch(function(e){throw e})},t.renderAdditionalInfo=function(){var e=this;e.additionalInfoShouldOpen=!1;var t=e.properties.view.additionalinfo||null;if(null!==t){var r=t.text||"",i=e.document.createElement("div");i.classList.add("Metrical_additionalinfo_container");var o=e.document.createElement("span");o.classList.add("Metrical_additionalinfo_text"),o.innerHTML=r,i.appendChild(o),this.properties.contentEl.appendChild(i);var n=e.document.createElement("div");n.id=this.makeId("additionalinfo_toggle"),n.classList.add("Metrical_additionalinfo_toggle"),this.properties.contentEl.appendChild(n),n.addEventListener("click",function(t){e.additionalInfoShouldOpen=!e.additionalInfoShouldOpen,1==e.additionalInfoShouldOpen?(i.classList.remove("Metrical_additionalinfo_slidein"),i.classList.add("Metrical_additionalinfo_slideout")):(i.classList.remove("Metrical_additionalinfo_slideout"),i.classList.add("Metrical_additionalinfo_slidein"))})}},t.renderCloseOverlay=function(){var e=this.document.createElement("div");e.id=this.makeId("view_close"),e.classList.add("Metrical_LightBoxClose"),this.properties.contentEl.appendChild(e),e.addEventListener("click",this.close.bind(this))},t.clearLightBox=function(){var e=this.properties.lightBoxEl;e&&e.remove()},t.navigate=function(e){var t=this;if(0==this.viewKeys.includes(e))throw new Error("View "+e+" is not a valid view for this engagement");this.loadAssets().then(function(){t.publish("navigate/pre");var r=t.properties.view.views[e],i=t.properties.currentViewKey;t.removeEvents(i),t.properties.contentEl.innerHTML="","style"in r&&r.style.length>0&&t.attachStyles(e,r.style);var o=t.document.createElement("div");o.classList.add(t.makeId("view")),o.classList.add(t.makeId("view_"+e));var n=(Array.isArray(r.html)?r.html:[r.html]).join("\n"),a=t.replaceText(n);if(o.innerHTML=a,t.properties.contentEl.appendChild(o),t.properties.currentViewKey=e,t.attachEvents(e),t.properties.useCloseOverlay&&t.renderCloseOverlay(),t.renderAdditionalInfo(),"script"in r){var s=(Array.isArray(r.script)?r.script:[r.script]).join("\n"),c=t.document.createElement("script");c.innerHTML=t.replaceText(s),t.properties.contentEl.appendChild(c)}t.publish("navigate/post")}).catch(function(e){throw e})},t.replaceText=function(e){var t=e,r=this.properties.textReplacements||{};for(var i in r){var o=new RegExp("{{"+i+"}}","g");t=t.replace(o,r[i])}return t},t.containerStyles=function(){var e=this.properties.defaultStyles,t=[],r=[];return"style"in this.properties.view&&this.properties.view.style.length>0&&(r=Array.isArray(this.properties.view.style)?this.properties.view.style:[this.properties.view.style]),"defaultstyle"in this.properties.view&&this.properties.view.defaultstyle.length>0&&(t=Array.isArray(this.properties.view.defaultstyle)?this.properties.view.defaultstyle:[this.properties.view.defaultstyle]),(t.length>0?t:e).concat(r)},t.attachStyles=function(e,t){var r=this.makeId(e+"_css");if(null===this.document.getElementById(r)){var i=this.document.createElement("style");i.id=r;var o=Array.isArray(t)?t:[t];i.appendChild(this.document.createTextNode(o.join("\n"))),this.document.getElementsByTagName("head")[0].appendChild(i)}},t.makeId=function(e){return"Metrical_"+e},t.removeEvents=function(e){var t=this;t.document.querySelectorAll(".Metrical_view form select").forEach(function(e){e.removeEventListener("change",t.controlHandleChange.bind(t))}),t.document.querySelectorAll(".Metrical_view form input").forEach(function(e){e.removeEventListener("input",t.controlHandleChange.bind(t))}),t.document.querySelectorAll(".Metrical_view form").forEach(function(e){e.removeEventListener("submit",t.formHandleSubmit.bind(t))})},t.attachEvents=function(e){var t=this;t.document.querySelectorAll(".Metrical_view form select").forEach(function(e){e.addEventListener("change",t.controlHandleChange.bind(t))}),t.document.querySelectorAll(".Metrical_view form input").forEach(function(e){e.addEventListener("input",t.controlHandleChange.bind(t))}),t.document.querySelectorAll(".Metrical_view form").forEach(function(e){e.addEventListener("submit",t.formHandleSubmit.bind(t))}),t.document.querySelectorAll(".Metrical_view *[data-nav]").forEach(function(e){e.addEventListener("click",t.elHandleNavigation.bind(t))}),t.document.querySelectorAll(".Metrical_view *[data-event]").forEach(function(e){var r=e.dataset.event,i=(e.dataset.payload,r.split("/")),o=2==i.length?i[0]:"click";console.log(o,i),e.addEventListener(o,t.elHandleEventPublish.bind(t))})},t.elHandleEventPublish=function(e){var t=function(e,r){var i=e.dataset.event;return console.log(i),i?e:e.parentElement?t(e.parentElement):null},r=t(e.target);console.log(r);var i=r.dataset.event;console.log(i),"disableOnClick"in r.dataset&&(r.disabled=!0),"loadingOnClick"in r.dataset&&(r.disabled=!0,r.innerHTML=this.properties.ellipsisHtml),this.publish(i,e)},t.elHandleNavigation=function(e){var t=e.target.dataset.nav;this.navigate(t)},t.controlHandleChange=function(e){var t=this.document.querySelectorAll(".Metrical_view form"),r={},i=[];(t.forEach(function(e,t){var o=e.id||e.name||t,n=e.checkValidity();if(i.push(n),"validationFunction"in e.dataset){var a=e.dataset.validationFunction;if("function"==typeof window[a]){var s=window[a](e);i.push(s)}}var c=new FormData(e),l={};for(var u of c.entries())l[u[0]]=u[1];r[o]=l}),this.data[this.properties.currentViewKey]=r,0==i.includes(!1))?this.document.querySelectorAll(".Metrical_view form *[data-validation-toggle]").forEach(function(e){e.disabled=!1}):this.document.querySelectorAll(".Metrical_view form *[data-validation-toggle]").forEach(function(e){e.disabled=!0})},t.formHandleSubmit=function(e){return e.preventDefault(),!1},t.close=function(){this.clearLightBox(),this.publish("click/close")},t.submit=function(){this.publish("submit/pre");var e=this.document.querySelector(".Metrical_view form"),t=new FormData(e),r={};for(var i of t.entries())r[i[0]]=i[1];this.formData=r,this.publish("submit/post")},t},_MetricalCartDA={init:function(e){this.defaultConfig={namespace:"pc",useCookieOverLocal:!1},this.config=Object.assign({},this.defaultConfig,e||{}),this.namespace=this.config.namespace||"pc",this.cartKey="cart",this.itemKey="items",this.config.useCookieOverLocal?this.storageObject=_MetricalStorage.Cookie:this.storageObject=_MetricalStorage.Storage,this.cookieObject=_MetricalStorage.Cookie},getCart:function(){var e=this.namespace+"_"+this.cartKey;return this.storageObject.getItem(e)},setCart:function(e){var t=this.namespace+"_"+this.cartKey;return this.storageObject.setItem(t,e,0)},getItems:function(){var e=this.namespace+"_"+this.itemKey;return this.storageObject.getItem(e)},setItems:function(e){var t=this.namespace+"_"+this.itemKey;return this.storageObject.setItem(t,e,0)}},_MetricalCart={loaded:!1,init:function(e){this.defaultConfig={da:null,expandItemsFunc:null,bus:null},this.config=Object.assign({},this.defaultConfig,e||{}),this.cart=[],this.loadCart(),this.items={},this.loadItems(),this.loaded=!0},loadCart:function(){var e=this.config.da.getCart();return Array.isArray(e)&&(this.cart=e),this.cart},loadItems:function(){var e=this.config.da.getItems();return this.items=e||{},this.items},syncWithUserMeta:function(e){if("usermeta"in e&&"cartidlist"in e.usermeta&&"cartskulist"in e.usermeta&&"cartqtylist"in e.usermeta&&"cartpricelist"in e.usermeta&&e.usermeta.cartidlist&&e.usermeta.cartqtylist&&e.usermeta.cartpricelist){var t=_MetricalUtils.plusDelimitedParts(e.usermeta.cartidlist),r=e.usermeta.cartskulist?_MetricalUtils.plusDelimitedParts(e.usermeta.cartskulist):null,i=_MetricalUtils.plusDelimitedParts(e.usermeta.cartqtylist),o=_MetricalUtils.plusDelimitedParts(e.usermeta.cartpricelist);this.cart=[];for(var n=0;n<t.length;n++){var a=_MetricalUtils.round(_MetricalUtils.cleanMoney(o[n]),2);this.cart.push({id:t[n],sku:null!==r?r[n]:null,qty:parseInt(i[n]),price:a})}this.config.da.setCart(this.cart)}if("usermeta"in e&&"itemid"in e.usermeta){var s=e.usermeta.itemid,c=this.items[s]&&this.items[s].viewCount?this.items[s].viewCount:0;""==e.action&&c++;var l={ts:(new Date).getTime(),cat:e.usermeta.itemcategory||null,subcat:e.usermeta.itemsubcategory||null,price:_MetricalUtils.round(_MetricalUtils.cleanMoney(e.usermeta.itemprice||null),2),viewCount:c},u="function"==typeof this.config.expandItemsFunc?this.config.expandItemsFunc():{};this.items[s]=Object.assign({},l,u)}var p=(new Date).getTime()-1728e5;for(var s in this.items)this.items[s].ts&&this.items[s].ts<p&&delete this.items[s];this.config.da.setItems(this.items)},cartItemCount:function(){return this.cart.reduce(function(e,t){return e+t.qty},0)},cartUniqueItemCount:function(){return this.cart.reduce(function(e,t){return 0==e.includes(t.id)&&e.push(t.id),e},[]).length},cartValue:function(){var e=this.cart.reduce(function(e,t){return e+t.qty*t.price},0);return _MetricalUtils.round(e,2)},cartHasItemInSubCategory:function(e){var t=this;return this.cart.map(function(e){return e.id}).reduce(function(r,i){!1===r&&t.items[i]&&(r=(t.items[i].subcat||"").includes(e));return r},!1)},validateId:function(e,t){if("string"!=typeof e&&"number"!=typeof e)throw new Error("_MetricalCart.add() expects an item id parameter that is a string or number");if("string"!=typeof t&&"number"!=typeof t&&null!=t)throw new Error("_MetricalCart.add() expects the optional sku parameter to be a string or number")},validateQtyPrice:function(e,t){if("number"!=typeof e||Math.floor(e)!=e||e<0)throw new Error("_MetricalCart.add() expects a qty parameter that is an integer that is 0 or larger");if("number"!=typeof t)throw new Error("_MetricalCart.add() expects a price parameter that is a number")},add:function(e,t,r,i,o){localSku=i||null,this.validateId(e,localSku),this.validateQtyPrice(t,r);var n=Object.assign({id:e,qty:t,price:r,sku:localSku},o||{});this.cart.push(n),this.config.da.setCart(this.cart),this.config.bus.publish(this.config.bus.constants.topics.MCART_ADD,{id:e,qty:t,price:r,sku:i})},findIndex:function(e,t){return localSku=t||null,this.validateId(e,localSku),this.cart.reduce(function(t,r,i){return null===t&&r.id==e&&r.sku==localSku&&(t=i),t},null)},update:function(e,t,r,i,o){localSku=i||null,this.validateId(e,localSku),this.validateQtyPrice(t,r);var n=this.findIndex(e,localSku);if(null!==n){var a=this.cart[n],s=Object.assign({},a,{id:e,sku:localSku,qty:t,price:r},o||{});this.config.bus.publish(this.config.bus.constants.topics.MCART_UPDATE,{id:e,qty:t,price:r,sku:localSku}),this.cart[n]=s}else this.add(e,t,r,i,o);this.config.da.setCart(this.cart)},remove:function(e,t){localSku=t||null,this.validateId(e,localSku);var r=this.findIndex(e,localSku);if(null!==r)return this.cart.splice(r,1);this.config.bus.publish(this.config.bus.constants.topics.MCART_DELETE,{id:e,sku:t}),this.config.da.setCart(this.cart)},clear:function(){this.cart=[],this.config.da.setCart(this.cart),this.config.bus.publish(this.config.bus.constants.topics.MCART_CLEAR,{})},cartidlist:function(){return _MetricalUtils.plusDelimitArray(this.cart.map(function(e){return e.id}))},cartqtylist:function(){return _MetricalUtils.plusDelimitArray(this.cart.map(function(e){return e.qty}))},cartpricelist:function(){return _MetricalUtils.plusDelimitArray(this.cart.map(function(e){return e.price}))},cartskulist:function(){return _MetricalUtils.plusDelimitArray(this.cart.map(function(e){return e.sku}))},usermetaValues:function(){var e={cartidlist:null,cartqtylist:null,cartpricelist:null,cartskulist:null,totalnumitemsincart:0,numuniqueitemsincart:0,subtotalcartvalue:0};return this.cart.length>0&&(e.cartidlist=this.cartidlist(),e.cartqtylist=this.cartqtylist(),e.cartpricelist=this.cartpricelist(),e.cartskulist=this.cartskulist(),e.totalnumitemsincart=this.cartItemCount(),e.numuniqueitemsincart=this.cartUniqueItemCount(),e.subtotalcartvalue=this.cartValue()),e}},_MetricalTopicResponse=function(e){var t={bus:null,cart:null,interactions:null,usermeta:null,logger:new _MetricalLogger({extra:{module:"topicresponse"}})};if(this.properties=Object.assign({},t,e||{}),0==!!this.properties.bus)throw new Error("_MetricalTopicResponse expects a bus parameter");if(0==!!this.properties.cart)throw new Error("_MetricalTopicResponse expects a cart parameter");if(0==!!this.properties.interactions)throw new Error("_MetricalTopicResponse expects an interactions parameter");if(0==!!this.properties.usermeta)throw new Error("_MetricalTopicResponse expects an usermeta parameter");this.logger=this.properties.logger},_MetricalTopicResponse.prototype.subscribe=function(e){var t=this;if("object"!=typeof e||null===e)throw new Error("_MetricalTopicResponse.subscribe() expects an object that isn't null");var r=Object.keys(e),i=[];return r.forEach(function(r){var o=e[r];t.properties.bus.subscribe(r,function(e,r){var i=Object.keys(o);t.logger.debug("topic payload",{topic:r,payload:e}),i.forEach(function(r){if("add_to_cart"==r){var i=o.add_to_cart,n=_MetricalUtils.evaluateObject(i),a=Object.assign({},n,e||{});t.logger.debug("add_to_cart addObj",{addObj:a});var s=a.id||null,c=a.sku||null,l=a.price||null,u=a.qty||null;delete a.id,delete a.sku,delete a.price,delete a.qty;var p=a||{};t.properties.cart.add(s,u,l,c,p)}if("remove_from_cart"==r){var d=o.remove_from_cart,f=Object.assign({},_MetricalUtils.evaluateObject(d),e||{});t.logger.debug("remove_from_cart removeObj",{removeObj:f});s=f.id||null,c=f.sku||null;t.properties.cart.remove(s,c)}if("usermeta"==r){var h=o.usermeta,g=Object.assign(_MetricalUtils.evaluateObject(h),e||{});t.properties.usermeta.add(g)}if("interaction"==r){r=o.interaction;t.properties.interactions.recordInteraction(r)}if("clear_cart"==r){var m=o.clear_cart;t.logger.debug("clear_cart",{clearCartValue:m}),m&&t.properties.cart.clear()}})}),i.push(r)}),i},_MetricalTopicPublish=function(e){var t={bus:null,logger:new _MetricalLogger({extra:{module:"topicpublish"}})};if(this.properties=Object.assign({},t,e||{}),0==!!this.properties.bus)throw new Error("_MetricalTopicPublish expects a bus parameter");this.logger=this.properties.logger},_MetricalTopicPublish.prototype.evaluatePublishRules=function(e){var t=this;if(0==Array.isArray(e))throw new Error("_MetricalTopicPublish.evaluatePublishRules() expects an array of rule objects");t.logger.debug("rules object",{inputRules:e});var r=[];return e.forEach(function(e){var i=e.rule,o=e.topic,n=_MetricalUtils.evaluateObject(i);t.logger.debug("rule evaluation result",{rule:i,result:n}),n&&(t.properties.bus.publish(o),r.push(o))}),r};